{% extends "base.html" %}

{% block title %}Shadow Web - Teams{% endblock %}
{% block page_title %}Agent Teams{% endblock %}

{% block content %}
<!-- Team Stats -->
<div class="stats-grid small">
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="total-teams">-</span>
            <span class="stat-label">Teams</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="total-agents">-</span>
            <span class="stat-label">Agents</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="active-agents">-</span>
            <span class="stat-label">Active</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="pending-tasks">-</span>
            <span class="stat-label">Pending Tasks</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="completed-tasks">-</span>
            <span class="stat-label">Completed</span>
        </div>
    </div>
</div>

<!-- Team Selector & Actions -->
<div class="page-actions">
    <select id="team-selector" class="team-selector">
        <option value="__ALL__">All Teams</option>
    </select>
    <div class="tab-toggle">
        <button class="btn btn-small active" id="agents-tab-btn" onclick="switchTab('agents')">Agents</button>
        <button class="btn btn-small" id="tasks-tab-btn" onclick="switchTab('tasks')">Tasks</button>
        <button class="btn btn-small" id="workflows-tab-btn" onclick="switchTab('workflows')">Workflows</button>
    </div>
    <button class="btn btn-primary" onclick="showCreateTeamModal()">+ New Team</button>
</div>

<!-- Agents Tab -->
<section class="section tab-content" id="agents-tab">
    <div class="section-header">
        <h2>Agent Roster</h2>
        <button class="btn btn-secondary btn-small" onclick="showAddAgentModal()">+ Add Agent</button>
    </div>
    <div class="agents-grid" id="agents-container">
        <div class="loading">Loading agents...</div>
    </div>
</section>

<!-- Tasks Tab -->
<section class="section tab-content hidden" id="tasks-tab">
    <div class="section-header">
        <h2>Task Board</h2>
        <button class="btn btn-secondary btn-small" onclick="showCreateTaskModal()">+ New Task</button>
    </div>
    <div class="tasks-columns" id="tasks-container">
        <div class="task-column">
            <div class="task-column-header">
                <span class="task-column-title">Pending</span>
                <span class="task-column-count" id="pending-count">0</span>
            </div>
            <div class="task-list" id="pending-tasks-list"></div>
        </div>
        <div class="task-column">
            <div class="task-column-header">
                <span class="task-column-title">In Progress</span>
                <span class="task-column-count" id="progress-count">0</span>
            </div>
            <div class="task-list" id="progress-tasks-list"></div>
        </div>
        <div class="task-column">
            <div class="task-column-header">
                <span class="task-column-title">Completed</span>
                <span class="task-column-count" id="completed-count">0</span>
            </div>
            <div class="task-list" id="completed-tasks-list"></div>
        </div>
    </div>
</section>

<!-- Workflows Tab -->
<section class="section tab-content hidden" id="workflows-tab">
    <div class="section-header">
        <h2>Active Workflows</h2>
        <button class="btn btn-secondary btn-small" onclick="startQAWorkflow()">Start QA Pipeline</button>
    </div>
    <div class="workflows-list" id="workflows-container">
        <div class="empty-state">No active workflows</div>
    </div>
</section>

<!-- Create Team Modal -->
<div id="create-team-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Create Team</h2>
            <button class="modal-close" onclick="closeCreateTeamModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="team-name">Team Name</label>
                <input type="text" id="team-name" class="form-input" placeholder="e.g., Frontend Team">
            </div>
            <div class="form-group">
                <label for="team-description">Description</label>
                <textarea id="team-description" class="form-textarea" placeholder="Team purpose and goals..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateTeamModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createTeam()">Create Team</button>
        </div>
    </div>
</div>

<!-- Add Agent Modal -->
<div id="add-agent-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Add Agent</h2>
            <button class="modal-close" onclick="closeAddAgentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="agent-name">Agent Name</label>
                <input type="text" id="agent-name" class="form-input" placeholder="e.g., Senior Dev">
            </div>
            <div class="form-group">
                <label for="agent-type">Agent Type</label>
                <select id="agent-type" class="form-select">
                    <option value="SENIOR_DEVELOPER">Senior Developer</option>
                    <option value="JUNIOR_DEVELOPER">Junior Developer</option>
                    <option value="CODE_REVIEWER">Code Reviewer</option>
                    <option value="DEBUGGER">Debugger</option>
                    <option value="TESTER">Tester</option>
                    <option value="DOCUMENTATION_WRITER">Documentation Writer</option>
                    <option value="PROJECT_MANAGER">Project Manager</option>
                    <option value="ARCHITECT">Architect</option>
                    <option value="SECURITY_ANALYST">Security Analyst</option>
                    <option value="DEVOPS_ENGINEER">DevOps Engineer</option>
                    <option value="UI_UX_DESIGNER">UI/UX Designer</option>
                    <option value="DATA_ANALYST">Data Analyst</option>
                    <option value="GENERAL_PURPOSE">General Purpose</option>
                </select>
            </div>
            <div class="form-group">
                <label for="agent-specializations">Specializations</label>
                <input type="text" id="agent-specializations" class="form-input" placeholder="Comma-separated: React, TypeScript, Testing">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAddAgentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="addAgent()">Add Agent</button>
        </div>
    </div>
</div>

<!-- Create Task Modal -->
<div id="create-task-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Create Task</h2>
            <button class="modal-close" onclick="closeCreateTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="task-title">Task Title</label>
                <input type="text" id="task-title" class="form-input" placeholder="e.g., Implement login feature">
            </div>
            <div class="form-group">
                <label for="task-description">Description</label>
                <textarea id="task-description" class="form-textarea" placeholder="Task details..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="task-priority">Priority</label>
                    <select id="task-priority" class="form-select">
                        <option value="LOW">Low</option>
                        <option value="MEDIUM" selected>Medium</option>
                        <option value="HIGH">High</option>
                        <option value="URGENT">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="task-agent">Assign To</label>
                    <select id="task-agent" class="form-select">
                        <option value="">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateTaskModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createTask()">Create Task</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allTeams = [];
let allAgents = [];
let allTasks = [];
let currentTab = 'agents';
let selectedTeamId = '__ALL__';

document.addEventListener('DOMContentLoaded', function() {
    loadTeams();
    loadAgents();
    loadTasks();
    loadTeamStats();
});

// ============ Data Loading ============

async function loadTeams() {
    const deviceId = getDeviceIdParam();
    allTeams = await api.getTeams(deviceId);

    const selector = document.getElementById('team-selector');
    selector.innerHTML = '<option value="__ALL__">All Teams</option>';
    allTeams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = team.name;
        selector.appendChild(option);
    });

    selector.addEventListener('change', function() {
        selectedTeamId = this.value;
        filterByTeam();
    });

    document.getElementById('total-teams').textContent = allTeams.length;
}

async function loadAgents() {
    const deviceId = getDeviceIdParam();
    allAgents = await api.getAgents(deviceId);
    renderAgents(allAgents);
    updateAgentStats();
    populateAgentSelector();
}

async function loadTasks() {
    const deviceId = getDeviceIdParam();
    allTasks = await api.getTasks(deviceId);
    renderTasks(allTasks);
    updateTaskStats();
}

async function loadTeamStats() {
    const metrics = await api.getTeamMetrics();
    document.getElementById('total-agents').textContent = metrics.total_agents || 0;
    document.getElementById('active-agents').textContent = metrics.active_agents || 0;
    document.getElementById('pending-tasks').textContent = metrics.pending_tasks || 0;
    document.getElementById('completed-tasks').textContent = metrics.completed_tasks || 0;
}

// ============ Rendering ============

function renderAgents(agents) {
    const container = document.getElementById('agents-container');

    if (agents.length === 0) {
        container.innerHTML = '<div class="empty-state">No agents configured. Add an agent to get started.</div>';
        return;
    }

    container.innerHTML = agents.map(a => `
        <div class="agent-card" data-agent-id="${a.id}">
            <div class="agent-header">
                <div class="agent-avatar">${getAgentEmoji(a.type)}</div>
                <div class="agent-info">
                    <div class="agent-name">${escapeHtml(a.name)}</div>
                    <span class="status-badge ${a.status.toLowerCase()}">${a.status}</span>
                </div>
                <div class="agent-actions">
                    <button class="btn-icon-small" onclick="toggleAgentAvailability('${a.id}')" title="Toggle availability">
                        ${a.is_available ? '<span class="material-symbols-outlined" style="color: var(--success)">check_circle</span>' : '<span class="material-symbols-outlined" style="color: var(--error)">cancel</span>'}
                    </button>
                </div>
            </div>
            <div class="agent-type-badge">${formatAgentType(a.type)}</div>
            ${a.specializations && a.specializations.length > 0 ? `
                <div class="agent-specializations">
                    ${a.specializations.map(s => `<span class="spec-tag">${escapeHtml(s)}</span>`).join('')}
                </div>
            ` : ''}
            ${a.current_task ? `
                <div class="agent-task">
                    <span class="task-label">Working on:</span>
                    <span class="task-name">${escapeHtml(a.current_task)}</span>
                </div>
            ` : ''}
            <div class="agent-stats">
                <span class="agent-stat">
                    <span class="stat-icon"><span class="material-symbols-outlined">task_alt</span></span>
                    ${a.tasks_completed || 0} completed
                </span>
                <span class="agent-stat">
                    <span class="stat-icon"><span class="material-symbols-outlined">speed</span></span>
                    ${a.workload || 0}% workload
                </span>
            </div>
        </div>
    `).join('');
}

function renderTasks(tasks) {
    const pending = tasks.filter(t => t.status === 'PENDING');
    const inProgress = tasks.filter(t => t.status === 'IN_PROGRESS');
    const completed = tasks.filter(t => t.status === 'COMPLETED');

    document.getElementById('pending-count').textContent = pending.length;
    document.getElementById('progress-count').textContent = inProgress.length;
    document.getElementById('completed-count').textContent = completed.length;

    document.getElementById('pending-tasks-list').innerHTML = pending.map(t => renderTaskCard(t)).join('') || '<div class="empty-state-small">No pending tasks</div>';
    document.getElementById('progress-tasks-list').innerHTML = inProgress.map(t => renderTaskCard(t)).join('') || '<div class="empty-state-small">No tasks in progress</div>';
    document.getElementById('completed-tasks-list').innerHTML = completed.map(t => renderTaskCard(t)).join('') || '<div class="empty-state-small">No completed tasks</div>';
}

function renderTaskCard(task) {
    const priorityClass = task.priority.toLowerCase();
    const agent = allAgents.find(a => a.id === task.assigned_agent_id);

    return `
        <div class="task-card priority-${priorityClass}" data-task-id="${task.id}">
            <div class="task-card-header">
                <span class="task-priority-badge ${priorityClass}">${task.priority}</span>
                ${task.is_overdue ? '<span class="overdue-badge">Overdue</span>' : ''}
            </div>
            <div class="task-title">${escapeHtml(task.title)}</div>
            ${task.description ? `<div class="task-description">${escapeHtml(task.description.substring(0, 100))}${task.description.length > 100 ? '...' : ''}</div>` : ''}
            <div class="task-footer">
                ${agent ? `<span class="task-assignee">${getAgentEmoji(agent.type)} ${escapeHtml(agent.name)}</span>` : '<span class="task-unassigned">Unassigned</span>'}
                <div class="task-actions">
                    ${task.status === 'PENDING' ? `<button class="btn-icon-small" onclick="updateTaskStatus('${task.id}', 'IN_PROGRESS')" title="Start"><span class="material-symbols-outlined">play_arrow</span></button>` : ''}
                    ${task.status === 'IN_PROGRESS' ? `<button class="btn-icon-small" onclick="updateTaskStatus('${task.id}', 'COMPLETED')" title="Complete"><span class="material-symbols-outlined">check</span></button>` : ''}
                </div>
            </div>
        </div>
    `;
}

// ============ Tab Switching ============

function switchTab(tab) {
    currentTab = tab;

    // Update tab buttons
    document.getElementById('agents-tab-btn').classList.toggle('active', tab === 'agents');
    document.getElementById('tasks-tab-btn').classList.toggle('active', tab === 'tasks');
    document.getElementById('workflows-tab-btn').classList.toggle('active', tab === 'workflows');

    // Update tab content
    document.getElementById('agents-tab').classList.toggle('hidden', tab !== 'agents');
    document.getElementById('tasks-tab').classList.toggle('hidden', tab !== 'tasks');
    document.getElementById('workflows-tab').classList.toggle('hidden', tab !== 'workflows');
}

// ============ Filtering ============

function filterByTeam() {
    if (selectedTeamId === '__ALL__') {
        renderAgents(allAgents);
        renderTasks(allTasks);
    } else {
        const teamAgentIds = allTeams.find(t => t.id === selectedTeamId)?.agents || [];
        const filteredAgents = allAgents.filter(a => teamAgentIds.includes(a.id));
        const filteredTasks = allTasks.filter(t => teamAgentIds.includes(t.assigned_agent_id));
        renderAgents(filteredAgents);
        renderTasks(filteredTasks);
    }
}

// ============ Stats ============

function updateAgentStats() {
    const active = allAgents.filter(a => a.status === 'BUSY').length;
    document.getElementById('total-agents').textContent = allAgents.length;
    document.getElementById('active-agents').textContent = active;
}

function updateTaskStats() {
    const pending = allTasks.filter(t => t.status === 'PENDING').length;
    const completed = allTasks.filter(t => t.status === 'COMPLETED').length;
    document.getElementById('pending-tasks').textContent = pending;
    document.getElementById('completed-tasks').textContent = completed;
}

function populateAgentSelector() {
    const selector = document.getElementById('task-agent');
    selector.innerHTML = '<option value="">Unassigned</option>';
    allAgents.forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.name;
        selector.appendChild(option);
    });
}

// ============ Helpers ============

function getAgentEmoji(type) {
    const icons = {
        'SENIOR_DEVELOPER': '<span class="material-symbols-outlined">code</span>',
        'JUNIOR_DEVELOPER': '<span class="material-symbols-outlined">code</span>',
        'CODE_REVIEWER': '<span class="material-symbols-outlined">rate_review</span>',
        'DEBUGGER': '<span class="material-symbols-outlined">bug_report</span>',
        'TESTER': '<span class="material-symbols-outlined">science</span>',
        'DOCUMENTATION_WRITER': '<span class="material-symbols-outlined">edit_document</span>',
        'PROJECT_MANAGER': '<span class="material-symbols-outlined">work</span>',
        'ARCHITECT': '<span class="material-symbols-outlined">architecture</span>',
        'SECURITY_ANALYST': '<span class="material-symbols-outlined">security</span>',
        'DEVOPS_ENGINEER': '<span class="material-symbols-outlined">settings</span>',
        'UI_UX_DESIGNER': '<span class="material-symbols-outlined">palette</span>',
        'DATA_ANALYST': '<span class="material-symbols-outlined">analytics</span>',
        'GENERAL_PURPOSE': '<span class="material-symbols-outlined">smart_toy</span>'
    };
    return icons[type] || '<span class="material-symbols-outlined">smart_toy</span>';
}

function formatAgentType(type) {
    return type.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
}

// ============ Modal Actions ============

function showCreateTeamModal() {
    document.getElementById('create-team-modal').classList.remove('hidden');
}

function closeCreateTeamModal() {
    document.getElementById('create-team-modal').classList.add('hidden');
    document.getElementById('team-name').value = '';
    document.getElementById('team-description').value = '';
}

function showAddAgentModal() {
    document.getElementById('add-agent-modal').classList.remove('hidden');
}

function closeAddAgentModal() {
    document.getElementById('add-agent-modal').classList.add('hidden');
    document.getElementById('agent-name').value = '';
    document.getElementById('agent-specializations').value = '';
}

function showCreateTaskModal() {
    document.getElementById('create-task-modal').classList.remove('hidden');
}

function closeCreateTaskModal() {
    document.getElementById('create-task-modal').classList.add('hidden');
    document.getElementById('task-title').value = '';
    document.getElementById('task-description').value = '';
}

// ============ API Actions ============

async function createTeam() {
    const name = document.getElementById('team-name').value.trim();
    const description = document.getElementById('team-description').value.trim();

    if (!name) {
        showToast('Please enter a team name', 'warning');
        return;
    }

    const result = await api.createTeam({ name, description });
    if (result.error) {
        showToast('Failed to create team: ' + result.error, 'error');
    } else {
        showToast('Team created successfully', 'success');
        closeCreateTeamModal();
        loadTeams();
    }
}

async function addAgent() {
    const name = document.getElementById('agent-name').value.trim();
    const type = document.getElementById('agent-type').value;
    const specializations = document.getElementById('agent-specializations').value.split(',').map(s => s.trim()).filter(s => s);

    if (!name) {
        showToast('Please enter an agent name', 'warning');
        return;
    }

    const result = await api.addAgent({ name, type, specializations });
    if (result.error) {
        showToast('Failed to add agent: ' + result.error, 'error');
    } else {
        showToast('Agent added successfully', 'success');
        closeAddAgentModal();
        loadAgents();
    }
}

async function createTask() {
    const title = document.getElementById('task-title').value.trim();
    const description = document.getElementById('task-description').value.trim();
    const priority = document.getElementById('task-priority').value;
    const assignedAgentId = document.getElementById('task-agent').value || null;

    if (!title) {
        showToast('Please enter a task title', 'warning');
        return;
    }

    const result = await api.createTask({ title, description, priority, assigned_agent_id: assignedAgentId });
    if (result.error) {
        showToast('Failed to create task: ' + result.error, 'error');
    } else {
        showToast('Task created successfully', 'success');
        closeCreateTaskModal();
        loadTasks();
    }
}

async function updateTaskStatus(taskId, status) {
    const result = await api.updateTask(taskId, { status });
    if (result.error) {
        showToast('Failed to update task: ' + result.error, 'error');
    } else {
        loadTasks();
        showToast('Task updated', 'success');
    }
}

async function toggleAgentAvailability(agentId) {
    const agent = allAgents.find(a => a.id === agentId);
    if (!agent) return;

    const result = await api.updateAgent(agentId, { is_available: !agent.is_available });
    if (result.error) {
        showToast('Failed to update agent: ' + result.error, 'error');
    } else {
        loadAgents();
    }
}

async function startQAWorkflow() {
    showToast('Starting QA workflow...', 'info');
    const result = await api.startWorkflow('qa_pipeline');
    if (result.error) {
        showToast('Failed to start workflow: ' + result.error, 'error');
    } else {
        showToast('QA workflow started', 'success');
        loadWorkflows();
    }
}

async function loadWorkflows() {
    const workflows = await api.getWorkflows();
    const container = document.getElementById('workflows-container');

    if (workflows.length === 0) {
        container.innerHTML = '<div class="empty-state">No active workflows. Start a QA pipeline to begin.</div>';
        return;
    }

    container.innerHTML = workflows.map(w => `
        <div class="workflow-card status-${w.status.toLowerCase()}">
            <div class="workflow-header">
                <span class="workflow-name">${escapeHtml(w.name || 'Workflow')}</span>
                <span class="status-badge ${w.status.toLowerCase()}">${w.status}</span>
            </div>
            <div class="workflow-stage">Stage: ${w.current_stage || 'Starting'}</div>
            <div class="workflow-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${w.progress || 0}%"></div>
                </div>
            </div>
        </div>
    `).join('');
}
</script>
{% endblock %}
