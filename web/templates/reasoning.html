{% extends "base.html" %}

{% block title %}Shadow Web - Reasoning Explorer{% endblock %}
{% block page_title %}Reasoning Explorer{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<style>
    .reasoning-container {
        display: grid;
        grid-template-columns: 1fr 350px;
        gap: 20px;
        height: calc(100vh - 140px);
    }

    .graph-view {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .graph-toolbar {
        padding: 10px 15px;
        border-bottom: 1px solid var(--border);
        display: flex;
        gap: 10px;
        background: rgba(0,0,0,0.1);
    }

    .graph-canvas {
        flex: 1;
        overflow: auto;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: flex-start;
    }

    .details-panel {
        background: var(--card-bg);
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .details-header {
        padding: 15px;
        border-bottom: 1px solid var(--border);
        background: rgba(0,0,0,0.1);
    }

    .details-header h3 {
        margin: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .details-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .step-detail-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        padding: 15px;
        margin-bottom: 15px;
    }

    .detail-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 5px;
    }

    .detail-value {
        font-size: 0.95rem;
        color: var(--text-main);
        line-height: 1.5;
        white-space: pre-wrap;
    }

    .confidence-meter {
        height: 4px;
        background: rgba(255,255,255,0.1);
        border-radius: 2px;
        margin-top: 5px;
        overflow: hidden;
    }

    .confidence-fill {
        height: 100%;
        background: var(--accent);
        width: 0%;
        transition: width 0.3s ease;
    }

    .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 5px;
    }

    .tag {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 10px;
        background: rgba(255,255,255,0.1);
        color: var(--text-muted);
    }

    /* Mermaid Customization */
    .node rect, .node circle, .node ellipse, .node polygon, .node path {
        fill: var(--card-bg) !important;
        stroke: var(--accent) !important;
        stroke-width: 2px !important;
    }
    .node .label {
        color: var(--text-main) !important;
        font-family: 'Inter', sans-serif !important;
    }
    .edgePath .path {
        stroke: var(--text-muted) !important;
        stroke-width: 1.5px !important;
    }
    .arrowheadPath {
        fill: var(--text-muted) !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="reasoning-container">
    <!-- Graph Visualization -->
    <div class="graph-view">
        <div class="graph-toolbar">
            <button class="btn btn-small btn-secondary" onclick="resetZoom()">
                <span class="material-symbols-outlined">center_focus_strong</span> Reset
            </button>
            <button class="btn btn-small btn-secondary" onclick="toggleDirection()">
                <span class="material-symbols-outlined">rotate_90_degrees_ccw</span> Rotate
            </button>
            <div style="flex:1"></div>
            <span class="text-muted text-small" id="trace-status">Loading trace...</span>
        </div>
        <div class="graph-canvas" id="mermaid-canvas">
            <!-- Mermaid Graph will be rendered here -->
        </div>
    </div>

    <!-- Step Details -->
    <div class="details-panel">
        <div class="details-header">
            <h3><span class="material-symbols-outlined">info</span> Step Details</h3>
        </div>
        <div class="details-content" id="details-content">
            <div class="empty-state">
                <span class="material-symbols-outlined">touch_app</span>
                <p>Click a node to view reasoning details</p>
            </div>
        </div>
    </div>
</div>

<script>
    const auditId = "{{ audit_id }}";
    let traceData = [];
    let currentDirection = 'TD'; // Top-Down

    document.addEventListener('DOMContentLoaded', async () => {
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: {
                curve: 'basis',
                padding: 20
            }
        });

        await loadTraceData();
    });

    async function loadTraceData() {
        try {
            document.getElementById('trace-status').textContent = "Fetching data...";
            // Fetch trace data from API
            const response = await fetch(`/api/audits/${auditId}/traces`);
            traceData = await response.json();

            if (!traceData || traceData.length === 0) {
                document.getElementById('mermaid-canvas').innerHTML =
                    '<div class="empty-state">No reasoning trace found for this audit entry.</div>';
                document.getElementById('trace-status').textContent = "No data";
                return;
            }

            renderGraph();
            document.getElementById('trace-status').textContent = `${traceData.length} steps loaded`;

        } catch (error) {
            console.error("Failed to load trace:", error);
            document.getElementById('mermaid-canvas').innerHTML =
                `<div class="error-state">Error loading trace: ${error.message}</div>`;
        }
    }

    function renderGraph() {
        // Construct Mermaid graph definition
        let graphDef = `graph ${currentDirection}\n`;
        
        // Define nodes
        traceData.forEach((step, index) => {
            // Node ID: step_{index}
            // Label: Step type or short summary
            const label = step.step_type ? step.step_type.replace(/_/g, ' ') : `Step ${index + 1}`;
            const summary = (step.reasoning || '').substring(0, 30) + '...';
            
            // Style based on confidence or type
            let styleClass = 'default';
            if (step.confidence_score > 0.8) styleClass = 'high-conf';
            
            graphDef += `    step_${index}["<b>${label}</b><br/>${escapeMermaid(summary)}"]:::${styleClass}\n`;
            
            // Define click event (handled by mermaid API)
            graphDef += `    click step_${index} call onNodeClick(${index})
`;
        });

        // Define edges (Sequential for now, can be improved if trace has explicit parent/child info)
        for (let i = 0; i < traceData.length - 1; i++) {
            graphDef += `    step_${i} --> step_${i+1}\n`;
        }

        // Apply classes
        graphDef += `    classDef default fill:#1e1e1e,stroke:#333,stroke-width:2px,color:#eee;
`;
        graphDef += `    classDef high-conf fill:#1a2e1a,stroke:#4caf50,stroke-width:2px,color:#eee;
`;

        // Render
        const element = document.getElementById('mermaid-canvas');
        element.innerHTML = `<pre class="mermaid">${graphDef}</pre>`;
        
        mermaid.run({
            nodes: [element.querySelector('.mermaid')]
        });
    }

    function toggleDirection() {
        currentDirection = currentDirection === 'TD' ? 'LR' : 'TD';
        renderGraph();
    }

    function resetZoom() {
        // TODO: Implement zoom/pan reset if we add a zoom library
        renderGraph();
    }

    // Global function for Mermaid click callback
    window.onNodeClick = function(index) {
        const step = traceData[index];
        const container = document.getElementById('details-content');
        
        container.innerHTML = `
            <div class="step-detail-card">
                <div class="detail-label">Step Type</div>
                <div class="detail-value" style="font-weight:bold; color:var(--accent)">
                    ${step.step_type || 'Generic Reasoning'}
                </div>
            </div>

            <div class="step-detail-card">
                <div class="detail-label">Reasoning</div>
                <div class="detail-value">${formatText(step.reasoning || 'No reasoning provided')}</div>
            </div>

            <div class="step-detail-card">
                <div class="detail-label">Input Context</div>
                <div class="detail-value">${formatText(step.user_input || step.context_used || 'None')}</div>
            </div>

            <div class="step-detail-card">
                <div class="detail-label">Output</div>
                <div class="detail-value">${formatText(step.output || 'None')}</div>
            </div>

            <div class="step-detail-card">
                <div class="detail-label">Metrics</div>
                <div class="detail-row" style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span>Confidence</span>
                    <span>${(step.confidence_score * 100).toFixed(1)}%</span>
                </div>
                <div class="confidence-meter">
                    <div class="confidence-fill" style="width: ${step.confidence_score * 100}%"></div>
                </div>
                <div class="detail-row" style="display:flex; justify-content:space-between; margin-top:10px;">
                    <span>Tokens</span>
                    <span>${step.tokens_used || 0}</span>
                </div>
                <div class="detail-row" style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span>Latency</span>
                    <span>${step.response_time_ms || 0}ms</span>
                </div>
            </div>
        `;
    };

    function escapeMermaid(str) {
        return str.replace(/["'<>]/g, '').replace(/\n/g, ' ');
    }
    
    function formatText(str) {
        // Simple markdown-like formatter
        return str
            .replace(/</g, '&lt;').replace(/>/g, '&gt;')
            .replace(/\n/g, '<br>');
    }
</script>
{% endblock %}