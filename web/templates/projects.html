{% extends "base.html" %}

{% block title %}Shadow Web - Projects{% endblock %}
{% block page_title %}Projects{% endblock %}

{% block content %}
<div class="page-actions">
    <button class="btn btn-primary" onclick="showCreateProjectModal()">
        <span class="material-symbols-outlined">add</span> Create New
    </button>
    <input type="text" id="search-input" class="search-input" placeholder="Search projects..." oninput="filterProjects()">
    <button class="btn btn-small filter-btn" id="show-pinned-btn" onclick="togglePinnedFilter()">
        <span class="material-symbols-outlined">push_pin</span> Pinned
    </button>
    <div class="view-toggle">
        <button class="btn btn-small" id="grid-view-btn" onclick="setView('grid')">Grid</button>
        <button class="btn btn-small active" id="list-view-btn" onclick="setView('list')">List</button>
    </div>
</div>

<div class="projects-grid" id="projects-container">
    <div class="loading">Loading projects...</div>
</div>
{% endblock %}

<!-- Create Project Modal -->
<div id="create-project-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Create Project</h2>
            <button class="modal-close" onclick="closeCreateProjectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="create-project-name">Project Name *</label>
                <input type="text" id="create-project-name" class="form-input" placeholder="My Project">
            </div>
            <div class="form-group">
                <label for="create-project-path">Path</label>
                <input type="text" id="create-project-path" class="form-input" placeholder="C:\Projects\my-project">
            </div>
            <div class="form-group">
                <label for="create-project-description">Description</label>
                <textarea id="create-project-description" class="form-input" rows="3" placeholder="Project description..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="create-project-group">Group</label>
                    <input type="text" id="create-project-group" class="form-input" placeholder="Personal">
                </div>
                <div class="form-group">
                    <label for="create-project-color">Color</label>
                    <input type="color" id="create-project-color" class="form-input form-color" value="#6750A4">
                </div>
            </div>
            <div class="form-group">
                <label for="create-project-github">GitHub URL</label>
                <input type="text" id="create-project-github" class="form-input" placeholder="https://github.com/user/repo">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateProjectModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createProject()">Create</button>
        </div>
    </div>
</div>

<!-- Edit Project Modal -->
<div id="edit-project-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>Edit Project</h2>
            <button class="modal-close" onclick="closeEditProjectModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="edit-project-name">Project Name</label>
                <input type="text" id="edit-project-name" class="form-input">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditProjectModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveProject()">Save</button>
        </div>
    </div>
</div>

{% block scripts %}
<script>
let allProjects = [];
let currentView = 'list';
let showPinnedOnly = false;
let editingProjectId = null;

document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
});

async function loadProjects() {
    const deviceId = getDeviceIdParam();
    allProjects = await api.getProjects(deviceId);
    filterProjects();
}

function togglePinnedFilter() {
    showPinnedOnly = !showPinnedOnly;
    document.getElementById('show-pinned-btn').classList.toggle('active', showPinnedOnly);
    filterProjects();
}

function filterProjects() {
    const search = document.getElementById('search-input').value.toLowerCase();

    let filtered = allProjects.filter(p =>
        p.name.toLowerCase().includes(search) ||
        p.path.toLowerCase().includes(search)
    );

    // Filter to pinned only if enabled
    if (showPinnedOnly) {
        filtered = filtered.filter(p => p.is_pinned);
    }

    // Sort pinned to top
    filtered.sort((a, b) => {
        if (a.is_pinned && !b.is_pinned) return -1;
        if (!a.is_pinned && b.is_pinned) return 1;
        return (b.updated_at || 0) - (a.updated_at || 0);
    });

    renderProjects(filtered);
}

function setView(view) {
    currentView = view;
    document.getElementById('grid-view-btn').classList.toggle('active', view === 'grid');
    document.getElementById('list-view-btn').classList.toggle('active', view === 'list');
    filterProjects();
}

async function togglePin(projectId, event) {
    if (event) event.stopPropagation();
    const project = allProjects.find(p => p.id === projectId);
    if (project) {
        project.is_pinned = !project.is_pinned;
        filterProjects();
        showToast(project.is_pinned ? 'Project pinned' : 'Project unpinned', 'success');
    }
}

function showEditProjectModal(projectId, currentName, event) {
    if (event) event.stopPropagation();
    editingProjectId = projectId;
    document.getElementById('edit-project-name').value = currentName;
    document.getElementById('edit-project-modal').classList.remove('hidden');
}

function closeEditProjectModal() {
    document.getElementById('edit-project-modal').classList.add('hidden');
    editingProjectId = null;
}

async function saveProject() {
    if (!editingProjectId) return;
    const newName = document.getElementById('edit-project-name').value.trim();
    if (!newName) {
        showToast('Please enter a project name', 'warning');
        return;
    }
    const result = await api.updateProject(editingProjectId, { name: newName });
    if (result.success) {
        showToast('Project updated', 'success');
        closeEditProjectModal();
        loadProjects();
    } else {
        showToast('Failed to update: ' + (result.error || 'Unknown error'), 'error');
    }
}

function showCreateProjectModal() {
    // Clear form
    document.getElementById('create-project-name').value = '';
    document.getElementById('create-project-path').value = '';
    document.getElementById('create-project-description').value = '';
    document.getElementById('create-project-group').value = '';
    document.getElementById('create-project-color').value = '#6750A4';
    document.getElementById('create-project-github').value = '';
    document.getElementById('create-project-modal').classList.remove('hidden');
}

function closeCreateProjectModal() {
    document.getElementById('create-project-modal').classList.add('hidden');
}

async function createProject() {
    const name = document.getElementById('create-project-name').value.trim();
    if (!name) {
        showToast('Please enter a project name', 'warning');
        return;
    }

    const data = {
        name: name,
        path: document.getElementById('create-project-path').value.trim(),
        description: document.getElementById('create-project-description').value.trim(),
        group: document.getElementById('create-project-group').value.trim() || null,
        color: document.getElementById('create-project-color').value,
        github_repo_url: document.getElementById('create-project-github').value.trim() || null,
        device_id: getDeviceIdParam() || 'web'
    };

    const result = await api.createProject(data);
    if (result.success) {
        showToast('Project created', 'success');
        closeCreateProjectModal();
        loadProjects();
    } else {
        showToast('Failed to create: ' + (result.error || 'Unknown error'), 'error');
    }
}

function renderProjects(projects) {
    const container = document.getElementById('projects-container');
    container.className = currentView === 'grid' ? 'projects-grid' : 'projects-list';

    if (projects.length === 0) {
        container.innerHTML = '<div class="empty-state">No projects found</div>';
        return;
    }

    if (currentView === 'grid') {
        container.innerHTML = projects.map(p => `
            <div class="project-card">
                <div class="project-card-header">
                    <button class="pin-btn ${p.is_pinned ? 'pinned' : ''}" onclick="togglePin('${p.id}', event)" title="Pin project"><span class="material-symbols-outlined">push_pin</span></button>
                    <button class="btn-icon-small" onclick="showEditProjectModal('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', event)" title="Edit"><span class="material-symbols-outlined">edit</span></button>
                </div>
                <div class="project-name">${escapeHtml(p.name)}</div>
                <div class="project-path">${escapeHtml(p.path)}</div>
                <div class="project-meta">
                    <span>${p.device_name}</span>
                    <span>${p.time_ago}</span>
                </div>
                <a href="/projects/${p.id}" class="btn btn-small btn-primary">Open</a>
            </div>
        `).join('');
    } else {
        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="40"></th>
                        <th>Name</th>
                        <th>Path</th>
                        <th>Device</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${projects.map(p => `
                        <tr>
                            <td><button class="pin-btn ${p.is_pinned ? 'pinned' : ''}" onclick="togglePin('${p.id}', event)" title="Pin project"><span class="material-symbols-outlined">push_pin</span></button></td>
                            <td>${escapeHtml(p.name)}</td>
                            <td class="path-cell">${escapeHtml(p.path)}</td>
                            <td>${escapeHtml(p.device_name)}</td>
                            <td>${p.time_ago}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon-small" onclick="showEditProjectModal('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', event)" title="Edit"><span class="material-symbols-outlined">edit</span></button>
                                    <a href="/projects/${p.id}" class="btn btn-small btn-primary">Open</a>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
}
</script>

<style>
.filter-btn {
    display: flex;
    align-items: center;
    gap: 4px;
}

.filter-btn.active {
    background: var(--accent);
    color: white;
}

.pin-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    color: var(--text-dim);
    transition: all 0.15s;
}

.pin-btn:hover {
    background: var(--bg-hover);
    color: var(--text);
}

.pin-btn.pinned {
    color: var(--accent);
}

.pin-btn .material-symbols-outlined {
    font-size: 18px;
}

.project-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--spacing-sm);
}

.action-buttons {
    display: flex;
    gap: var(--spacing-xs);
    align-items: center;
}

.projects-list {
    display: flex;
    flex-direction: column;
}

.form-row {
    display: flex;
    gap: var(--spacing-md);
}

.form-row .form-group {
    flex: 1;
}

.form-color {
    height: 40px;
    padding: 4px;
    cursor: pointer;
}
</style>
{% endblock %}
