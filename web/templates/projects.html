{% extends "base.html" %}

{% block title %}Shadow Web - Projects{% endblock %}
{% block page_title %}Projects{% endblock %}

{% block content %}
<div class="page-actions">
    <input type="text" id="search-input" class="search-input" placeholder="Search projects..." oninput="filterProjects()">
    <button class="btn btn-small filter-btn" id="show-pinned-btn" onclick="togglePinnedFilter()">
        <span class="material-symbols-outlined">push_pin</span> Pinned
    </button>
    <div class="view-toggle">
        <button class="btn btn-small" id="grid-view-btn" onclick="setView('grid')">Grid</button>
        <button class="btn btn-small active" id="list-view-btn" onclick="setView('list')">List</button>
    </div>
    <!-- Autonomous mode button hidden for ShadowBridge (intended for shadow-android debug builds) -->
    <button class="btn btn-autonomous hidden" id="autonomous-mode-btn" onclick="triggerAutonomousMode()" title="Autonomous Mode - Analyze, plan, and improve projects using AI reasoning">
        <span class="material-symbols-outlined">auto_awesome</span> Autonomous
    </button>
    <button class="btn btn-primary" onclick="showCreateProjectModal()">
        <span class="material-symbols-outlined">add</span> Create New
    </button>
</div>

<div class="projects-grid" id="projects-container">
    <div class="loading">Loading projects...</div>
</div>
{% endblock %}

<script>
let allProjects = [];
let currentView = 'list';
let showPinnedOnly = false;
let editingProjectId = null;
let isDebugMode = false;

// Check if debug mode is enabled on page load
async function checkDebugMode() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();
        isDebugMode = data.debug_mode === true;
        
        // Show autonomous mode button only in debug builds (for Android app)
        const autBtn = document.getElementById('autonomous-mode-btn');
        if (autBtn) {
            if (isDebugMode) {
                autBtn.classList.remove('hidden');
                autBtn.style.display = 'flex';
            } else {
                autBtn.classList.add('hidden');
                autBtn.style.display = 'none';
            }
        }
    } catch (e) {
        console.error('Failed to check debug mode:', e);
    }
}

// Trigger autonomous mode - analyzes projects using todo.md and docs
async function triggerAutonomousMode() {
    if (!confirm('Autonomous Mode will analyze all your projects using AI reasoning and planning. It will read todo.md, documentation, and suggest improvements. Continue?')) {
        return;
    }
    
    try {
        showToast('Starting autonomous mode: Analyzing projects...', 'info');
        
        const response = await fetch('/api/autonomous-mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Autonomous mode activated! AI is now analyzing your projects.', 'success', 5000);
            // Reload projects after delay to see improvements
            setTimeout(() => loadProjects(), 2000);
        } else {
            showToast(result.error || 'Failed to activate autonomous mode', 'error');
        }
    } catch (e) {
        console.error('Autonomous mode error:', e);
        showToast('Failed to activate autonomous mode', 'error');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Check debug mode and show autonomous button
    checkDebugMode();
    
    loadProjects();
});

async function loadProjects() {
    const deviceId = getDeviceIdParam();
    const result = await api.getProjects(deviceId);
    
    if (Array.isArray(result)) {
        allProjects = result;
        filterProjects();
    } else {
        console.error('Failed to load projects:', result);
        allProjects = [];
        showToast('Failed to load projects: ' + (result.error || 'Unknown error'), 'error');
        document.getElementById('projects-container').innerHTML = '<div class="empty-state">Error loading projects</div>';
    }
}

function togglePinnedFilter() {
    showPinnedOnly = !showPinnedOnly;
    document.getElementById('show-pinned-btn').classList.toggle('active', showPinnedOnly);
    filterProjects();
}

function filterProjects() {
    const search = document.getElementById('search-input').value.toLowerCase();

    let filtered = allProjects.filter(p =>
        p.name.toLowerCase().includes(search) ||
        p.path.toLowerCase().includes(search)
    );

    // Filter to pinned only if enabled
    if (showPinnedOnly) {
        filtered = filtered.filter(p => p.is_pinned);
    }

    // Sort pinned to top
    filtered.sort((a, b) => {
        if (a.is_pinned && !b.is_pinned) return -1;
        if (!a.is_pinned && b.is_pinned) return 1;
        return (b.updated_at || 0) - (a.updated_at || 0);
    });

    renderProjects(filtered);
}

function setView(view) {
    currentView = view;
    document.getElementById('grid-view-btn').classList.toggle('active', view === 'grid');
    document.getElementById('list-view-btn').classList.toggle('active', view === 'list');
    filterProjects();
}

async function togglePin(projectId, event) {
    if (event) event.stopPropagation();
    const project = allProjects.find(p => p.id === projectId);
    if (project) {
        project.is_pinned = !project.is_pinned;
        filterProjects();
        showToast(project.is_pinned ? 'Project pinned' : 'Project unpinned', 'success');
    }
}

async function deleteProject(projectId, projectName, event) {
    if (event) event.stopPropagation();
    if (!confirm(`Delete project "${projectName}"? This cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'DELETE'
        });
        const result = await response.json();

        if (result.success) {
            showToast('Project deleted', 'success');
            // Remove from local array and refresh
            allProjects = allProjects.filter(p => p.id !== projectId);
            filterProjects();
        } else {
            showToast(result.error || 'Failed to delete project', 'error');
        }
    } catch (e) {
        console.error('Delete project error:', e);
        showToast('Failed to delete project', 'error');
    }
}

function showEditProjectModal(projectId, currentName, event) {
    if (event) event.stopPropagation();
    editingProjectId = projectId;
    document.getElementById('edit-project-name').value = currentName;
    document.getElementById('edit-project-modal').classList.remove('hidden');
}

function closeEditProjectModal() {
    document.getElementById('edit-project-modal').classList.add('hidden');
    editingProjectId = null;
}

async function saveProject() {
    if (!editingProjectId) return;
    const newName = document.getElementById('edit-project-name').value.trim();
    if (!newName) {
        showToast('Please enter a project name', 'warning');
        return;
    }
    const result = await api.updateProject(editingProjectId, { name: newName });
    if (result.success) {
        showToast('Project updated', 'success');
        closeEditProjectModal();
        loadProjects();
    } else {
        showToast('Failed to update: ' + (result.error || 'Unknown error'), 'error');
    }
}

function showCreateProjectModal() {
    // Clear form
    document.getElementById('create-project-name').value = '';
    document.getElementById('create-project-path').value = '';
    document.getElementById('create-project-description').value = '';
    document.getElementById('create-project-group').value = '';
    document.getElementById('create-project-color').value = '#6750A4';
    document.getElementById('create-project-github').value = '';
    document.getElementById('create-project-modal').classList.remove('hidden');
}

function closeCreateProjectModal() {
    document.getElementById('create-project-modal').classList.add('hidden');
}

async function createProject() {
    const name = document.getElementById('create-project-name').value.trim();
    if (!name) {
        showToast('Please enter a project name', 'warning');
        return;
    }

    const data = {
        name: name,
        path: document.getElementById('create-project-path').value.trim(),
        description: document.getElementById('create-project-description').value.trim(),
        group: document.getElementById('create-project-group').value.trim() || null,
        color: document.getElementById('create-project-color').value,
        github_repo_url: document.getElementById('create-project-github').value.trim() || null,
        device_id: getDeviceIdParam() || 'web'
    };

    const result = await api.createProject(data);
    if (result.success) {
        showToast('Project created', 'success');
        closeCreateProjectModal();
        loadProjects();
    } else {
        showToast('Failed to create: ' + (result.error || 'Unknown error'), 'error');
    }
}

function renderProjects(projects) {
    const container = document.getElementById('projects-container');
    container.className = currentView === 'grid' ? 'projects-grid' : 'projects-list';

    if (projects.length === 0) {
        container.innerHTML = '<div class="empty-state">No projects found</div>';
        return;
    }

    if (currentView === 'grid') {
        container.innerHTML = projects.map(p => `
            <div class="project-card">
                <div class="project-card-header">
                    <button class="pin-btn ${p.is_pinned ? 'pinned' : ''}" onclick="togglePin('${p.id}', event)" title="Pin project"><span class="material-symbols-outlined">push_pin</span></button>
                    <div class="project-card-actions">
                        <button class="btn-icon-small" onclick="showEditProjectModal('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', event)" title="Edit"><span class="material-symbols-outlined">edit</span></button>
                        <button class="btn-icon-small" onclick="openShareModal('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', '${p.device_id || ''}', event)" title="Share"><span class="material-symbols-outlined">share</span></button>
                        <button class="btn-icon-small btn-danger" onclick="deleteProject('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', event)" title="Delete"><span class="material-symbols-outlined">delete</span></button>
                    </div>
                </div>
                <div class="project-name">${escapeHtml(p.name)}</div>
                <div class="project-path">${escapeHtml(p.path)}</div>
                <div class="project-meta">
                    <span>${p.device_name}</span>
                    <span>${p.time_ago}</span>
                </div>
                <a href="/projects/${p.id}" class="btn btn-small btn-primary">Open</a>
            </div>
        `).join('');
    } else {
        container.innerHTML = `
            <table class="data-table">
                <thead>
                    <tr>
                        <th width="40"></th>
                        <th>Name</th>
                        <th>Path</th>
                        <th>Device</th>
                        <th>Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    ${projects.map(p => `
                        <tr>
                            <td><button class="pin-btn ${p.is_pinned ? 'pinned' : ''}" onclick="togglePin('${p.id}', event)" title="Pin project"><span class="material-symbols-outlined">push_pin</span></button></td>
                            <td>${escapeHtml(p.name)}</td>
                            <td class="path-cell">${escapeHtml(p.path)}</td>
                            <td>${escapeHtml(p.device_name)}</td>
                            <td>${p.time_ago}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-icon-small" onclick="showEditProjectModal('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', event)" title="Edit"><span class="material-symbols-outlined">edit</span></button>
                                    <button class="btn-icon-small" onclick="openShareModal('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', '${p.device_id || ''}', event)" title="Share"><span class="material-symbols-outlined">share</span></button>
                                    <button class="btn-icon-small btn-danger" onclick="deleteProject('${p.id}', '${escapeHtml(p.name).replace(/'/g, "\\'")}', event)" title="Delete"><span class="material-symbols-outlined">delete</span></button>
                                    <a href="/projects/${p.id}" class="btn btn-small btn-primary">Open</a>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }
}

// ============ Sharing Functions ============

let currentShareProjectId = null;
let currentShareOwnerDevice = null;
let allDevices = [];

async function openShareModal(projectId, name, ownerDevice, event) {
    if (event) event.stopPropagation();

    currentShareProjectId = projectId;
    currentShareOwnerDevice = ownerDevice;

    document.getElementById('share-project-title-display').textContent = name;
    document.getElementById('share-project-modal').classList.remove('hidden');

    // Load devices for dropdown
    await loadDevicesForSharing();

    // Load current permissions
    await loadProjectPermissions(projectId);
}

function closeShareModal() {
    document.getElementById('share-project-modal').classList.add('hidden');
    currentShareProjectId = null;
    currentShareOwnerDevice = null;
}

async function loadDevicesForSharing() {
    try {
        allDevices = await api.getDevices();
        const select = document.getElementById('share-device-select');
        select.innerHTML = '<option value="">Select a device...</option>';

        allDevices.forEach(device => {
            // Don't show the owner device in the dropdown
            if (device.id !== currentShareOwnerDevice) {
                const option = document.createElement('option');
                option.value = device.id;
                option.textContent = device.name || device.id;
                select.appendChild(option);
            }
        });
    } catch (e) {
        console.error('Failed to load devices:', e);
    }
}

async function loadProjectPermissions(projectId) {
    const container = document.getElementById('current-shares');

    try {
        // Get permissions info from API
        const response = await fetch(`/api/projects/${projectId}/permissions?device_id=${encodeURIComponent(currentShareOwnerDevice)}`);
        const data = await response.json();

        if (data.error) {
            container.innerHTML = '<div class="empty-state">Could not load sharing info</div>';
            return;
        }

        const sharedWith = data.shared_with || [];

        if (sharedWith.length === 0) {
            container.innerHTML = '<div class="empty-state">Not shared with anyone</div>';
            return;
        }

        // Render current shares
        container.innerHTML = sharedWith.map(share => {
            const device = allDevices.find(d => d.id === share.device_id);
            const deviceName = device ? (device.name || device.id) : share.device_id;
            const permissionLabel = {
                'view': 'View only',
                'edit': 'Can edit',
                'full': 'Full access'
            }[share.permission] || share.permission;

            return `
                <div class="share-item">
                    <div class="share-device">
                        <span class="material-symbols-outlined">smartphone</span>
                        <span>${escapeHtml(deviceName)}</span>
                    </div>
                    <div class="share-permission">${permissionLabel}</div>
                    <button class="btn-icon-small btn-danger" onclick="removeShare('${share.device_id}')" title="Remove access">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            `;
        }).join('');
    } catch (e) {
        console.error('Failed to load permissions:', e);
        container.innerHTML = '<div class="empty-state">Could not load sharing info</div>';
    }
}

async function addShare() {
    const targetDevice = document.getElementById('share-device-select').value;
    const permission = document.getElementById('share-permission-select').value;

    if (!targetDevice) {
        showToast('Please select a device', 'warning');
        return;
    }

    try {
        const response = await fetch(`/api/projects/${currentShareProjectId}/share`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                owner_device: currentShareOwnerDevice,
                target_device: targetDevice,
                permission: permission
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('Project shared successfully', 'success');
            document.getElementById('share-device-select').value = '';
            await loadProjectPermissions(currentShareProjectId);
            await loadDevicesForSharing();  // Refresh dropdown
        } else {
            showToast(result.error || 'Failed to share', 'error');
        }
    } catch (e) {
        console.error('Share error:', e);
        showToast('Failed to share project', 'error');
    }
}

async function removeShare(targetDevice) {
    if (!confirm('Remove access for this device?')) return;

    try {
        const response = await fetch(`/api/projects/${currentShareProjectId}/share`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                owner_device: currentShareOwnerDevice,
                target_device: targetDevice
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('Access removed', 'success');
            await loadProjectPermissions(currentShareProjectId);
            await loadDevicesForSharing();  // Refresh dropdown
        } else {
            showToast(result.error || 'Failed to remove access', 'error');
        }
    } catch (e) {
        console.error('Unshare error:', e);
        showToast('Failed to remove access', 'error');
    }
}
</script>

<style>
.filter-btn {
    display: flex;
    align-items: center;
    gap: 4px;
}

.filter-btn.active {
    background: var(--accent);
    color: white;
}

.pin-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    color: var(--text-dim);
    transition: all 0.15s;
}

.pin-btn:hover {
    background: var(--bg-hover);
    color: var(--text);
}

.pin-btn.pinned {
    color: var(--accent);
}

.pin-btn .material-symbols-outlined {
    font-size: 18px;
}

.project-card-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--spacing-sm);
}

.action-buttons {
    display: flex;
    gap: var(--spacing-xs);
    align-items: center;
}

.projects-list {
    display: flex;
    flex-direction: column;
}

.form-row {
    display: flex;
    gap: var(--spacing-md);
}

.form-row .form-group {
    flex: 1;
}

.form-color {
    height: 40px;
    padding: 4px;
    cursor: pointer;
}

.project-card-actions {
    display: flex;
    gap: 4px;
}

.modal-medium {
    max-width: 600px;
}

/* Sharing UI Styles */
.share-item-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
    padding: 8px 12px;
    background: var(--bg-elevated);
    border-radius: 6px;
}

.share-section {
    margin-bottom: 20px;
}

.share-section h3 {
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dim);
    margin-bottom: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.share-list {
    background: var(--bg-elevated);
    border-radius: 8px;
    padding: 8px;
}

.share-list .empty-state {
    padding: 16px;
    text-align: center;
    color: var(--text-dim);
    font-size: 14px;
}

.share-item {
    display: flex;
    align-items: center;
    padding: 10px 12px;
    background: var(--bg-card);
    border-radius: 6px;
    margin-bottom: 6px;
}

.share-item:last-child {
    margin-bottom: 0;
}

.share-device {
    display: flex;
    align-items: center;
    gap: 8px;
    flex: 1;
    color: var(--text);
}

.share-device .material-symbols-outlined {
    font-size: 20px;
    color: var(--text-dim);
}

.share-permission {
    font-size: 13px;
    color: var(--text-dim);
    padding: 4px 10px;
    background: var(--bg-elevated);
    border-radius: 4px;
    margin-right: 8px;
}

.share-add-form {
    display: flex;
    gap: 10px;
    align-items: center;
}

.share-add-form .form-input {
    flex: 1;
}

.share-add-form .btn {
    white-space: nowrap;
}

.share-info {
    background: var(--bg-elevated);
    border-radius: 8px;
    padding: 12px 16px;
    font-size: 13px;
    color: var(--text-dim);
}

.share-info p {
    margin: 0 0 8px 0;
}

.share-info ul {
    margin: 0;
    padding-left: 20px;
}

.share-info li {
    margin-bottom: 4px;
}

.share-info strong {
    color: var(--text);
}

.btn-icon-small.btn-danger {
    color: var(--error);
}

.btn-icon-small.btn-danger:hover {
    background: rgba(217, 119, 87, 0.15);
    color: var(--error);
}

/* Autonomous Mode Button */
.btn-autonomous {
    background: linear-gradient(135deg, #FF6B35 0%, #FF8C42 100%);
    color: white;
    border: 1px solid #FF6B35;
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
}

.btn-autonomous.hidden {
    display: none;
}

.btn-autonomous:hover {
    background: linear-gradient(135deg, #FF5722 0%, #FF8C42 100%);
    transform: translateY(-1px);
}

.btn-autonomous .material-symbols-outlined {
    font-size: 18px;
}
</style>
{% endblock %}
