{% extends "base.html" %}

{% block title %}Shadow Web - Settings{% endblock %}
{% block page_title %}Settings{% endblock %}

{% block content %}
<!-- Connection Status -->
<section class="section">
    <div class="section-header">
        <h2>Connection Status</h2>
    </div>
    <div class="status-cards">
        <div class="status-card">
            <div class="status-icon" id="shadowbridge-status-icon"><span class="material-symbols-outlined">circle</span></div>
            <div class="status-info">
                <span class="status-name">ShadowBridge</span>
                <span class="status-value" id="shadowbridge-status">Checking...</span>
            </div>
        </div>
        <div class="status-card">
            <div class="status-icon" id="ssh-status-icon"><span class="material-symbols-outlined">circle</span></div>
            <div class="status-info">
                <span class="status-name">SSH Connection</span>
                <span class="status-value" id="ssh-status">Checking...</span>
            </div>
        </div>
        <div class="status-card">
            <div class="status-icon" id="devices-status-icon"><span class="material-symbols-outlined">circle</span></div>
            <div class="status-info">
                <span class="status-name">Devices</span>
                <span class="status-value" id="devices-status">Checking...</span>
            </div>
        </div>
    </div>
</section>

<!-- Device Setup -->
<section class="section">
    <h2>Connect New Device</h2>
    <div class="qr-section">
        <div class="qr-instructions">
            <p>Scan this QR code with Shadow app to connect a new device.</p>
            <p class="qr-note">Make sure both devices are on the same network or use Tailscale.</p>
            <button class="btn btn-small btn-secondary" onclick="loadQRCode()">
                <span class="material-symbols-outlined">qr_code_2</span> Regenerate
            </button>
        </div>
        <div class="qr-placeholder" id="qr-code">
            <div class="qr-loading">
                <div class="spinner"></div>
                <span>Loading QR code...</span>
            </div>
        </div>
    </div>
</section>

<!-- Connected Devices -->
<section class="section">
    <h2>Connected Devices</h2>
    <p class="section-description">Manage devices connected to ShadowBridge.</p>
    <div id="devices-list" class="devices-list">
        <div class="loading-state">
            <div class="spinner"></div>
            <span>Loading devices...</span>
        </div>
    </div>
</section>

<!-- Preferences -->
<section class="section">
    <h2>Preferences</h2>
    <div class="settings-form">
        <div class="setting-item">
            <div class="setting-info">
                <span class="setting-label">Auto-refresh Interval</span>
                <span class="setting-description">How often to refresh data from devices</span>
            </div>
            <div class="setting-control">
                <select id="refresh-interval" class="form-select" onchange="saveRefreshInterval()">
                    <option value="0">Manual only</option>
                    <option value="30">30 seconds</option>
                    <option value="60" selected>1 minute</option>
                    <option value="300">5 minutes</option>
                    <option value="600">10 minutes</option>
                </select>
            </div>
        </div>

        <div class="setting-item">
            <div class="setting-info">
                <span class="setting-label">Data Retention</span>
                <span class="setting-description">How long to keep cached data locally</span>
            </div>
            <div class="setting-control">
                <select id="data-retention" class="form-select" onchange="saveDataRetention()">
                    <option value="7">7 days</option>
                    <option value="30" selected>30 days</option>
                    <option value="90">90 days</option>
                    <option value="365">1 year</option>
                    <option value="0">Forever</option>
                </select>
            </div>
        </div>
    </div>
</section>

<!-- Security -->
<section class="section">
    <h2>Security</h2>
    <div class="settings-form">
        <div class="setting-item">
            <div class="setting-info">
                <span class="setting-label">Note Encryption</span>
                <span class="setting-description">Encrypt notes at rest using AES-256</span>
            </div>
            <div class="setting-control">
                <label class="toggle-switch">
                    <input type="checkbox" id="note-encryption" onchange="toggleEncryption()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="setting-item" id="encryption-key-setting" style="display: none;">
            <div class="setting-info">
                <span class="setting-label">Encryption Passphrase</span>
                <span class="setting-description">Set a passphrase to encrypt/decrypt notes</span>
            </div>
            <div class="setting-control">
                <input type="password" id="encryption-passphrase" class="form-input" placeholder="Enter passphrase">
                <button class="btn btn-small btn-primary" onclick="saveEncryptionKey()">Save</button>
            </div>
        </div>
        <div class="setting-item">
            <div class="setting-info">
                <span class="setting-label">Auto-lock Timeout</span>
                <span class="setting-description">Automatically lock encrypted notes after inactivity</span>
            </div>
            <div class="setting-control">
                <select id="auto-lock" class="form-select" onchange="saveAutoLock()">
                    <option value="0">Never</option>
                    <option value="5" selected>5 minutes</option>
                    <option value="15">15 minutes</option>
                    <option value="30">30 minutes</option>
                    <option value="60">1 hour</option>
                </select>
            </div>
        </div>
    </div>
</section>

<!-- Email Verification -->
<section class="section">
    <h2>Email Verification</h2>
    <p class="section-description">Verify your email to enable team features, remote sharing, and account recovery.</p>

    <div id="email-verified-section" class="email-status-section" style="display: none;">
        <div class="email-verified-badge">
            <span class="material-symbols-outlined">verified</span>
            <span>Verified: <strong id="verified-email-display"></strong></span>
        </div>
        <button class="btn btn-small btn-secondary" onclick="removeVerifiedEmail()">
            <span class="material-symbols-outlined">link_off</span> Unlink Email
        </button>
    </div>

    <div id="email-unverified-section">
        <div class="email-form" id="email-request-form">
            <div class="form-group">
                <label for="email-input">Email Address</label>
                <input type="email" id="email-input" class="form-input" placeholder="your@email.com">
            </div>
            <button class="btn btn-primary" onclick="requestVerification()">
                <span class="material-symbols-outlined">send</span> Send Verification Code
            </button>
        </div>

        <div class="email-form" id="email-verify-form" style="display: none;">
            <p class="verify-instructions">Enter the 6-digit code sent to <strong id="verify-email-label"></strong></p>
            <div class="form-group">
                <label for="verify-code-input">Verification Code</label>
                <input type="text" id="verify-code-input" class="form-input verification-code" maxlength="6" placeholder="000000" pattern="[0-9]*" inputmode="numeric">
            </div>
            <div class="email-form-actions">
                <button class="btn btn-secondary" onclick="cancelVerification()">Cancel</button>
                <button class="btn btn-primary" onclick="confirmVerification()">
                    <span class="material-symbols-outlined">check</span> Verify
                </button>
            </div>
            <p class="verify-note">Code expires in 10 minutes. <a href="#" onclick="requestVerification(); return false;">Resend code</a></p>
        </div>
    </div>
</section>

<!-- Team Management -->
<section class="section" id="team-management-section">
    <h2>Teams</h2>
    <p class="section-description">Create and manage teams for collaborative work. Requires verified email.</p>

    <div id="teams-requires-email" style="display: none;">
        <div class="info-banner">
            <span class="material-symbols-outlined">info</span>
            <span>Verify your email above to enable team features.</span>
        </div>
    </div>

    <div id="teams-content" style="display: none;">
        <!-- Pending Invitations -->
        <div id="pending-invitations-section" class="team-subsection" style="display: none;">
            <h3>Pending Invitations</h3>
            <div id="pending-invitations-list" class="invitations-list"></div>
        </div>

        <!-- My Teams -->
        <div class="team-subsection">
            <div class="subsection-header">
                <h3>My Teams</h3>
                <button class="btn btn-small btn-primary" onclick="openCreateTeamModal()">
                    <span class="material-symbols-outlined">add</span> Create Team
                </button>
            </div>
            <div id="my-teams-list" class="teams-list">
                <div class="empty-state">
                    <span class="material-symbols-outlined">groups</span>
                    <p>You're not a member of any teams yet.</p>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Create Team Modal -->
<div id="create-team-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2><span class="material-symbols-outlined">group_add</span> Create Team</h2>
            <button class="modal-close" onclick="closeCreateTeamModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="new-team-name">Team Name</label>
                <input type="text" id="new-team-name" class="form-input" placeholder="My Team">
            </div>
            <div class="form-group">
                <label for="new-team-description">Description (optional)</label>
                <textarea id="new-team-description" class="form-input form-textarea" placeholder="What is this team for?"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateTeamModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createTeam()">
                <span class="material-symbols-outlined">check</span> Create
            </button>
        </div>
    </div>
</div>

<!-- Team Details Modal -->
<div id="team-details-modal" class="modal hidden">
    <div class="modal-content modal-medium">
        <div class="modal-header">
            <h2><span class="material-symbols-outlined">groups</span> <span id="team-details-name">Team</span></h2>
            <button class="modal-close" onclick="closeTeamDetailsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="team-details-description" class="team-description"></p>

            <!-- Members List -->
            <div class="team-members-section">
                <div class="subsection-header">
                    <h3>Members</h3>
                    <button class="btn btn-small btn-primary" id="invite-member-btn" onclick="toggleInviteForm()" style="display: none;">
                        <span class="material-symbols-outlined">person_add</span> Invite
                    </button>
                </div>

                <!-- Invite Form (hidden by default) -->
                <div id="invite-member-form" class="invite-form" style="display: none;">
                    <div class="invite-form-row">
                        <input type="email" id="invite-email" class="form-input" placeholder="email@example.com">
                        <select id="invite-role" class="form-select">
                            <option value="member">Member</option>
                            <option value="admin">Admin</option>
                        </select>
                        <button class="btn btn-primary" onclick="inviteMember()">Send</button>
                        <button class="btn btn-secondary" onclick="toggleInviteForm()">Cancel</button>
                    </div>
                </div>

                <div id="team-members-list" class="members-list"></div>
            </div>

            <!-- Team Actions -->
            <div id="team-actions" class="team-actions" style="display: none;">
                <button class="btn btn-danger" id="leave-team-btn" onclick="leaveTeam()">
                    <span class="material-symbols-outlined">logout</span> Leave Team
                </button>
                <button class="btn btn-danger" id="delete-team-btn" onclick="deleteTeam()" style="display: none;">
                    <span class="material-symbols-outlined">delete</span> Delete Team
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Data Management -->
<section class="section">
    <h2>Data Management</h2>
    <div class="data-info">
        <div class="data-stat">
            <span class="data-label">Local Data Path</span>
            <code class="data-value" id="data-path">~/.shadowai/</code>
        </div>
        <div class="data-stat">
            <span class="data-label">Cache Size</span>
            <span class="data-value" id="cache-size">Calculating...</span>
        </div>
        <div class="data-stat">
            <span class="data-label">Cached Notes</span>
            <span class="data-value" id="cached-notes">0</span>
        </div>
    </div>
    <div class="data-actions">
        <button class="btn btn-secondary" onclick="clearCache()">
            <span class="material-symbols-outlined">delete</span> Clear Cache
        </button>
        <button class="btn btn-secondary" onclick="exportAllData()">
            <span class="material-symbols-outlined">download</span> Export All Data
        </button>
    </div>

    <h3 style="margin-top: var(--spacing-xl); margin-bottom: var(--spacing-md);">Data Cleanup</h3>
    <p class="section-description" style="margin-bottom: var(--spacing-md);">Remove stale data while preserving your most recent device.</p>
    <div class="data-actions">
        <button class="btn btn-secondary" onclick="cleanupStaleData()">
            <span class="material-symbols-outlined">cleaning_services</span> Clean Stale Data
        </button>
        <button class="btn btn-secondary" onclick="resetDeviceHistory()">
            <span class="material-symbols-outlined">devices</span> Reset Device History
        </button>
    </div>
</section>

<!-- Network Configuration -->
<section class="section">
    <h2>Network Configuration</h2>
    <div class="about-info">
        <div class="about-row">
            <span class="about-label">Web Dashboard Port</span>
            <span class="about-value">6767</span>
        </div>
        <div class="about-row">
            <span class="about-label">Data Receiver Port</span>
            <span class="about-value">19284</span>
        </div>
        <div class="about-row">
            <span class="about-label">Discovery Broadcast Port</span>
            <span class="about-value">19285</span>
        </div>
        <div class="about-row">
            <span class="about-label">Claude Code Relay Port</span>
            <span class="about-value">19286</span>
        </div>
        <div class="about-row">
            <span class="about-label">Local IP</span>
            <span class="about-value" id="local-ip">Detecting...</span>
        </div>
    </div>
    <div class="network-check">
        <button class="btn btn-primary" id="tailscale-check-btn" onclick="checkTailScale()">
            <span class="material-symbols-outlined">wifi</span> Check TailScale
        </button>
        <span id="tailscale-status-label" class="network-status">Unknown</span>
    </div>
</section>

<!-- About -->
<section class="section">
    <h2>About</h2>
    <div class="about-info">
        <div class="about-row">
            <span class="about-label">Shadow Web Dashboard</span>
            <span class="about-value">v1.000</span>
        </div>
        <div class="about-row">
            <span class="about-label">ShadowBridge Version</span>
            <span class="about-value" id="bridge-version">--</span>
        </div>
        <div class="about-row clickable" onclick="window.open('https://github.com/alrightryanx/shadowai/releases', '_blank')">
            <span class="about-label">Changelog</span>
            <span class="about-value link">View on GitHub <span class="material-symbols-outlined">open_in_new</span></span>
        </div>
        <div class="about-row clickable" onclick="window.open('https://ryancartwright.com/shadowai', '_blank')">
            <span class="about-label">Website</span>
            <span class="about-value link">ryancartwright.com/shadowai <span class="material-symbols-outlined">open_in_new</span></span>
        </div>
        <div class="about-row clickable" onclick="window.open('mailto:contact@ryancartwright.com', '_blank')">
            <span class="about-label">Contact</span>
            <span class="about-value link">contact@ryancartwright.com <span class="material-symbols-outlined">open_in_new</span></span>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadStatus();
    loadQRCode();
    loadDataStats();
    loadPreferences();
    loadEmailVerificationStatus();
    loadTeamManagement();
    loadDevicesList();
});

// ============ Email Verification ============

let pendingVerificationEmail = null;

async function loadEmailVerificationStatus() {
    // Get current device ID (use stored or generate)
    const deviceId = getCurrentDeviceId();

    try {
        const response = await fetch(`/api/email/verified/${encodeURIComponent(deviceId)}`);
        const data = await response.json();

        if (data.email) {
            // Email is verified
            document.getElementById('email-verified-section').style.display = 'flex';
            document.getElementById('email-unverified-section').style.display = 'none';
            document.getElementById('verified-email-display').textContent = data.email;
        } else {
            // No verified email
            document.getElementById('email-verified-section').style.display = 'none';
            document.getElementById('email-unverified-section').style.display = 'block';
        }
    } catch (e) {
        console.error('Failed to load email status:', e);
    }
}

function getCurrentDeviceId() {
    // Use stored device ID or generate one for web
    let deviceId = localStorage.getItem('shadow_device_id');
    if (!deviceId) {
        deviceId = 'web_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('shadow_device_id', deviceId);
    }
    return deviceId;
}

async function requestVerification() {
    const email = document.getElementById('email-input').value.trim();
    if (!email || !email.includes('@')) {
        showToast('Please enter a valid email address', 'error');
        return;
    }

    const deviceId = getCurrentDeviceId();

    try {
        const response = await fetch('/api/email/verify/request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, device_id: deviceId })
        });

        const result = await response.json();

        if (result.success) {
            pendingVerificationEmail = email;
            document.getElementById('email-request-form').style.display = 'none';
            document.getElementById('email-verify-form').style.display = 'block';
            document.getElementById('verify-email-label').textContent = email;
            document.getElementById('verify-code-input').value = '';
            document.getElementById('verify-code-input').focus();

            // If code is returned (test mode), show it
            if (result.code) {
                showToast(`Test mode - Code: ${result.code}`, 'info');
            } else {
                showToast(result.message, 'success');
            }
        } else {
            showToast(result.error || 'Failed to send verification', 'error');
        }
    } catch (e) {
        console.error('Request verification error:', e);
        showToast('Failed to send verification code', 'error');
    }
}

function cancelVerification() {
    pendingVerificationEmail = null;
    document.getElementById('email-request-form').style.display = 'block';
    document.getElementById('email-verify-form').style.display = 'none';
}

async function confirmVerification() {
    const code = document.getElementById('verify-code-input').value.trim();
    if (!code || code.length !== 6) {
        showToast('Please enter the 6-digit code', 'error');
        return;
    }

    if (!pendingVerificationEmail) {
        showToast('No pending verification', 'error');
        cancelVerification();
        return;
    }

    const deviceId = getCurrentDeviceId();

    try {
        const response = await fetch('/api/email/verify/confirm', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email: pendingVerificationEmail,
                code: code,
                device_id: deviceId
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('Email verified successfully!', 'success');
            pendingVerificationEmail = null;
            loadEmailVerificationStatus();
        } else {
            showToast(result.error || 'Verification failed', 'error');
        }
    } catch (e) {
        console.error('Confirm verification error:', e);
        showToast('Verification failed', 'error');
    }
}

async function removeVerifiedEmail() {
    if (!confirm('Remove verified email? You will need to verify again to use email-based features.')) {
        return;
    }

    const deviceId = getCurrentDeviceId();

    try {
        const response = await fetch(`/api/email/verified/${encodeURIComponent(deviceId)}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showToast('Email unlinked', 'success');
            loadEmailVerificationStatus();
        } else {
            showToast(result.error || 'Failed to unlink email', 'error');
        }
    } catch (e) {
        console.error('Remove email error:', e);
        showToast('Failed to unlink email', 'error');
    }
}

// ============ Team Management ============

let currentVerifiedEmail = null;
let currentTeamId = null;
let currentUserRole = null;

async function loadTeamManagement() {
    const deviceId = getCurrentDeviceId();

    try {
        // Check if user has verified email
        const response = await fetch(`/api/email/verified/${encodeURIComponent(deviceId)}`);
        const data = await response.json();

        if (data.email) {
            currentVerifiedEmail = data.email;
            document.getElementById('teams-requires-email').style.display = 'none';
            document.getElementById('teams-content').style.display = 'block';

            // Load teams and invitations
            await Promise.all([
                loadMyTeams(),
                loadPendingInvitations()
            ]);
        } else {
            currentVerifiedEmail = null;
            document.getElementById('teams-requires-email').style.display = 'block';
            document.getElementById('teams-content').style.display = 'none';
        }
    } catch (e) {
        console.error('Failed to load team management:', e);
    }
}

async function loadMyTeams() {
    if (!currentVerifiedEmail) return;

    try {
        const response = await fetch(`/api/teams/my-teams?email=${encodeURIComponent(currentVerifiedEmail)}`);
        const data = await response.json();

        const container = document.getElementById('my-teams-list');

        if (!data.teams || data.teams.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-symbols-outlined">groups</span>
                    <p>You're not a member of any teams yet.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = data.teams.map(team => {
            const memberCount = team.members ? team.members.length : 0;
            const myRole = team.members?.find(m => m.email === currentVerifiedEmail)?.role || 'member';
            const roleIcon = myRole === 'owner' ? 'shield' : myRole === 'admin' ? 'admin_panel_settings' : 'person';

            return `
                <div class="team-card" onclick="openTeamDetails('${team.id}')">
                    <div class="team-card-header">
                        <span class="team-name">${escapeHtml(team.name)}</span>
                        <span class="team-role" title="${myRole}">
                            <span class="material-symbols-outlined">${roleIcon}</span>
                        </span>
                    </div>
                    <p class="team-card-description">${escapeHtml(team.description || 'No description')}</p>
                    <div class="team-card-footer">
                        <span class="team-member-count">
                            <span class="material-symbols-outlined">group</span> ${memberCount}
                        </span>
                        <span class="team-created">${formatDate(team.created_at)}</span>
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        console.error('Failed to load teams:', e);
    }
}

async function loadPendingInvitations() {
    if (!currentVerifiedEmail) return;

    try {
        const response = await fetch(`/api/teams/invitations/pending?email=${encodeURIComponent(currentVerifiedEmail)}`);
        const data = await response.json();

        const section = document.getElementById('pending-invitations-section');
        const container = document.getElementById('pending-invitations-list');

        if (!data.invitations || data.invitations.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        container.innerHTML = data.invitations.map(inv => `
            <div class="invitation-card">
                <div class="invitation-info">
                    <span class="invitation-team">${escapeHtml(inv.team_name || 'Unknown Team')}</span>
                    <span class="invitation-from">Invited by ${escapeHtml(inv.inviter_email)}</span>
                    <span class="invitation-role">Role: ${inv.role}</span>
                </div>
                <div class="invitation-actions">
                    <button class="btn btn-small btn-primary" onclick="acceptInvitation('${inv.code}')">Accept</button>
                    <button class="btn btn-small btn-secondary" onclick="declineInvitation('${inv.code}')">Decline</button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        console.error('Failed to load invitations:', e);
    }
}

async function acceptInvitation(code) {
    if (!currentVerifiedEmail) return;

    try {
        const response = await fetch('/api/teams/invitations/accept', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                invitation_code: code,
                accepter_email: currentVerifiedEmail,
                accepter_device: getCurrentDeviceId()
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('Invitation accepted!', 'success');
            await Promise.all([loadMyTeams(), loadPendingInvitations()]);
        } else {
            showToast(result.error || 'Failed to accept invitation', 'error');
        }
    } catch (e) {
        console.error('Accept invitation error:', e);
        showToast('Failed to accept invitation', 'error');
    }
}

async function declineInvitation(code) {
    // For now, just hide the invitation (proper decline would remove from server)
    showToast('Invitation declined', 'info');
    await loadPendingInvitations();
}

function openCreateTeamModal() {
    document.getElementById('new-team-name').value = '';
    document.getElementById('new-team-description').value = '';
    document.getElementById('create-team-modal').classList.remove('hidden');
}

function closeCreateTeamModal() {
    document.getElementById('create-team-modal').classList.add('hidden');
}

async function createTeam() {
    const name = document.getElementById('new-team-name').value.trim();
    const description = document.getElementById('new-team-description').value.trim();

    if (!name) {
        showToast('Please enter a team name', 'error');
        return;
    }

    if (!currentVerifiedEmail) {
        showToast('Email verification required', 'error');
        return;
    }

    try {
        const response = await fetch('/api/teams', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name,
                description,
                owner_email: currentVerifiedEmail,
                owner_device: getCurrentDeviceId()
            })
        });

        const result = await response.json();

        if (result.id) {
            showToast('Team created!', 'success');
            closeCreateTeamModal();
            await loadMyTeams();
        } else {
            showToast(result.error || 'Failed to create team', 'error');
        }
    } catch (e) {
        console.error('Create team error:', e);
        showToast('Failed to create team', 'error');
    }
}

async function openTeamDetails(teamId) {
    currentTeamId = teamId;

    try {
        const response = await fetch(`/api/teams/${teamId}`);
        const team = await response.json();

        if (team.error) {
            showToast(team.error, 'error');
            return;
        }

        document.getElementById('team-details-name').textContent = team.name;
        document.getElementById('team-details-description').textContent = team.description || '';

        // Find current user's role
        currentUserRole = 'member';
        if (team.members) {
            const myMembership = team.members.find(m => m.email === currentVerifiedEmail);
            if (myMembership) {
                currentUserRole = myMembership.role;
            }
        }

        // Show invite button for admins and owners
        const inviteBtn = document.getElementById('invite-member-btn');
        if (currentUserRole === 'owner' || currentUserRole === 'admin') {
            inviteBtn.style.display = 'flex';
        } else {
            inviteBtn.style.display = 'none';
        }

        // Render members list
        renderTeamMembers(team.members || []);

        // Show actions
        const actionsDiv = document.getElementById('team-actions');
        const leaveBtn = document.getElementById('leave-team-btn');
        const deleteBtn = document.getElementById('delete-team-btn');

        actionsDiv.style.display = 'flex';

        if (currentUserRole === 'owner') {
            leaveBtn.style.display = 'none';
            deleteBtn.style.display = 'flex';
        } else {
            leaveBtn.style.display = 'flex';
            deleteBtn.style.display = 'none';
        }

        document.getElementById('team-details-modal').classList.remove('hidden');
    } catch (e) {
        console.error('Open team details error:', e);
        showToast('Failed to load team details', 'error');
    }
}

function closeTeamDetailsModal() {
    document.getElementById('team-details-modal').classList.add('hidden');
    document.getElementById('invite-member-form').style.display = 'none';
    currentTeamId = null;
    currentUserRole = null;
}

function renderTeamMembers(members) {
    const container = document.getElementById('team-members-list');

    if (!members || members.length === 0) {
        container.innerHTML = '<p class="empty-state-small">No members</p>';
        return;
    }

    container.innerHTML = members.map(member => {
        const isMe = member.email === currentVerifiedEmail;
        const roleIcon = member.role === 'owner' ? 'shield' : member.role === 'admin' ? 'admin_panel_settings' : 'person';
        const canManage = (currentUserRole === 'owner' || (currentUserRole === 'admin' && member.role === 'member')) && !isMe;

        return `
            <div class="member-row${isMe ? ' is-me' : ''}">
                <div class="member-info">
                    <span class="member-email">${escapeHtml(member.email)}${isMe ? ' (you)' : ''}</span>
                    <span class="member-role">
                        <span class="material-symbols-outlined">${roleIcon}</span>
                        ${member.role}
                    </span>
                </div>
                ${canManage ? `
                    <div class="member-actions">
                        <select class="form-select form-select-small" onchange="changeMemberRole('${escapeHtml(member.email)}', this.value)">
                            <option value="member"${member.role === 'member' ? ' selected' : ''}>Member</option>
                            <option value="admin"${member.role === 'admin' ? ' selected' : ''}>Admin</option>
                            ${currentUserRole === 'owner' ? `<option value="owner"${member.role === 'owner' ? ' selected' : ''}>Owner</option>` : ''}
                        </select>
                        <button class="btn btn-small btn-danger" onclick="removeMember('${escapeHtml(member.email)}')">
                            <span class="material-symbols-outlined">person_remove</span>
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }).join('');
}

function toggleInviteForm() {
    const form = document.getElementById('invite-member-form');
    form.style.display = form.style.display === 'none' ? 'block' : 'none';
    if (form.style.display !== 'none') {
        document.getElementById('invite-email').value = '';
        document.getElementById('invite-email').focus();
    }
}

async function inviteMember() {
    const email = document.getElementById('invite-email').value.trim();
    const role = document.getElementById('invite-role').value;

    if (!email || !email.includes('@')) {
        showToast('Please enter a valid email', 'error');
        return;
    }

    if (!currentTeamId || !currentVerifiedEmail) {
        showToast('Invalid state', 'error');
        return;
    }

    try {
        const response = await fetch(`/api/teams/${currentTeamId}/invite`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                inviter_email: currentVerifiedEmail,
                invitee_email: email,
                role: role
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast(`Invitation sent to ${email}`, 'success');
            document.getElementById('invite-email').value = '';
            toggleInviteForm();

            // Show invitation code if returned (test mode)
            if (result.invitation_code) {
                showToast(`Test mode - Code: ${result.invitation_code}`, 'info');
            }
        } else {
            showToast(result.error || 'Failed to send invitation', 'error');
        }
    } catch (e) {
        console.error('Invite member error:', e);
        showToast('Failed to send invitation', 'error');
    }
}

async function changeMemberRole(memberEmail, newRole) {
    if (!currentTeamId || !currentVerifiedEmail) return;

    try {
        const response = await fetch(`/api/teams/${currentTeamId}/members/${encodeURIComponent(memberEmail)}/role`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                updater_email: currentVerifiedEmail,
                new_role: newRole
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast(`Role updated to ${newRole}`, 'success');
            await openTeamDetails(currentTeamId); // Refresh
        } else {
            showToast(result.error || 'Failed to update role', 'error');
            await openTeamDetails(currentTeamId); // Refresh to reset
        }
    } catch (e) {
        console.error('Change role error:', e);
        showToast('Failed to update role', 'error');
    }
}

async function removeMember(memberEmail) {
    if (!confirm(`Remove ${memberEmail} from the team?`)) return;
    if (!currentTeamId || !currentVerifiedEmail) return;

    try {
        const response = await fetch(`/api/teams/${currentTeamId}/members/${encodeURIComponent(memberEmail)}?remover_email=${encodeURIComponent(currentVerifiedEmail)}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showToast('Member removed', 'success');
            await openTeamDetails(currentTeamId); // Refresh
        } else {
            showToast(result.error || 'Failed to remove member', 'error');
        }
    } catch (e) {
        console.error('Remove member error:', e);
        showToast('Failed to remove member', 'error');
    }
}

async function leaveTeam() {
    if (!confirm('Are you sure you want to leave this team?')) return;
    if (!currentTeamId || !currentVerifiedEmail) return;

    try {
        const response = await fetch(`/api/teams/${currentTeamId}/members/${encodeURIComponent(currentVerifiedEmail)}?remover_email=${encodeURIComponent(currentVerifiedEmail)}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showToast('You left the team', 'success');
            closeTeamDetailsModal();
            await loadMyTeams();
        } else {
            showToast(result.error || 'Failed to leave team', 'error');
        }
    } catch (e) {
        console.error('Leave team error:', e);
        showToast('Failed to leave team', 'error');
    }
}

async function deleteTeam() {
    if (!confirm('Are you sure you want to delete this team? This cannot be undone.')) return;
    if (!currentTeamId) return;

    try {
        const response = await fetch(`/api/teams/${currentTeamId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showToast('Team deleted', 'success');
            closeTeamDetailsModal();
            await loadMyTeams();
        } else {
            showToast(result.error || 'Failed to delete team', 'error');
        }
    } catch (e) {
        console.error('Delete team error:', e);
        showToast('Failed to delete team', 'error');
    }
}

function formatDate(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    return date.toLocaleDateString();
}

async function loadStatus() {
    const status = await api.getStatus();

    // ShadowBridge
    const sbIcon = document.getElementById('shadowbridge-status-icon');
    const sbStatus = document.getElementById('shadowbridge-status');
    if (status.shadowbridge_running) {
        sbIcon.className = 'status-icon online';
        sbStatus.textContent = 'Running';
    } else {
        sbIcon.className = 'status-icon offline';
        sbStatus.textContent = 'Not Running';
    }

    // SSH
    const sshIcon = document.getElementById('ssh-status-icon');
    const sshStatus = document.getElementById('ssh-status');
    if (status.ssh_status === 'connected') {
        sshIcon.className = 'status-icon online';
        sshStatus.textContent = 'Connected';
    } else {
        sshIcon.className = 'status-icon offline';
        sshStatus.textContent = 'Disconnected';
    }

    // Devices
    const devIcon = document.getElementById('devices-status-icon');
    const devStatus = document.getElementById('devices-status');
    if (status.devices_connected > 0) {
        devIcon.className = 'status-icon online';
        devStatus.textContent = status.devices_connected + ' connected';
    } else {
        devIcon.className = 'status-icon offline';
        devStatus.textContent = 'No devices';
    }

    // Update version info
    if (status.version) {
        document.getElementById('bridge-version').textContent = status.version;
    }

    // Update local IP
    if (status.local_ip) {
        document.getElementById('local-ip').textContent = status.local_ip;
    }

    // Update data path
    if (status.data_path) {
        document.getElementById('data-path').textContent = status.data_path;
    }
}

async function checkTailScale() {
    const btn = document.getElementById('tailscale-check-btn');
    const label = document.getElementById('tailscale-status-label');

    if (btn) btn.disabled = true;
    if (label) label.textContent = 'Checking...';

    try {
        const response = await fetch('/api/tailscale/status');
        const data = await response.json();

        if (response.ok && data.success) {
            if (label) label.textContent = 'TailScale running';
            showToast('TailScale is running', 'success');
        } else {
            const message = data.error || data.details || 'TailScale check failed';
            if (label) label.textContent = message;
            showToast(message, 'error');
        }
    } catch (e) {
        if (label) label.textContent = 'Check failed';
        showToast('TailScale check failed: ' + e.message, 'error');
    } finally {
        if (btn) btn.disabled = false;
    }
}

// ============ Device Management ============

async function loadDevicesList() {
    const container = document.getElementById('devices-list');
    if (!container) return;

    try {
        const response = await fetch('/api/devices');
        const devices = await response.json();

        if (!devices || devices.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <span class="material-symbols-outlined">devices</span>
                    <p>No devices connected yet. Scan the QR code above to connect a device.</p>
                </div>
            `;
            return;
        }

        container.innerHTML = devices.map(device => `
            <div class="device-item" data-device-id="${escapeHtml(device.id)}">
                <div class="device-info">
                    <div class="device-header">
                        <span class="device-status ${device.status === 'online' ? 'online' : 'offline'}"></span>
                        <span class="device-name">${escapeHtml(device.name || device.id)}</span>
                    </div>
                    <div class="device-details">
                        <span class="device-id">${escapeHtml(device.id)}</span>
                        ${device.ip ? `<span class="device-ip">${escapeHtml(device.ip)}</span>` : ''}
                        <span class="device-last-seen">Last seen: ${escapeHtml(device.last_seen_formatted || 'Never')}</span>
                    </div>
                </div>
                <div class="device-actions">
                    <button class="btn btn-small btn-danger" onclick="removeDevice('${escapeHtml(device.id)}', '${escapeHtml(device.name || device.id)}')" title="Remove device">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
            </div>
        `).join('');
    } catch (e) {
        console.error('Failed to load devices:', e);
        container.innerHTML = `
            <div class="error-state">
                <span class="material-symbols-outlined">error</span>
                <p>Failed to load devices</p>
            </div>
        `;
    }
}

async function removeDevice(deviceId, deviceName) {
    if (!confirm(`Remove "${deviceName}" and all its associated data (projects, notes, automations)?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/devices/${encodeURIComponent(deviceId)}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showToast(`Device "${deviceName}" removed successfully`, 'success');
            loadDevicesList();
            loadStatus(); // Update device count in status cards
        } else {
            showToast(result.error || 'Failed to remove device', 'error');
        }
    } catch (e) {
        console.error('Failed to remove device:', e);
        showToast('Failed to remove device: ' + e.message, 'error');
    }
}

async function loadQRCode() {
    const container = document.getElementById('qr-code');
    container.innerHTML = `
        <div class="qr-loading">
            <div class="spinner"></div>
            <span>Loading QR code...</span>
        </div>
    `;

    const qrData = await api.getQRCode();

    if (qrData.image) {
        container.innerHTML = `
            <img src="${qrData.image}" alt="QR Code" class="qr-image">
            <div class="qr-host">${escapeHtml(qrData.host)}:${qrData.port}</div>
        `;
        // Update local IP from QR data
        document.getElementById('local-ip').textContent = qrData.host;
    } else if (qrData.error) {
        container.innerHTML = `
            <div class="qr-error">${escapeHtml(qrData.error)}</div>
            <div class="qr-data"><code>${escapeHtml(qrData.data || '')}</code></div>
        `;
    } else {
        container.innerHTML = `
            <div class="qr-data"><code>${escapeHtml(qrData.data || '')}</code></div>
            <p class="qr-instruction">${escapeHtml(qrData.instruction || '')}</p>
        `;
    }
}

async function loadDataStats() {
    // Calculate cache size from localStorage
    let totalSize = 0;
    let noteCount = 0;
    for (let key in localStorage) {
        if (localStorage.hasOwnProperty(key)) {
            totalSize += localStorage[key].length * 2; // UTF-16 = 2 bytes per char
            if (key.startsWith('shadow_note_')) {
                noteCount++;
            }
        }
    }

    document.getElementById('cache-size').textContent = formatBytes(totalSize);
    document.getElementById('cached-notes').textContent = noteCount.toString();
}

function formatBytes(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function loadPreferences() {
    // Load refresh interval
    const refreshInterval = localStorage.getItem('shadow_refresh_interval') || '60';
    document.getElementById('refresh-interval').value = refreshInterval;

    // Load data retention
    const dataRetention = localStorage.getItem('shadow_data_retention') || '30';
    document.getElementById('data-retention').value = dataRetention;

    // Load encryption settings
    const encryptionEnabled = localStorage.getItem('shadow_encryption_enabled') === 'true';
    document.getElementById('note-encryption').checked = encryptionEnabled;
    document.getElementById('encryption-key-setting').style.display = encryptionEnabled ? 'flex' : 'none';

    const autoLock = localStorage.getItem('shadow_auto_lock') || '5';
    document.getElementById('auto-lock').value = autoLock;
}

function toggleEncryption() {
    const enabled = document.getElementById('note-encryption').checked;
    localStorage.setItem('shadow_encryption_enabled', enabled);
    document.getElementById('encryption-key-setting').style.display = enabled ? 'flex' : 'none';
    showToast(enabled ? 'Note encryption enabled' : 'Note encryption disabled', 'success');
}

function saveEncryptionKey() {
    const passphrase = document.getElementById('encryption-passphrase').value;
    if (!passphrase || passphrase.length < 8) {
        showToast('Passphrase must be at least 8 characters', 'error');
        return;
    }
    // In production, this would be hashed and used to derive an encryption key
    localStorage.setItem('shadow_encryption_key_set', 'true');
    document.getElementById('encryption-passphrase').value = '';
    showToast('Encryption passphrase saved', 'success');
}

function saveAutoLock() {
    const value = document.getElementById('auto-lock').value;
    localStorage.setItem('shadow_auto_lock', value);
    showToast('Auto-lock timeout saved', 'success');
}

function saveRefreshInterval() {
    const value = document.getElementById('refresh-interval').value;
    localStorage.setItem('shadow_refresh_interval', value);
    showToast('Refresh interval saved', 'success');
}

function saveDataRetention() {
    const value = document.getElementById('data-retention').value;
    localStorage.setItem('shadow_data_retention', value);
    showToast('Data retention setting saved', 'success');
}

async function cleanupStaleData() {
    if (!confirm('Remove stale projects, notes, and automations? This will clear data from devices not seen in the last 30 days, keeping only the most recent device data.')) {
        return;
    }

    showToast('Cleaning stale data...', 'info');

    try {
        const response = await fetch('/api/cleanup/stale', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
            showToast(`Cleaned up: ${result.removed_projects || 0} projects, ${result.removed_notes || 0} notes, ${result.removed_automations || 0} automations`, 'success');
            loadDataStats();
        } else {
            showToast(result.error || 'Cleanup failed', 'error');
        }
    } catch (e) {
        console.error('Cleanup error:', e);
        showToast('Failed to clean stale data', 'error');
    }
}

async function resetDeviceHistory() {
    if (!confirm('Reset device history? This will keep only your most recently active device and remove all others.')) {
        return;
    }

    showToast('Resetting device history...', 'info');

    try {
        const response = await fetch('/api/cleanup/devices', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
            showToast(`Device history reset. Kept: ${result.kept_device || 'none'}. Removed ${result.removed_count || 0} devices.`, 'success');
            loadStatus();
        } else {
            showToast(result.error || 'Reset failed', 'error');
        }
    } catch (e) {
        console.error('Device reset error:', e);
        showToast('Failed to reset device history', 'error');
    }
}

async function clearCache() {
    if (!confirm('Clear all cached data? This will remove offline note content and settings.')) {
        return;
    }

    // Clear shadow-related localStorage items
    const keysToRemove = [];
    for (let key in localStorage) {
        if (key.startsWith('shadow_') || key.startsWith('api_cache_')) {
            keysToRemove.push(key);
        }
    }

    keysToRemove.forEach(key => localStorage.removeItem(key));
    showToast('Cache cleared', 'success');
    loadDataStats();
}

async function exportAllData() {
    showToast('Preparing export...', 'info');

    const exportData = {
        exportDate: new Date().toISOString(),
        settings: {
            refreshInterval: localStorage.getItem('shadow_refresh_interval'),
            dataRetention: localStorage.getItem('shadow_data_retention'),
            theme: localStorage.getItem('shadow_theme')
        },
        cache: {}
    };

    // Export cached data
    for (let key in localStorage) {
        if (key.startsWith('shadow_') || key.startsWith('api_cache_')) {
            try {
                exportData.cache[key] = JSON.parse(localStorage[key]);
            } catch {
                exportData.cache[key] = localStorage[key];
            }
        }
    }

    // Download as JSON
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'shadow_export_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);

    showToast('Data exported successfully', 'success');
}
</script>

<style>
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.section-header h2 {
    margin-bottom: 0;
}

/* Settings Form */
.settings-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    background: var(--bg-card);
    border-radius: var(--radius-md);
}

.setting-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.setting-label {
    font-weight: 500;
    color: var(--text);
}

.setting-description {
    font-size: 12px;
    color: var(--text-dim);
}

.setting-control {
    flex-shrink: 0;
}

.form-select {
    background: var(--bg-input);
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 8px 12px;
    font-size: 14px;
    cursor: pointer;
}

.form-select:focus {
    outline: none;
    border-color: var(--accent);
}

/* Data Info */
.data-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
}

.data-stat {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    padding: var(--spacing-md);
    background: var(--bg-card);
    border-radius: var(--radius-md);
}

.data-label {
    font-size: 12px;
    color: var(--text-dim);
}

.data-value {
    font-size: 16px;
    font-weight: 500;
    color: var(--text);
}

.data-value code {
    font-family: monospace;
    font-size: 13px;
}

.data-actions {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
}

.network-check {
    margin-top: var(--spacing-md);
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.network-status {
    color: var(--text-dim);
    font-size: 0.9rem;
}

/* Clickable rows */
.about-row.clickable {
    cursor: pointer;
    transition: background 0.15s;
}

.about-row.clickable:hover {
    background: var(--bg-hover);
}

.about-value.link {
    color: var(--accent);
}

/* QR Loading Spinner */
.qr-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-lg);
    color: var(--text-dim);
}

.spinner {
    width: 32px;
    height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Email Verification Section */
.section-description {
    color: var(--text-dim);
    font-size: 14px;
    margin-bottom: var(--spacing-lg);
}

.email-status-section {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--spacing-md);
    background: var(--bg-card);
    border-radius: var(--radius-md);
    border: 1px solid var(--success);
}

.email-verified-badge {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    color: var(--success);
}

.email-verified-badge .material-symbols-outlined {
    font-size: 24px;
}

.email-verified-badge strong {
    color: var(--text);
}

.email-form {
    background: var(--bg-card);
    padding: var(--spacing-lg);
    border-radius: var(--radius-md);
}

.email-form .form-group {
    margin-bottom: var(--spacing-md);
}

.email-form label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    margin-bottom: var(--spacing-xs);
}

.email-form .form-input {
    width: 100%;
    max-width: 400px;
}

.verification-code {
    font-size: 24px;
    letter-spacing: 8px;
    text-align: center;
    font-family: monospace;
    max-width: 200px !important;
}

.verify-instructions {
    margin-bottom: var(--spacing-md);
    color: var(--text);
}

.email-form-actions {
    display: flex;
    gap: var(--spacing-md);
    margin-top: var(--spacing-md);
}

.verify-note {
    margin-top: var(--spacing-md);
    font-size: 13px;
    color: var(--text-dim);
}

.verify-note a {
    color: var(--accent);
    text-decoration: none;
}

.verify-note a:hover {
    text-decoration: underline;
}

/* Team Management Styles */
.info-banner {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-md);
    background: var(--bg-card);
    border-radius: var(--radius-md);
    border-left: 3px solid var(--warning);
    color: var(--text-dim);
}

.info-banner .material-symbols-outlined {
    color: var(--warning);
}

.team-subsection {
    margin-bottom: var(--spacing-xl);
}

.team-subsection h3 {
    font-size: 16px;
    font-weight: 500;
    margin-bottom: var(--spacing-md);
    color: var(--text);
}

.subsection-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.subsection-header h3 {
    margin-bottom: 0;
}

.teams-list {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-md);
}

.team-card {
    background: var(--bg-card);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    cursor: pointer;
    transition: background 0.15s, transform 0.15s;
    border: 1px solid var(--border);
}

.team-card:hover {
    background: var(--bg-hover);
    transform: translateY(-2px);
}

.team-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
}

.team-name {
    font-weight: 600;
    font-size: 16px;
    color: var(--text);
}

.team-role {
    color: var(--accent);
}

.team-role .material-symbols-outlined {
    font-size: 20px;
}

.team-card-description {
    font-size: 13px;
    color: var(--text-dim);
    margin-bottom: var(--spacing-md);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.team-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: var(--text-dim);
}

.team-member-count {
    display: flex;
    align-items: center;
    gap: 4px;
}

.team-member-count .material-symbols-outlined {
    font-size: 16px;
}

/* Invitations */
.invitations-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.invitation-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    background: var(--bg-card);
    border-radius: var(--radius-md);
    border: 1px solid var(--accent);
}

.invitation-info {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.invitation-team {
    font-weight: 600;
    color: var(--text);
}

.invitation-from,
.invitation-role {
    font-size: 13px;
    color: var(--text-dim);
}

.invitation-actions {
    display: flex;
    gap: var(--spacing-sm);
}

/* Team Details Modal */
.team-description {
    color: var(--text-dim);
    margin-bottom: var(--spacing-lg);
}

.team-members-section {
    margin-bottom: var(--spacing-lg);
}

.invite-form {
    background: var(--bg-input);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--spacing-md);
}

.invite-form-row {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
    flex-wrap: wrap;
}

.invite-form-row .form-input {
    flex: 1;
    min-width: 200px;
}

.invite-form-row .form-select {
    width: auto;
}

.members-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.member-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--bg-card);
    border-radius: var(--radius-sm);
}

.member-row.is-me {
    border: 1px solid var(--accent);
}

.member-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.member-email {
    font-weight: 500;
    color: var(--text);
}

.member-role {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--text-dim);
}

.member-role .material-symbols-outlined {
    font-size: 14px;
}

.member-actions {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
}

.form-select-small {
    padding: 4px 8px;
    font-size: 12px;
}

.team-actions {
    display: flex;
    gap: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border);
}

.empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-xl);
    color: var(--text-dim);
    text-align: center;
}

.empty-state .material-symbols-outlined {
    font-size: 48px;
    opacity: 0.5;
}

.empty-state-small {
    color: var(--text-dim);
    font-size: 14px;
    padding: var(--spacing-md);
    text-align: center;
}

/* Modal styles (shared) */
.modal-small .modal-content {
    max-width: 400px;
}

.form-textarea {
    min-height: 80px;
    resize: vertical;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-md);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border);
}
</style>
{% endblock %}
