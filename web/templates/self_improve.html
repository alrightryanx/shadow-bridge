{% extends "base.html" %}

{% block title %}Self-Improvement - Shadow Web{% endblock %}

{% block page_title %}Self-Improvement{% endblock %}

{% block content %}
<div class="self-improve-container">
    <!-- Stats Overview -->
    <div class="stats-grid">
        <div class="stat-card">
            <span class="material-symbols-outlined stat-icon">bug_report</span>
            <div class="stat-content">
                <div class="stat-value" id="total-reports">-</div>
                <div class="stat-label">Total Reports</div>
            </div>
        </div>
        <div class="stat-card">
            <span class="material-symbols-outlined stat-icon">error</span>
            <div class="stat-content">
                <div class="stat-value" id="critical-count">-</div>
                <div class="stat-label">Critical/High</div>
            </div>
        </div>
        <div class="stat-card">
            <span class="material-symbols-outlined stat-icon">psychology</span>
            <div class="stat-content">
                <div class="stat-value" id="avg-confidence">-</div>
                <div class="stat-label">Avg Confidence</div>
            </div>
        </div>
        <div class="stat-card">
            <span class="material-symbols-outlined stat-icon">verified</span>
            <div class="stat-content">
                <div class="stat-value" id="prs-created">-</div>
                <div class="stat-label">PRs Created</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters-bar">
        <select id="severity-filter" class="filter-select" onchange="applyFilters()">
            <option value="">All Severities</option>
            <option value="CRITICAL">Critical</option>
            <option value="HIGH">High</option>
            <option value="MEDIUM">Medium</option>
            <option value="LOW">Low</option>
        </select>
        <select id="category-filter" class="filter-select" onchange="applyFilters()">
            <option value="">All Categories</option>
            <option value="CRASH">Crash</option>
            <option value="NETWORK">Network</option>
            <option value="PERFORMANCE">Performance</option>
            <option value="AI_LLM">AI/LLM</option>
            <option value="VOICE_AUDIO">Voice/Audio</option>
            <option value="INTEGRATION">Integration</option>
        </select>
        <select id="platform-filter" class="filter-select" onchange="applyFilters()">
            <option value="">All Platforms</option>
            <option value="PHONE">Phone</option>
            <option value="WEAR">Wear OS</option>
            <option value="AUTO">Android Auto</option>
            <option value="TV">Android TV</option>
        </select>
        <button class="btn btn-primary" onclick="refreshReports()">
            <span class="material-symbols-outlined">refresh</span> Refresh
        </button>
    </div>

    <!-- Reports List -->
    <div class="reports-container">
        <div class="section-header">
            <h2>Issue Reports</h2>
            <span class="report-count" id="report-count">Loading...</span>
        </div>
        <div class="reports-list" id="reports-list">
            <div class="loading-spinner">
                <span class="material-symbols-outlined spinning">sync</span>
                <span>Loading reports...</span>
            </div>
        </div>
    </div>

    <!-- Report Detail Modal -->
    <div id="report-modal" class="modal hidden">
        <div class="modal-content large">
            <div class="modal-header">
                <h2 id="modal-title">Report Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Filled by JavaScript -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" id="create-pr-btn" onclick="createPR()">
                    <span class="material-symbols-outlined">code</span> Create PR
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.self-improve-container {
    padding: 20px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: var(--shadow-sm);
}

.stat-icon {
    font-size: 40px;
    color: var(--primary);
}

.stat-value {
    font-size: 28px;
    font-weight: 600;
    color: var(--text-primary);
}

.stat-label {
    font-size: 14px;
    color: var(--text-secondary);
}

.filters-bar {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-select {
    padding: 10px 15px;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--card-bg);
    color: var(--text-primary);
    min-width: 150px;
}

.reports-container {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.section-header h2 {
    margin: 0;
    font-size: 18px;
}

.report-count {
    color: var(--text-secondary);
    font-size: 14px;
}

.reports-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.report-item {
    background: var(--bg);
    border-radius: 8px;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    transition: background 0.2s;
}

.report-item:hover {
    background: var(--hover-bg);
}

.report-info {
    flex: 1;
}

.report-type {
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 5px;
}

.report-meta {
    font-size: 13px;
    color: var(--text-secondary);
}

.report-badges {
    display: flex;
    gap: 8px;
    align-items: center;
}

.badge {
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.badge-critical { background: #ff4757; color: white; }
.badge-high { background: #ff6b6b; color: white; }
.badge-medium { background: #ffa502; color: black; }
.badge-low { background: #2ed573; color: black; }

.badge-platform {
    background: var(--primary);
    color: white;
}

.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 40px;
    color: var(--text-secondary);
}

.spinning {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal.hidden {
    display: none;
}

.modal-content.large {
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.detail-section {
    margin-bottom: 20px;
}

.detail-section h3 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.detail-content {
    background: var(--bg);
    padding: 15px;
    border-radius: 8px;
    font-family: monospace;
    white-space: pre-wrap;
    word-break: break-word;
}

.confidence-bar {
    height: 8px;
    background: var(--border);
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
}

.confidence-fill {
    height: 100%;
    background: var(--primary);
    border-radius: 4px;
}

.no-reports {
    text-align: center;
    padding: 40px;
    color: var(--text-secondary);
}
</style>

<script>
let allReports = [];
let currentReportId = null;

document.addEventListener('DOMContentLoaded', () => {
    loadStats();
    loadReports();
});

async function loadStats() {
    try {
        const response = await fetch('/api/self-improve/stats');
        const stats = await response.json();

        document.getElementById('total-reports').textContent = stats.total || 0;
        document.getElementById('critical-count').textContent =
            (stats.by_severity?.CRITICAL || 0) + (stats.by_severity?.HIGH || 0);
        document.getElementById('avg-confidence').textContent =
            stats.avg_confidence ? (stats.avg_confidence * 100).toFixed(0) + '%' : '-';
        document.getElementById('prs-created').textContent = stats.prs_created || 0;
    } catch (error) {
        console.error('Failed to load stats:', error);
    }
}

async function loadReports() {
    try {
        const response = await fetch('/api/self-improve/reports');
        const data = await response.json();
        allReports = data.reports || [];
        renderReports(allReports);
    } catch (error) {
        console.error('Failed to load reports:', error);
        document.getElementById('reports-list').innerHTML = `
            <div class="no-reports">
                <span class="material-symbols-outlined">cloud_off</span>
                <p>Failed to load reports</p>
            </div>
        `;
    }
}

function renderReports(reports) {
    const container = document.getElementById('reports-list');
    document.getElementById('report-count').textContent = `${reports.length} reports`;

    if (reports.length === 0) {
        container.innerHTML = `
            <div class="no-reports">
                <span class="material-symbols-outlined">check_circle</span>
                <p>No issues reported yet</p>
            </div>
        `;
        return;
    }

    container.innerHTML = reports.map(report => `
        <div class="report-item" onclick="showReportDetail('${report.reportId}')">
            <div class="report-info">
                <div class="report-type">${report.issueType || 'Unknown'}</div>
                <div class="report-meta">
                    ${report.component || 'Unknown'} 路
                    v${report.appVersion || '?'} 路
                    ${formatDate(report.timestamp)}
                </div>
            </div>
            <div class="report-badges">
                <span class="badge badge-${(report.severity || 'medium').toLowerCase()}">${report.severity || 'MEDIUM'}</span>
                <span class="badge badge-platform">${report.platform || 'PHONE'}</span>
                ${report.diagnosisConfidence ? `<span class="badge">${(report.diagnosisConfidence * 100).toFixed(0)}%</span>` : ''}
            </div>
        </div>
    `).join('');
}

function applyFilters() {
    const severity = document.getElementById('severity-filter').value;
    const category = document.getElementById('category-filter').value;
    const platform = document.getElementById('platform-filter').value;

    let filtered = allReports;
    if (severity) filtered = filtered.filter(r => r.severity === severity);
    if (category) filtered = filtered.filter(r => r.issueCategory === category);
    if (platform) filtered = filtered.filter(r => r.platform === platform);

    renderReports(filtered);
}

async function showReportDetail(reportId) {
    currentReportId = reportId;
    try {
        const response = await fetch(`/api/self-improve/reports/${reportId}`);
        const report = await response.json();

        document.getElementById('modal-title').textContent = report.issueType || 'Report Details';
        document.getElementById('modal-body').innerHTML = `
            <div class="detail-section">
                <h3>Description</h3>
                <div class="detail-content">${report.description || 'No description'}</div>
            </div>

            <div class="detail-section">
                <h3>Root Cause Analysis</h3>
                <div class="detail-content">${report.rootCauseAnalysis || 'No analysis available'}</div>
            </div>

            <div class="detail-section">
                <h3>Suggested Fix</h3>
                <div class="detail-content">${report.suggestedFix || 'No fix suggested'}</div>
            </div>

            ${report.fullStackTrace ? `
            <div class="detail-section">
                <h3>Stack Trace</h3>
                <div class="detail-content" style="font-size: 12px; max-height: 200px; overflow-y: auto;">${report.fullStackTrace}</div>
            </div>
            ` : ''}

            <div class="detail-section">
                <h3>Diagnosis Confidence</h3>
                <div class="confidence-bar">
                    <div class="confidence-fill" style="width: ${(report.diagnosisConfidence || 0) * 100}%"></div>
                </div>
                <div style="margin-top: 5px; font-size: 13px; color: var(--text-secondary);">
                    ${((report.diagnosisConfidence || 0) * 100).toFixed(0)}% 路 ${report.diagnosisBackend || 'Unknown'} 路 ${report.diagnosisModel || 'Unknown'}
                </div>
            </div>

            <div class="detail-section">
                <h3>Affected Files</h3>
                <div class="detail-content">${(report.affectedFiles || []).join('\n') || 'None identified'}</div>
            </div>

            <div class="detail-section">
                <h3>User Comment</h3>
                <div class="detail-content">${report.userComment || 'No comment provided'}</div>
            </div>
        `;

        document.getElementById('report-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Failed to load report detail:', error);
    }
}

function closeModal() {
    document.getElementById('report-modal').classList.add('hidden');
    currentReportId = null;
}

async function createPR() {
    if (!currentReportId) return;

    try {
        const btn = document.getElementById('create-pr-btn');
        btn.disabled = true;
        btn.innerHTML = '<span class="material-symbols-outlined spinning">sync</span> Creating...';

        const response = await fetch(`/api/self-improve/reports/${currentReportId}/create-pr`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.status === 'success') {
            alert('PR created successfully!\n\n' + (result.prUrl || ''));
            closeModal();
        } else {
            alert('Failed to create PR: ' + (result.message || 'Unknown error'));
        }
    } catch (error) {
        console.error('Failed to create PR:', error);
        alert('Failed to create PR');
    } finally {
        const btn = document.getElementById('create-pr-btn');
        btn.disabled = false;
        btn.innerHTML = '<span class="material-symbols-outlined">code</span> Create PR';
    }
}

function refreshReports() {
    loadStats();
    loadReports();
}

function formatDate(timestamp) {
    if (!timestamp) return 'Unknown';
    const date = new Date(timestamp);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}
</script>
{% endblock %}
