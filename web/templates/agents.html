{% extends "base.html" %}

{% block title %}Shadow Web - Agents{% endblock %}
{% block page_title %}Agents{% endblock %}

{% block content %}
<!-- Overview Section (Always Visible) -->
<section class="overview-section">
    <div class="overview-header">
        <h2 class="overview-title">Overview</h2>
        <div class="autonomous-controls" id="autonomous-controls">
            <span class="autonomous-status-badge" id="auto-status-badge">STOPPED</span>
            <button class="btn btn-small btn-primary" id="auto-start-btn" onclick="autonomousStart()">
                <span class="material-symbols-outlined">play_arrow</span>
                Start
            </button>
            <button class="btn btn-small btn-secondary" id="auto-pause-btn" onclick="autonomousPause()" style="display:none;">
                <span class="material-symbols-outlined">pause</span>
                Pause
            </button>
            <button class="btn btn-small btn-secondary" id="auto-resume-btn" onclick="autonomousResume()" style="display:none;">
                <span class="material-symbols-outlined">play_arrow</span>
                Resume
            </button>
            <button class="btn btn-small btn-danger" id="auto-stop-btn" onclick="autonomousStop()" style="display:none;">
                <span class="material-symbols-outlined">stop</span>
                Stop
            </button>
            <button class="btn btn-small" id="auto-scan-btn" onclick="autonomousScan()">
                <span class="material-symbols-outlined">search</span>
                Scan
            </button>
        </div>
    </div>
    <div class="overview-cards">
        <div class="overview-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">smart_toy</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-total-agents">0</div>
                <div class="overview-card-label">Total Agents</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon active">
                <span class="material-symbols-outlined">play_circle</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-active-agents">0</div>
                <div class="overview-card-label">Active</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">assignment</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-total-tasks">0</div>
                <div class="overview-card-label">Tasks</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon success">
                <span class="material-symbols-outlined">task_alt</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-completed-tasks">0</div>
                <div class="overview-card-label">Completed</div>
            </div>
        </div>
        <div class="overview-card" id="overview-cycle-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">autorenew</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-cycles">0</div>
                <div class="overview-card-label">Cycles</div>
            </div>
        </div>
        <div class="overview-card" id="overview-cost-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">payments</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-cost">$0.00</div>
                <div class="overview-card-label">Est. Cost</div>
            </div>
        </div>
    </div>
</section>

<!-- Now Running Strip -->
<section class="now-running">
    <div class="now-running-header">
        <h3>Now Running</h3>
        <span class="now-running-meta" id="now-running-meta">0 active</span>
    </div>
    <div class="now-running-list" id="now-running-list">
        <div class="empty-state-small">No active agents</div>
    </div>
</section>

<!-- Main Tabs (Android App Style) -->
<div class="main-tabs">
    <button class="tab-button active" data-tab="agents" onclick="switchMainTab('agents')">
        <span class="material-symbols-outlined">smart_toy</span>
        <span>Agents</span>
    </button>
    <button class="tab-button" data-tab="tasks" onclick="switchMainTab('tasks')">
        <span class="material-symbols-outlined">assignment</span>
        <span>Tasks</span>
        <span class="tab-count" id="tab-count-tasks">0</span>
    </button>
    <button class="tab-button" data-tab="monitor" onclick="switchMainTab('monitor')">
        <span class="material-symbols-outlined">monitor_heart</span>
        <span>Monitor</span>
        <span class="tab-count" id="tab-count-monitor">0</span>
    </button>
    <button class="tab-button" data-tab="briefings" onclick="switchMainTab('briefings'); loadBriefings();">
        <span class="material-symbols-outlined">summarize</span>
        <span>Briefings</span>
        <span class="tab-count" id="tab-count-briefings">0</span>
    </button>
    <button class="tab-button" data-tab="predictive" onclick="switchMainTab('predictive'); loadPredictiveTab();">
        <span class="material-symbols-outlined">psychology</span>
        <span>Predictive</span>
        <span class="tab-count" id="tab-count-predictive">0</span>
    </button>
</div>

<!-- Agents Tab -->
<div id="tab-agents" class="main-tab-content active">
    <div class="tab-header">
        <div class="tab-title-group">
            <h3>Active Agents</h3>
            <div class="connection-status" id="ws-connection-status">
                <span class="status-dot" id="ws-status-dot"></span>
                <span class="status-text" id="ws-status-text">Connecting...</span>
            </div>
        </div>
        <div class="tab-actions">
            <div class="search-field">
                <span class="material-symbols-outlined">search</span>
                <input type="search" id="agent-search" placeholder="Search agents...">
            </div>
            <button class="btn btn-secondary" onclick="openManageAgentsModal()">
                <span class="material-symbols-outlined">tune</span>
                Manage
            </button>
        </div>
    </div>

    <div class="agents-list-vertical" id="agents-list">
        <!-- Add Agent Card (Always First) -->
        <div class="agent-card add-agent-card horizontal">
            <div class="agent-card-header">
                <div class="agent-card-title">
                    <div class="agent-card-icon add-icon">
                        <span class="material-symbols-outlined">add_circle</span>
                    </div>
                    <div>
                        <h4>New Agent</h4>
                        <div class="agent-card-subtitle">Configure and spawn</div>
                    </div>
                </div>
            </div>

            <div class="add-agent-form">
                <div class="form-row-compact">
                    <div class="form-group-compact" style="flex: 1.5;">
                        <label class="form-label-compact">Agent Name</label>
                        <input type="text" id="inline-agent-name" class="form-input-compact" placeholder="e.g., Code Reviewer" required>
                        <div class="form-error" id="name-error"></div>
                    </div>
                    <div class="form-group-compact" style="flex: 1;">
                        <label class="form-label-compact">Specialty</label>
                        <select id="inline-agent-specialty" class="form-select-compact">
                            <option value="general">General Assistant</option>
                            <option value="code_review">Code Review</option>
                            <option value="testing">Testing</option>
                            <option value="documentation">Documentation</option>
                            <option value="refactoring">Refactoring</option>
                            <option value="debugging">Debugging</option>
                        </select>
                    </div>
                    <div class="form-group-compact" style="flex: 1.5;">
                        <label class="form-label-compact">Project</label>
                        <select id="inline-agent-project" class="form-select-compact" required>
                            <option value="">Select project...</option>
                        </select>
                        <div class="form-error" id="project-error"></div>
                    </div>
                </div>
                <div class="form-row-compact">
                    <div class="form-group-compact" style="flex: 1;">
                        <label class="form-label-compact">Provider</label>
                        <select id="inline-agent-provider" class="form-select-compact">
                            <option value="claude">Claude Code</option>
                            <option value="gemini">Gemini CLI</option>
                            <option value="codex">Codex</option>
                        </select>
                    </div>
                    <div class="form-group-compact" style="flex: 1.5;">
                        <label class="form-label-compact">Model</label>
                        <input type="text" id="inline-agent-model" class="form-input-compact" value="claude-sonnet-4-20250514">
                    </div>
                    <div class="form-group-compact" style="flex: 0 0 160px; justify-content: flex-end;">
                        <button class="btn btn-primary btn-block" id="spawn-agent-btn" onclick="confirmSpawnAgent()" style="margin-bottom: 0;">
                            <span class="material-symbols-outlined">rocket_launch</span>
                            <span id="spawn-btn-text">Spawn</span>
                        </button>
                    </div>
                </div>
                <div class="form-status" id="spawn-status"></div>
            </div>
        </div>
    </div>
</div>

<!-- Tasks Tab -->
<div id="tab-tasks" class="main-tab-content">
    <div class="tab-header">
        <div class="tab-title-group">
            <h3>Tasks</h3>
            <div class="tab-subtitle">Grouped by project</div>
        </div>
        <div class="tab-actions">
            <div class="search-field">
                <span class="material-symbols-outlined">search</span>
                <input type="search" id="task-search" placeholder="Search tasks...">
            </div>
            <button class="btn btn-secondary" id="generate-tasks-btn" onclick="generateProjectTasks()">
                <span class="material-symbols-outlined">auto_awesome</span>
                Generate Tasks
            </button>
            <button class="btn btn-primary" onclick="showCreateTaskModal()">
                <span class="material-symbols-outlined">add</span>
                New Task
            </button>
        </div>
    </div>

    <div class="task-summary-row">
        <div class="task-summary-item">
            <span class="task-summary-label">Pending</span>
            <span class="task-count" id="pending-count">0</span>
        </div>
        <div class="task-summary-item">
            <span class="task-summary-label">In Progress</span>
            <span class="task-count" id="progress-count">0</span>
        </div>
        <div class="task-summary-item">
            <span class="task-summary-label">Completed</span>
            <span class="task-count" id="completed-count">0</span>
        </div>
    </div>

    <div class="project-task-board" id="project-task-board">
        <div class="empty-column">No tasks yet</div>
    </div>
</div>

<!-- Monitor Tab -->
<div id="tab-monitor" class="main-tab-content">
    <div class="tab-header">
        <h3>Activity Monitor</h3>
        <div class="monitor-controls">
            <div class="search-field search-field-compact">
                <span class="material-symbols-outlined">search</span>
                <input type="search" id="monitor-search" placeholder="Search activity...">
            </div>
            <span class="live-indicator">
                <span class="pulse"></span>
                LIVE
            </span>
            <button class="btn btn-small" onclick="clearActivityFeed()">
                <span class="material-symbols-outlined">clear_all</span>
                Clear
            </button>
        </div>
    </div>

    <div class="monitor-grid">
        <div class="monitor-section">
            <h4>Activity Feed</h4>
            <div class="activity-filters">
                <div class="filter-group">
                    <span class="filter-label">Severity</span>
                    <div class="filter-chips" id="filter-severity">
                        <button class="chip active" data-filter="all">All</button>
                        <button class="chip" data-filter="info">Info</button>
                        <button class="chip" data-filter="success">Success</button>
                        <button class="chip" data-filter="warning">Warning</button>
                        <button class="chip" data-filter="error">Error</button>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Status</span>
                    <div class="filter-chips" id="filter-status">
                        <button class="chip active" data-filter="all">All</button>
                        <button class="chip" data-filter="assigned">Assigned</button>
                        <button class="chip" data-filter="completed">Completed</button>
                        <button class="chip" data-filter="failed">Failed</button>
                        <button class="chip" data-filter="build">Build</button>
                        <button class="chip" data-filter="deploy">Deploy</button>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Agent</span>
                    <select id="filter-agent" class="filter-select">
                        <option value="all">All agents</option>
                    </select>
                </div>
                <div class="filter-group">
                    <span class="filter-label">Repo</span>
                    <select id="filter-repo" class="filter-select">
                        <option value="all">All repos</option>
                    </select>
                </div>
            </div>
            <div class="activity-feed" id="activity-feed">
                <div class="empty-state-small">Waiting for agent activity...</div>
            </div>
        </div>
        <div class="monitor-section">
            <h4>Lock Status</h4>
            <div class="lock-list" id="lock-list">
                <div class="empty-state-small">Loading locks...</div>
            </div>
            <div class="lock-actions">
                <button class="btn btn-small btn-danger" onclick="releaseAllLocks()">
                    <span class="material-symbols-outlined">lock_open</span>
                    Release All Locks
                </button>
            </div>
        </div>
        <div class="monitor-section">
            <h4>Active Errors</h4>
            <div class="error-list" id="active-errors-list">
                <div class="empty-state-small">No active errors</div>
            </div>
        </div>
        <div class="monitor-section">
            <h4>System Health</h4>
            <div class="metrics-cards">
                <div class="metric-card">
                    <div class="metric-label">CPU Usage</div>
                    <div class="metric-value" id="metric-cpu">0%</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill" id="metric-cpu-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Memory</div>
                    <div class="metric-value" id="metric-memory">0 MB</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill" id="metric-memory-bar" style="width: 0%"></div>
                    </div>
                    <div class="metric-sub" id="metric-memory-detail"></div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Disk Free</div>
                    <div class="metric-value" id="metric-disk">--</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill" id="metric-disk-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Threads</div>
                    <div class="metric-value" id="metric-threads">0</div>
                    <div class="metric-sub" id="metric-threads-detail"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent Health Grid -->
    <div class="monitor-section" style="margin-top: var(--spacing-lg);">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--spacing-md);">
            <h4 style="margin: 0;">Agent Health Grid</h4>
            <div class="agent-grid-legend">
                <span class="legend-item"><span class="legend-dot" style="background: var(--success);"></span>Idle</span>
                <span class="legend-item"><span class="legend-dot" style="background: var(--accent);"></span>Working</span>
                <span class="legend-item"><span class="legend-dot" style="background: var(--error);"></span>Crashed</span>
                <span class="legend-item"><span class="legend-dot" style="background: var(--text-dim);"></span>Offline</span>
            </div>
        </div>
        <div class="agent-health-grid" id="agent-health-grid">
            <div class="empty-state-small">No agents to display</div>
        </div>
    </div>

    <!-- Task Pipeline + Cost + Alerts in 3-col grid -->
    <div class="monitor-3col" style="margin-top: var(--spacing-lg);">
        <div class="monitor-section">
            <h4>Task Pipeline</h4>
            <div class="pipeline-funnel" id="task-pipeline">
                <div class="pipeline-stage">
                    <div class="pipeline-bar" style="width: 100%;">
                        <span class="pipeline-label">Scanned</span>
                        <span class="pipeline-count" id="pipeline-scanned">0</span>
                    </div>
                </div>
                <div class="pipeline-stage">
                    <div class="pipeline-bar queued" style="width: 80%;">
                        <span class="pipeline-label">Queued</span>
                        <span class="pipeline-count" id="pipeline-queued">0</span>
                    </div>
                </div>
                <div class="pipeline-stage">
                    <div class="pipeline-bar assigned" style="width: 60%;">
                        <span class="pipeline-label">Assigned</span>
                        <span class="pipeline-count" id="pipeline-assigned">0</span>
                    </div>
                </div>
                <div class="pipeline-stage">
                    <div class="pipeline-bar completed" style="width: 40%;">
                        <span class="pipeline-label">Completed</span>
                        <span class="pipeline-count" id="pipeline-completed">0</span>
                    </div>
                </div>
                <div class="pipeline-stage">
                    <div class="pipeline-bar failed" style="width: 20%;">
                        <span class="pipeline-label">Failed</span>
                        <span class="pipeline-count" id="pipeline-failed">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="monitor-section">
            <h4>Cost Tracker</h4>
            <div class="cost-tracker" id="cost-tracker">
                <div class="cost-row">
                    <span class="cost-label">Estimated Today</span>
                    <span class="cost-value" id="cost-today">$0.00</span>
                </div>
                <div class="cost-row">
                    <span class="cost-label">Tasks Completed</span>
                    <span class="cost-value" id="cost-tasks">0</span>
                </div>
                <div class="cost-row">
                    <span class="cost-label">Avg Cost/Task</span>
                    <span class="cost-value" id="cost-per-task">$0.00</span>
                </div>
                <div class="cost-row" id="cost-budget-row" style="display: none;">
                    <span class="cost-label">Budget Remaining</span>
                    <span class="cost-value" id="cost-budget">--</span>
                </div>
            </div>
        </div>

        <div class="monitor-section">
            <h4>Alerts</h4>
            <div class="alert-feed" id="alert-feed">
                <div class="empty-state-small">No active alerts</div>
            </div>
        </div>
    </div>

    <!-- Build History Section -->
    <div class="monitor-section" style="margin-top: var(--spacing-lg);">
        <h4>Build History</h4>
        <div class="build-history" id="build-history">
            <div class="empty-state-small">No builds yet</div>
        </div>
    </div>

    <!-- Deploy Log Section -->
    <div class="monitor-section" style="margin-top: var(--spacing-lg);">
        <h4>Deploy Log</h4>
        <div class="deploy-log" id="deploy-log">
            <div class="empty-state-small">No deploys yet</div>
        </div>
    </div>
</div>

<!-- Briefings Tab -->
<div id="tab-briefings" class="main-tab-content">
    <div class="tab-header">
        <h3>Briefings</h3>
        <div class="tab-actions">
            <button class="btn btn-secondary" onclick="loadBriefings()">
                <span class="material-symbols-outlined">refresh</span>
                Refresh
            </button>
            <button class="btn btn-secondary" onclick="markAllBriefingsRead()">
                <span class="material-symbols-outlined">done_all</span>
                Mark All Read
            </button>
        </div>
    </div>

    <div class="briefings-list" id="briefings-list">
        <div class="empty-state-small">Loading briefings...</div>
    </div>
</div>

<!-- Predictive Tab -->
<div id="tab-predictive" class="main-tab-content">
    <div class="tab-header">
        <h3>Predictive System</h3>
        <div class="tab-actions">
            <button class="btn btn-secondary" onclick="loadPredictiveTab()">
                <span class="material-symbols-outlined">refresh</span>
                Refresh
            </button>
        </div>
    </div>

    <!-- Predictive Overview Cards -->
    <div class="overview-cards" id="predictive-overview" style="margin-bottom: 1.5rem;">
        <div class="overview-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">event_repeat</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="pred-routines-count">0</div>
                <div class="overview-card-label">Routines</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon active">
                <span class="material-symbols-outlined">auto_awesome</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="pred-predictions-count">0</div>
                <div class="overview-card-label">Predictions</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon success">
                <span class="material-symbols-outlined">all_inclusive</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="pred-loops-count">0</div>
                <div class="overview-card-label">Loops Run</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">speed</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="pred-loop-success-rate">-</div>
                <div class="overview-card-label">Loop Success</div>
            </div>
        </div>
    </div>

    <!-- Sub-tabs for Routines / Predictions / Loops -->
    <div class="main-tabs" style="margin-bottom: 1rem;">
        <button class="tab-button active" data-subtab="routines" onclick="switchPredictiveSubTab('routines')">
            <span class="material-symbols-outlined">event_repeat</span>
            <span>Routines</span>
        </button>
        <button class="tab-button" data-subtab="predictions" onclick="switchPredictiveSubTab('predictions')">
            <span class="material-symbols-outlined">auto_awesome</span>
            <span>Predictions</span>
        </button>
        <button class="tab-button" data-subtab="loops" onclick="switchPredictiveSubTab('loops')">
            <span class="material-symbols-outlined">all_inclusive</span>
            <span>Loops</span>
        </button>
    </div>

    <!-- Routines Sub-tab -->
    <div id="subtab-routines" class="predictive-subtab active">
        <div class="tab-header" style="margin-bottom: 1rem;">
            <h4>Scheduled Routines</h4>
            <button class="btn btn-primary btn-small" onclick="openCreateRoutineModal()">
                <span class="material-symbols-outlined">add</span>
                New Routine
            </button>
        </div>
        <div id="routines-list" class="briefings-list">
            <div class="empty-state-small">Loading routines...</div>
        </div>
    </div>

    <!-- Predictions Sub-tab -->
    <div id="subtab-predictions" class="predictive-subtab" style="display: none;">
        <h4 style="margin-bottom: 1rem;">Recent Predictions</h4>
        <div id="predictions-list" class="briefings-list">
            <div class="empty-state-small">Loading predictions...</div>
        </div>
    </div>

    <!-- Loops Sub-tab -->
    <div id="subtab-loops" class="predictive-subtab" style="display: none;">
        <h4 style="margin-bottom: 1rem;">Loop Execution History</h4>
        <div id="loops-list" class="briefings-list">
            <div class="empty-state-small">Loading loop history...</div>
        </div>
    </div>
</div>

<!-- Create Routine Modal -->
<div id="create-routine-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <span class="material-symbols-outlined">event_repeat</span>
                Create Routine
            </h2>
            <button class="modal-close" onclick="closeCreateRoutineModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Routine Name</label>
                <input type="text" id="routine-name" class="form-input" placeholder="e.g., Daily Security Scan">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="routine-description" class="form-textarea" rows="2" placeholder="What does this routine do?"></textarea>
            </div>
            <div class="form-group">
                <label>Schedule (Cron)</label>
                <input type="text" id="routine-cron" class="form-input" placeholder="0 9 * * *">
                <div class="form-hint">Examples: "0 9 * * *" (daily 9am), "0 9 * * 1" (Monday 9am), "0 * * * *" (hourly)</div>
            </div>
            <div class="form-group">
                <label>Task Prompt</label>
                <textarea id="routine-prompt" class="form-textarea" rows="3" placeholder="The prompt that will be sent to the agent..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Category</label>
                    <select id="routine-category" class="form-select">
                        <option value="general">General</option>
                        <option value="security">Security</option>
                        <option value="testing">Testing</option>
                        <option value="code_review">Code Review</option>
                        <option value="maintenance">Maintenance</option>
                        <option value="reporting">Reporting</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Priority (1-10)</label>
                    <input type="number" id="routine-priority" class="form-input" value="5" min="1" max="10">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateRoutineModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmCreateRoutine()">
                <span class="material-symbols-outlined">check</span>
                Create
            </button>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Create Task Modal -->
<div id="create-task-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <span class="material-symbols-outlined">add_task</span>
                Create Task
            </h2>
            <button class="modal-close" onclick="closeCreateTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Task Title</label>
                <input type="text" id="task-title" class="form-input" placeholder="e.g., Refactor authentication">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="task-description" class="form-textarea" rows="3" placeholder="Task details..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Priority</label>
                    <select id="task-priority" class="form-select">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Assign To</label>
                    <select id="task-agent" class="form-select">
                        <option value="">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateTaskModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmCreateTask()">
                <span class="material-symbols-outlined">check</span>
                Create
            </button>
        </div>
    </div>
</div>

<!-- Assign Task Modal -->
<div id="assign-task-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>
                <span class="material-symbols-outlined">assignment</span>
                Assign Task
            </h2>
            <button class="modal-close" onclick="closeAssignTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Task Description</label>
                <textarea id="assign-task-input" class="form-textarea" rows="4" placeholder="Describe what the agent should do..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAssignTaskModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAssignTask()">
                <span class="material-symbols-outlined">send</span>
                Assign
            </button>
        </div>
    </div>
</div>

<!-- Manage Agents Modal -->
<div id="manage-agents-modal" class="modal hidden">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>
                <span class="material-symbols-outlined">tune</span>
                Manage Agents
            </h2>
            <button class="modal-close" onclick="closeManageAgentsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="manage-toolbar">
                <label class="manage-select-all">
                    <input type="checkbox" id="manage-select-all">
                    Select all
                </label>
                <div class="search-field search-field-compact">
                    <span class="material-symbols-outlined">search</span>
                    <input type="search" id="manage-agent-search" placeholder="Filter agents...">
                </div>
            </div>
            <div class="manage-agent-list" id="manage-agent-list"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeManageAgentsModal()">Close</button>
            <button class="btn btn-secondary" onclick="manageRefreshSelected()">Refresh</button>
            <button class="btn btn-secondary" onclick="managePauseSelected()">Pause</button>
            <button class="btn btn-danger" onclick="manageStopSelected()">Stop</button>
            <button class="btn btn-danger" onclick="manageReleaseLocksSelected()">Release Locks</button>
        </div>
    </div>
</div>

<!-- Agent Detail Drawer -->
<div id="agent-detail-drawer" class="agent-drawer hidden">
    <div class="agent-drawer-overlay" onclick="closeAgentDrawer()"></div>
    <div class="agent-drawer-panel">
        <div class="agent-drawer-header">
            <div class="agent-drawer-title">
                <h3 id="agent-drawer-name">Agent</h3>
                <div class="agent-drawer-subtitle" id="agent-drawer-subtitle">Idle</div>
            </div>
            <button class="drawer-close" onclick="closeAgentDrawer()">&times;</button>
        </div>
        <div class="agent-drawer-body">
            <div class="agent-drawer-section">
                <h4>Summary</h4>
                <div class="agent-drawer-stats" id="agent-drawer-stats"></div>
            </div>
            <div class="agent-drawer-section">
                <h4>Timeline</h4>
                <div class="agent-drawer-timeline" id="agent-drawer-timeline">
                    <div class="empty-state-small">No recent activity</div>
                </div>
            </div>
            <div class="agent-drawer-section">
                <h4>Outputs</h4>
                <div class="agent-drawer-outputs" id="agent-drawer-outputs">
                    <div class="empty-state-small">No output captured</div>
                </div>
            </div>
            <div class="agent-drawer-section">
                <h4>Files Touched</h4>
                <div class="agent-drawer-files" id="agent-drawer-files">
                    <div class="empty-state-small">No files reported yet</div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Dashboard Theme Compatibility */
:root {
    --bg: var(--md-sys-color-surface);
    --bg-hover: var(--md-sys-color-surface-variant);
    --border: var(--md-sys-color-outline-variant);
    --text: var(--md-sys-color-on-surface);
    --text-dim: var(--md-sys-color-on-surface-variant);
    --warning: var(--md-sys-color-tertiary);
    --error: var(--md-sys-color-error);
    --success: #4caf50;
    --accent: var(--md-sys-color-primary);
}

.overview-section {
    margin-bottom: var(--spacing-xl);
}

.overview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.overview-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text);
    margin: 0;
}

/* Autonomous Controls */
.autonomous-controls {
    display: flex;
    align-items: center;
    gap: 8px;
}

.autonomous-status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--text-dim);
    color: var(--bg);
}

.autonomous-status-badge.running {
    background: var(--success);
    color: white;
    animation: pulse-anim 2s infinite;
}

.autonomous-status-badge.paused {
    background: var(--warning);
    color: var(--bg);
}

.autonomous-status-badge.stopped {
    background: var(--text-dim);
    color: var(--bg);
}

/* Build History */
.build-history {
    max-height: 400px;
    overflow-y: auto;
}

.build-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-sm) var(--spacing-md);
    border-bottom: 1px solid var(--border);
}

.build-item:last-child {
    border-bottom: none;
}

.build-status-icon {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.build-status-icon.success {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success);
}

.build-status-icon.failed {
    background: rgba(239, 68, 68, 0.15);
    color: var(--error);
}

.build-status-icon .material-symbols-outlined {
    font-size: 18px;
}

.build-info {
    flex: 1;
}

.build-info-title {
    font-weight: 600;
    font-size: 0.9rem;
}

.build-info-meta {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-top: 2px;
}

/* Deploy Log */
.deploy-log {
    max-height: 300px;
    overflow-y: auto;
}

.deploy-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: 6px var(--spacing-md);
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
}

.deploy-item .material-symbols-outlined {
    font-size: 16px;
}

.deploy-item.success .material-symbols-outlined {
    color: var(--success);
}

.deploy-item.failed .material-symbols-outlined {
    color: var(--error);
}

/* Task category badges */
.category-badge {
    padding: 2px 8px;
    border-radius: 8px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.category-badge.todo { background: #4f46e5; color: white; }
.category-badge.smell { background: #f59e0b; color: #1a1a1a; }
.category-badge.error_handling { background: #ef4444; color: white; }
.category-badge.performance { background: #06b6d4; color: #1a1a1a; }
.category-badge.test_gap { background: #8b5cf6; color: white; }

.scope-badge {
    padding: 2px 6px;
    border-radius: 6px;
    font-size: 0.65rem;
    font-weight: 500;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    text-transform: uppercase;
}

.task-file-path {
    font-size: 0.65rem;
    color: var(--text-muted);
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.overview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
}

.overview-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    transition: all 0.2s ease;
}

.overview-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
}

.overview-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--accent-container);
    display: flex;
    align-items: center;
    justify-content: center;
}

.overview-card-icon span {
    font-size: 28px;
    color: var(--accent);
}

.overview-card-icon.active span {
    color: var(--success);
}

.overview-card-icon.success span {
    color: var(--success);
}

.overview-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
}

.overview-card-label {
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-top: 4px;
}

/* Main Tabs (Android Style) */
.main-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: var(--spacing-lg);
    border-bottom: 2px solid var(--border);
    padding-bottom: 0;
}

.tab-button {
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    padding: var(--spacing-md) var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dim);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    bottom: -2px;
}

.tab-button:hover {
    color: var(--text);
    background: var(--bg-hover);
}

.tab-button.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

.tab-button .material-symbols-outlined {
    font-size: 22px;
}

/* Tab Content */
.main-tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.main-tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.tab-header h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text);
}

.tab-count {
    margin-left: 6px;
    background: var(--accent-container);
    color: var(--accent);
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 999px;
    font-weight: 700;
}

.tab-title-group {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.tab-subtitle {
    font-size: 0.8rem;
    color: var(--text-dim);
}

.tab-actions {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
}

.search-field {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-dim);
}

.search-field input {
    border: none;
    outline: none;
    background: transparent;
    color: var(--text);
    width: 180px;
}

.search-field-compact input {
    width: 140px;
}

.search-field .material-symbols-outlined {
    font-size: 18px;
}

/* Now Running */
.now-running {
    margin: var(--spacing-lg) 0;
    padding: var(--spacing-md);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    background: var(--bg-card);
}

.now-running-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
}

.now-running-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.now-running-meta {
    font-size: 0.8rem;
    color: var(--text-dim);
}

.now-running-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: var(--spacing-md);
}

.now-running-card {
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: var(--spacing-sm);
    background: var(--bg-hover);
}

.now-running-card h4 {
    margin: 0 0 4px 0;
    font-size: 0.95rem;
}

.now-running-task {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 8px;
}

.now-running-progress {
    height: 6px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
}

.now-running-progress span {
    display: block;
    height: 100%;
    background: var(--accent);
}

/* Agent list */
.agent-section-label {
    margin: var(--spacing-md) 0 var(--spacing-sm);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
}

.agent-title-row {
    display: flex;
    align-items: center;
    gap: 6px;
}

.agent-pin-btn {
    background: transparent;
    border: none;
    cursor: pointer;
    color: var(--text-dim);
    padding: 4px;
    border-radius: 6px;
}

.agent-pin-btn.pinned {
    color: var(--accent);
}

.agent-progress {
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.agent-progress-bar {
    height: 6px;
    background: var(--border);
    border-radius: 999px;
    overflow: hidden;
}

.agent-progress-bar span {
    display: block;
    height: 100%;
    background: var(--accent);
}

.agent-progress-text {
    font-size: 0.75rem;
    color: var(--text-dim);
}

.agent-card-actions .btn-icon-small {
    padding: 4px;
}

.agent-card.pinned {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent);
}

/* Activity filters */
.activity-filters {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
}

.filter-group {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
}

.filter-label {
    font-size: 0.75rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.4px;
}

.filter-chips {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
}

.chip {
    border: 1px solid var(--border);
    background: var(--bg-card);
    color: var(--text-dim);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    cursor: pointer;
}

.chip.active {
    background: var(--accent-container);
    color: var(--accent);
    border-color: transparent;
}

.filter-select {
    border-radius: 999px;
    border: 1px solid var(--border);
    padding: 4px 10px;
    background: var(--bg-card);
    color: var(--text);
    font-size: 0.75rem;
}

.activity-stack {
    margin-left: 8px;
    font-size: 0.7rem;
    color: var(--text-dim);
    cursor: pointer;
}

.activity-stack-details {
    margin-top: 6px;
    font-size: 0.75rem;
    color: var(--text-dim);
}

.activity-stack-details.hidden {
    display: none;
}

/* Error panel */
.error-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.85rem;
}

.error-item {
    background: var(--bg-hover);
    border: 1px solid var(--border);
    border-left: 3px solid var(--error);
    border-radius: var(--radius-md);
    padding: 8px 10px;
}

.error-item-header {
    display: flex;
    justify-content: space-between;
    font-weight: 600;
}

.error-item-meta {
    font-size: 0.75rem;
    color: var(--text-dim);
}

/* Task build summary */
.task-build-summary {
    margin-top: 8px;
    padding: 6px 8px;
    border-radius: var(--radius-md);
    font-size: 0.7rem;
    background: var(--bg-card);
    border: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 6px;
}

.task-build-summary.success {
    border-left: 3px solid var(--success);
}

.task-build-summary.failed {
    border-left: 3px solid var(--error);
}

/* Manage agents modal */
.manage-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-md);
    flex-wrap: wrap;
}

.manage-agent-list {
    max-height: 320px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.manage-agent-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-sm);
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--bg-hover);
}

.manage-agent-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.manage-agent-meta {
    font-size: 0.75rem;
    color: var(--text-dim);
}

/* Agent drawer */
.agent-drawer {
    position: fixed;
    inset: 0;
    z-index: 50;
}

.agent-drawer.hidden {
    display: none;
}

.agent-drawer-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.4);
}

.agent-drawer-panel {
    position: absolute;
    right: 0;
    top: 0;
    height: 100%;
    width: min(420px, 95vw);
    background: var(--bg);
    border-left: 1px solid var(--border);
    padding: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    overflow-y: auto;
}

.agent-drawer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.agent-drawer-title h3 {
    margin: 0;
}

.agent-drawer-subtitle {
    font-size: 0.8rem;
    color: var(--text-dim);
}

.drawer-close {
    background: transparent;
    border: none;
    font-size: 1.4rem;
    cursor: pointer;
    color: var(--text-dim);
}

.agent-drawer-section h4 {
    margin: 0 0 var(--spacing-sm) 0;
    font-size: 0.95rem;
}

.agent-drawer-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    font-size: 0.8rem;
}

.agent-drawer-stat {
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--bg-hover);
}

.agent-drawer-timeline,
.agent-drawer-outputs,
.agent-drawer-files {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 0.8rem;
}

.agent-drawer-entry {
    padding: 6px 8px;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--bg-hover);
}

.agent-drawer-entry small {
    color: var(--text-dim);
}

.modal-content.modal-large {
    max-width: 640px;
}

/* Agents Vertical (Card Style) */
.agents-list-vertical {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    padding-bottom: var(--spacing-lg);
    width: 100%;
}

.agent-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md) var(--spacing-lg);
    display: flex;
    flex-direction: row;
    align-items: center;
    justify-content: space-between;
    gap: var(--spacing-lg);
    transition: all 0.2s ease;
    min-height: 80px;
}

.agent-card:hover {
    border-color: var(--accent);
    background: var(--bg-hover);
}

.agent-card-header {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex: 0 0 320px;
}

.agent-card-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
}

.agent-card-icon {
    width: 44px;
    height: 44px;
    border-radius: 12px;
    background: var(--accent-container);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.agent-card-icon span {
    font-size: 24px;
    color: var(--accent);
}

.agent-card-title h4 {
    margin: 0;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--text);
}

.agent-card-subtitle {
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
}

.agent-badges {
    display: flex;
    gap: 4px;
    margin-top: 4px;
}

.agent-metrics {
    display: flex;
    align-items: center;
    gap: var(--spacing-lg);
    flex: 1;
    justify-content: center;
}

.agent-metric {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
    color: var(--text-dim);
    white-space: nowrap;
}

.agent-metric span.material-symbols-outlined {
    font-size: 18px;
    color: var(--accent);
}

.agent-card-right {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex: 0 0 auto;
}

.agent-card-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.agent-current-task {
    flex: 1;
    max-width: 400px;
    padding: 6px 12px;
    background: var(--bg-hover);
    border-left: 3px solid var(--warning);
    border-radius: 4px;
    font-size: 0.85rem;
    margin: 0 var(--spacing-md);
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.agent-current-task strong {
    font-size: 0.75rem;
    color: var(--text-dim);
    margin-right: 4px;
    text-transform: uppercase;
}

/* Mobile responsive adjustments */
@media (max-width: 1024px) {
    .agent-card {
        flex-direction: column;
        align-items: stretch;
        gap: var(--spacing-sm);
        padding: var(--spacing-md);
    }
    
    .agent-card-header, .agent-metrics, .agent-card-right {
        flex: none;
        width: 100%;
        justify-content: space-between;
    }
    
    .agent-current-task {
        max-width: 100%;
        margin: var(--spacing-xs) 0;
    }
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.02em;
}

.status-badge.idle { background: rgba(158, 158, 158, 0.1); color: var(--text-dim); }
.status-badge.busy { background: rgba(255, 152, 0, 0.1); color: #ff9800; }
.status-badge.active { background: rgba(76, 175, 80, 0.1); color: #4caf50; }
.status-badge.running { background: rgba(33, 150, 243, 0.1); color: #2196f3; }
.status-badge.failed { background: rgba(244, 67, 54, 0.1); color: #f44336; }
.status-badge.offline { background: rgba(0, 0, 0, 0.2); color: var(--text-dim); }


.agent-metrics {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    background: var(--bg-hover);
    border-radius: var(--radius-md);
}

.agent-metric {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85rem;
    color: var(--text-dim);
}

.agent-metric span.material-symbols-outlined {
    font-size: 16px;
}

.agent-current-task {
    padding: var(--spacing-sm);
    background: var(--bg-hover);
    border-left: 3px solid var(--warning);
    border-radius: var(--radius-md);
}

.agent-current-task strong {
    display: block;
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 4px;
}

.agent-card-actions {
    display: flex;
    gap: var(--spacing-xs);
}

.status-badge {
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    white-space: nowrap;
}

/* Add Agent Card (Inline) */
.add-agent-card {
    border: 1px dashed var(--border);
    background: var(--bg-hover);
    padding: var(--spacing-md) var(--spacing-lg);
}

.add-agent-card:hover {
    border-color: var(--accent);
    background: var(--bg-card);
}

.add-agent-card .agent-card-header {
    flex: 0 0 240px;
}

.add-agent-card .agent-card-icon.add-icon {
    background: transparent;
    border: 2px dashed var(--accent);
}

.add-agent-card .agent-card-icon.add-icon span {
    color: var(--accent);
}

.add-agent-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex: 1;
}

.form-row-compact {
    display: flex;
    gap: var(--spacing-md);
    width: 100%;
}

.form-group-compact {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.form-label-compact {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 2px;
}

.form-error {
    font-size: 0.75rem;
    color: var(--error);
    margin-top: 4px;
    display: none;
}

.form-error.visible {
    display: block;
}

.form-status {
    padding: 8px 12px;
    border-radius: var(--radius-md);
    font-size: 0.85rem;
    margin-top: 8px;
    display: none;
}

.form-status.visible {
    display: block;
}

.form-status.success {
    background: rgba(var(--success-rgb), 0.15);
    color: var(--success);
    border: 1px solid rgba(var(--success-rgb), 0.3);
}

.form-status.error {
    background: rgba(var(--error-rgb), 0.15);
    color: var(--error);
    border: 1px solid rgba(var(--error-rgb), 0.3);
}

.form-status.info {
    background: rgba(var(--accent-rgb), 0.15);
    color: var(--accent);
    border: 1px solid rgba(var(--accent-rgb), 0.3);
}

.form-input-compact,
.form-select-compact {
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    background: var(--bg-card);
    color: var(--text);
    font-size: 0.9rem;
    font-family: inherit;
    transition: all 0.2s ease;
}

.form-input-compact:focus,
.form-select-compact:focus {
    outline: none;
    border-color: var(--accent);
    background: var(--bg);
}

/* Fix dropdown option text visibility */
.form-select-compact option {
    background: var(--bg-card);
    color: var(--text);
    padding: 8px;
}

.form-input-compact::placeholder {
    color: var(--text-dim);
    opacity: 0.7;
}

.form-row-compact {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-sm);
}

.btn-block {
    width: 100%;
    justify-content: center;
}

.btn-block:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.btn-block.loading {
    position: relative;
}

.btn-block.loading .material-symbols-outlined {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

/* Connection Status */
.connection-status {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--warning);
    animation: pulse-anim 1.5s infinite;
}

.status-dot.connected {
    background: var(--success);
    animation: none;
}

.status-dot.disconnected {
    background: var(--error);
    animation: none;
}

.status-text {
    font-size: 0.85rem;
    color: var(--text-dim);
    font-weight: 500;
}

.status-text.connected {
    color: var(--success);
}

.status-text.disconnected {
    color: var(--error);
}

/* Task Board */
.task-summary-row {
    display: flex;
    gap: var(--spacing-md);
    flex-wrap: wrap;
    margin-bottom: var(--spacing-md);
}

.task-summary-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
}

.task-summary-label {
    font-size: 0.85rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.4px;
}

.project-task-board {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.task-project {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-md);
}

.task-project-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
}

.task-project-title {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.task-project-title h4 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
}

.task-project-meta {
    font-size: 0.8rem;
    color: var(--text-dim);
}

.task-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-lg);
}

.task-board-compact {
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: var(--spacing-md);
}

@media (max-width: 1024px) {
    .task-board {
        grid-template-columns: 1fr;
    }
}

.task-column {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    display: flex;
    flex-direction: column;
    min-height: 400px;
}

.task-board-compact .task-column {
    min-height: 260px;
}

.task-board-compact .task-column-header {
    padding: var(--spacing-sm);
}

.task-column-header {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-hover);
}

.task-column-header h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-dim);
}

.task-count {
    background: var(--accent-container);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
}

.task-list {
    padding: var(--spacing-md);
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.task-card {
    background: var(--bg-hover);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    cursor: pointer;
    transition: all 0.2s ease;
}

.task-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
}

.task-card.priority-high {
    border-left-color: var(--error);
}

.task-card.priority-urgent {
    border-left-color: #ff1744;
}

.task-card-header-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 8px;
}

.task-delete-btn {
    background: transparent;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 2px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    opacity: 0;
}

.task-card:hover .task-delete-btn {
    opacity: 1;
}

.task-delete-btn:hover {
    color: var(--error);
    background: rgba(239, 68, 68, 0.1);
}

.task-delete-btn .material-symbols-outlined {
    font-size: 18px;
}

.task-card-title {
    font-weight: 600;
    margin-bottom: 8px;
    flex: 1;
}

.task-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    font-size: 0.75rem;
    color: var(--text-dim);
}

/* Monitor Grid */
.monitor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
}

@media (max-width: 1024px) {
    .monitor-grid {
        grid-template-columns: 1fr;
    }
}

.monitor-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.monitor-section h4 {
    margin: 0 0 var(--spacing-md) 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.activity-feed {
    max-height: 500px;
    overflow-y: auto;
    font-family: var(--font-mono);
    font-size: 0.85rem;
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.activity-item {
    padding: 8px 12px;
    border-left: 4px solid var(--text-dim);
    background: var(--bg-card);
    margin-bottom: 4px;
    border-radius: 4px;
    animation: slide-in 0.3s ease-out;
}

.activity-item.info { border-left-color: var(--accent); }
.activity-item.success { border-left-color: var(--success); }
.activity-item.warning { border-left-color: var(--warning); }
.activity-item.error { border-left-color: var(--error); }
.activity-item.debug { border-left-color: var(--text-dim); opacity: 0.8; }

.activity-time {
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-bottom: 4px;
}

.activity-text {
    display: flex;
    align-items: center;
    gap: 6px;
}

.activity-details {
    margin-top: 6px;
    font-size: 0.75rem;
    color: var(--text-dim);
    display: flex;
    flex-direction: column;
    gap: 2px;
}

@keyframes slide-in {
    from { transform: translateX(-10px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

.metrics-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
}

.metric-card {
    padding: var(--spacing-md);
    background: var(--bg-hover);
    border-radius: var(--radius-md);
}

.metric-label {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-bottom: 8px;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
}

.metric-bar {
    height: 4px;
    background: var(--bg-card);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
}

.metric-bar-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s ease;
}

.live-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--success);
    font-weight: 600;
    font-size: 0.9rem;
}

.pulse {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse-anim 1.5s infinite;
}

@keyframes pulse-anim {
    0%, 100% { transform: scale(0.95); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
}

.monitor-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-dim);
}

.empty-state .material-symbols-outlined {
    font-size: 64px;
    color: var(--text-dim);
    margin-bottom: var(--spacing-md);
}

.empty-state p {
    margin: var(--spacing-md) 0;
    font-size: 1.1rem;
}

.empty-state-small {
    text-align: center;
    padding: var(--spacing-md);
    color: var(--text-dim);
    font-size: 0.9rem;
}

/* Form Styles */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Responsive */
@media (max-width: 768px) {
    .overview-cards {
        grid-template-columns: repeat(2, 1fr);
    }

    .agents-list-vertical {
        gap: var(--spacing-sm);
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .main-tabs {
        overflow-x: auto;
    }

    .tab-button span:not(.material-symbols-outlined) {
        display: none;
    }
}

/* Briefings Tab */
.briefings-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.briefing-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    transition: border-color 0.2s;
    animation: slide-in 0.3s ease-out;
}

.briefing-card:hover {
    border-color: var(--accent);
}

.briefing-card.unread {
    border-left: 4px solid var(--accent);
}

.briefing-card.priority-high {
    border-left: 4px solid var(--warning);
}

.briefing-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: var(--spacing-sm);
}

.briefing-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.briefing-meta {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
    font-size: 0.75rem;
    color: var(--text-dim);
}

.briefing-badge {
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

.briefing-badge.daily { background: var(--accent); color: var(--bg); }
.briefing-badge.weekly { background: var(--success); color: var(--bg); }
.briefing-badge.insight { background: var(--warning); color: var(--bg); }
.briefing-badge.monthly { background: var(--text-dim); color: var(--bg); }

.briefing-summary {
    font-size: 0.9rem;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: var(--spacing-md);
    white-space: pre-wrap;
}

.briefing-sections {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.briefing-section {
    background: var(--bg-hover);
    border-radius: var(--radius-md);
    padding: var(--spacing-sm) var(--spacing-md);
}

.briefing-section-title {
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.briefing-section-content {
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.briefing-metrics {
    display: flex;
    gap: var(--spacing-md);
    margin-top: 6px;
}

.briefing-metric {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.briefing-metric.completed { color: var(--success); }
.briefing-metric.review { color: var(--warning); }
.briefing-metric.blocked { color: var(--error); }

.briefing-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-sm);
    margin-top: var(--spacing-md);
    padding-top: var(--spacing-sm);
    border-top: 1px solid var(--border);
}

.briefing-actions button {
    padding: 4px 12px;
    font-size: 0.8rem;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border);
    background: var(--bg-hover);
    color: var(--text-secondary);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 4px;
}

.briefing-actions button:hover {
    background: var(--accent);
    color: var(--bg);
    border-color: var(--accent);
}

.briefing-actions button .material-symbols-outlined {
    font-size: 16px;
}

/* --- Monitoring Enhancements --- */

.metric-sub {
    font-size: 0.7rem;
    color: var(--text-dim);
    margin-top: 4px;
}

.metric-bar-fill.warning { background: var(--warning); }
.metric-bar-fill.danger { background: var(--error); }

/* Agent Health Grid */
.agent-health-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.agent-tile {
    width: 38px;
    height: 38px;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
    font-weight: 700;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    position: relative;
}

.agent-tile:hover {
    transform: scale(1.2);
    box-shadow: 0 0 8px rgba(255,255,255,0.15);
    z-index: 2;
}

.agent-tile.idle { background: color-mix(in srgb, var(--success) 25%, transparent); color: var(--success); border: 1px solid var(--success); }
.agent-tile.working { background: color-mix(in srgb, var(--accent) 25%, transparent); color: var(--accent); border: 1px solid var(--accent); }
.agent-tile.crashed { background: color-mix(in srgb, var(--error) 25%, transparent); color: var(--error); border: 1px solid var(--error); }
.agent-tile.offline { background: var(--bg-hover); color: var(--text-dim); border: 1px solid var(--border); }

.agent-tile-tooltip {
    display: none;
    position: absolute;
    bottom: 110%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    padding: 6px 10px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 10;
    pointer-events: none;
}
.agent-tile:hover .agent-tile-tooltip { display: block; }

.agent-grid-legend {
    display: flex;
    gap: 12px;
    font-size: 0.75rem;
    color: var(--text-dim);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
}

.legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    display: inline-block;
}

/* 3-col layout for pipeline/cost/alerts */
.monitor-3col {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: var(--spacing-lg);
}

@media (max-width: 1024px) {
    .monitor-3col { grid-template-columns: 1fr; }
}

/* Task Pipeline */
.pipeline-funnel {
    display: flex;
    flex-direction: column;
    gap: 6px;
}

.pipeline-stage {
    display: flex;
}

.pipeline-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 12px;
    background: color-mix(in srgb, var(--accent) 15%, transparent);
    border-radius: var(--radius-sm);
    font-size: 0.8rem;
    transition: width 0.3s;
}

.pipeline-bar.queued { background: color-mix(in srgb, #58a6ff 20%, transparent); }
.pipeline-bar.assigned { background: color-mix(in srgb, var(--warning) 20%, transparent); }
.pipeline-bar.completed { background: color-mix(in srgb, var(--success) 20%, transparent); }
.pipeline-bar.failed { background: color-mix(in srgb, var(--error) 20%, transparent); }

.pipeline-label { color: var(--text-dim); }
.pipeline-count { font-weight: 700; color: var(--text); }

/* Cost Tracker */
.cost-tracker {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.cost-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
}

.cost-row:last-child { border-bottom: none; }
.cost-label { color: var(--text-dim); font-size: 0.85rem; }
.cost-value { font-weight: 700; font-size: 1rem; }

/* Alert Feed */
.alert-feed {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 300px;
    overflow-y: auto;
}

.alert-item {
    padding: 8px 12px;
    border-left: 3px solid var(--text-dim);
    border-radius: var(--radius-sm);
    background: var(--bg-hover);
    font-size: 0.8rem;
}

.alert-item.warning { border-left-color: var(--warning); }
.alert-item.critical { border-left-color: var(--error); }
.alert-item.info { border-left-color: var(--accent); }

.alert-item .alert-time {
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-top: 2px;
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/agents.js') }}"></script>
<script>
// Main tab switching
function switchMainTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
    });

    // Update tab content
    document.querySelectorAll('.main-tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
    });
}

// Load projects from API
async function loadProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();

        const projectSelect = document.getElementById('inline-agent-project');
        if (!projectSelect) return;

        // Clear existing options except the first placeholder
        projectSelect.innerHTML = '<option value="">Select project...</option>';

        // Add projects
        if (projects && projects.length > 0) {
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                option.dataset.workingDir = project.workingDirectory || '';
                projectSelect.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Failed to load projects:', error);
    }
}

// Override updateAgentUI to keep add-agent-card first and use the correct grid
if (typeof orchestrator !== 'undefined') {
    orchestrator.updateAgentUI = function() {
        renderAgentList();
        updateOverview(Array.from(this.agents.values()));
        if (typeof loadProjects === 'function') loadProjects();
    };

    orchestrator.updateAgentCard = function(agent) {
        // For custom layout, rerender list to keep pinned order and search filters.
        renderAgentList();
        updateOverview(Array.from(this.agents.values()));
    };
}

// Override appendOutputLine to be silent or log to console as containers are removed in this layout
if (typeof orchestrator !== 'undefined') {
    orchestrator.appendOutputLine = function(agentId, line, stream) {
        const entries = agentOutputs.get(agentId) || [];
        entries.push({ line, stream, time: new Date().toLocaleTimeString() });
        if (entries.length > 200) entries.shift();
        agentOutputs.set(agentId, entries);
        if (stream === 'stderr') console.warn(`[Agent ${agentId}] ${line}`);
    };
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Load projects for the inline form
    loadProjects();

    // Connect to agent orchestrator
    if (typeof orchestrator !== 'undefined') {
        orchestrator.connect();
    }

    const agentSearch = document.getElementById('agent-search');
    if (agentSearch) {
        agentSearch.addEventListener('input', () => {
            agentSearchQuery = agentSearch.value.trim().toLowerCase();
            renderAgentList();
        });
    }

    const taskSearch = document.getElementById('task-search');
    if (taskSearch) {
        taskSearch.addEventListener('input', () => {
            taskSearchQuery = taskSearch.value.trim().toLowerCase();
            renderAutonomousTasks(lastTasksSnapshot);
        });
    }

    const monitorSearch = document.getElementById('monitor-search');
    if (monitorSearch) {
        monitorSearch.addEventListener('input', () => {
            activityFilters.search = monitorSearch.value.trim().toLowerCase();
            applyActivityFilters();
        });
    }

    setupActivityFilterControls();

    const manageSearch = document.getElementById('manage-agent-search');
    if (manageSearch) {
        manageSearch.addEventListener('input', () => renderManageAgentList());
    }

    const manageSelectAll = document.getElementById('manage-select-all');
    if (manageSelectAll) {
        manageSelectAll.addEventListener('change', (e) => toggleManageSelectAll(e.target.checked));
    }

    document.addEventListener('keydown', (event) => {
        if (event.key !== '/' || event.target.matches('input, textarea')) return;
        event.preventDefault();
        const activeTab = document.querySelector('.tab-button.active')?.dataset?.tab;
        if (activeTab === 'agents') agentSearch?.focus();
        if (activeTab === 'tasks') taskSearch?.focus();
        if (activeTab === 'monitor') monitorSearch?.focus();
    });
});

let pinnedAgents = new Set(JSON.parse(localStorage.getItem('shadowai_pinned_agents') || '[]'));
let agentSearchQuery = '';
let taskSearchQuery = '';
let lastTasksSnapshot = [];
let buildSummaryByRepo = {};

const activityFilters = {
    severity: 'all',
    status: 'all',
    agent: 'all',
    repo: 'all',
    search: ''
};

const activityOptionSets = {
    agent: new Set(),
    repo: new Set()
};

const activityErrorBuckets = {};
const agentTimelines = new Map();
const agentOutputs = new Map();
const agentFilesTouched = new Map();

if (typeof orchestrator !== 'undefined') {
    orchestrator.on('agent_task_started', (data) => {
        recordAgentTimeline(data.agent_id, `Task started: ${data.task_id || ''}`, new Date().toLocaleTimeString(), 'info');
    });
    orchestrator.on('agent_task_progress', (data) => {
        recordAgentTimeline(data.agent_id, `Progress ${data.pct || 0}%: ${data.msg || ''}`, new Date().toLocaleTimeString(), 'info');
    });
    orchestrator.on('agent_task_completed', (data) => {
        const files = data.result?.files_changed || data.result?.files || [];
        if (Array.isArray(files) && files.length > 0) {
            agentFilesTouched.set(data.agent_id, files.slice(0, 50));
        }
        recordAgentTimeline(data.agent_id, `Task completed: ${data.task_id || ''}`, new Date().toLocaleTimeString(), 'success');
    });
    orchestrator.on('agent_task_result', (data) => {
        const files = data.result?.files_changed || data.result?.files || [];
        if (Array.isArray(files) && files.length > 0) {
            agentFilesTouched.set(data.agent_id, files.slice(0, 50));
        }
    });
}

function isAgentPinned(agentId) {
    return pinnedAgents.has(agentId);
}

function togglePinAgent(agentId, event) {
    if (event) event.stopPropagation();
    if (pinnedAgents.has(agentId)) {
        pinnedAgents.delete(agentId);
    } else {
        pinnedAgents.add(agentId);
    }
    localStorage.setItem('shadowai_pinned_agents', JSON.stringify(Array.from(pinnedAgents)));
    renderAgentList();
}

function filterAgentsByQuery(agents, query) {
    if (!query) return agents;
    return agents.filter(agent => {
        const haystack = [
            agent.name,
            agent.specialty,
            agent.role,
            agent.status,
            agent.provider,
            agent.model
        ].filter(Boolean).join(' ').toLowerCase();
        return haystack.includes(query);
    });
}

function renderAgentList() {
    const container = document.getElementById('agents-list');
    if (!container || typeof orchestrator === 'undefined') return;

    const addCard = document.querySelector('.add-agent-card');
    const addAgentCardHtml = addCard ? addCard.outerHTML : '';
    const agents = Array.from(orchestrator.agents.values());
    const filtered = filterAgentsByQuery(agents, agentSearchQuery);
    const pinned = filtered.filter(agent => pinnedAgents.has(agent.id));
    const unpinned = filtered.filter(agent => !pinnedAgents.has(agent.id));

    let html = addAgentCardHtml;
    if (pinned.length > 0) {
        html += `<div class="agent-section-label">Pinned</div>`;
        html += pinned.map(agent => renderAgentCard(agent)).join('');
    }
    if (unpinned.length > 0) {
        if (pinned.length > 0) {
            html += `<div class="agent-section-label">All Agents</div>`;
        }
        html += unpinned.map(agent => renderAgentCard(agent)).join('');
    }

    container.innerHTML = html;
    updateNowRunning(agents);
    updateAgentFilterOptions(agents);

    const drawer = document.getElementById('agent-detail-drawer');
    if (drawer && !drawer.classList.contains('hidden')) {
        const agentId = drawer.dataset.agentId;
        const agent = orchestrator.agents.get(agentId);
        if (agent) renderAgentDrawer(agent);
    }
}

function updateNowRunning(agents) {
    const list = document.getElementById('now-running-list');
    const meta = document.getElementById('now-running-meta');
    if (!list) return;

    const activeStatuses = ['busy', 'active', 'running', 'working', 'in_progress'];
    const active = agents.filter(agent => activeStatuses.includes((agent.status || '').toLowerCase()) && agent.current_task);
    if (meta) meta.textContent = `${active.length} active`;

    const top = active.slice(0, 3);
    if (top.length === 0) {
        list.innerHTML = '<div class="empty-state-small">No active agents</div>';
        return;
    }

    list.innerHTML = top.map(agent => {
        const raw = agent.task_progress_pct ?? agent.progress_pct;
        const progressPct = Number.isFinite(Number(raw)) ? Number(raw) : 0;
        return `
            <div class="now-running-card">
                <h4>${escapeHtml(agent.name)}</h4>
                <div class="now-running-task">${escapeHtml(agent.current_task || 'Working...')}</div>
                <div class="now-running-progress"><span style="width:${Math.max(0, Math.min(progressPct, 100))}%"></span></div>
            </div>
        `;
    }).join('');
}

function pauseAgent(agentId, event) {
    if (event) event.stopPropagation();
    if (!confirm('Pause this agent? It will stop after finishing current work.')) return;
    if (typeof orchestrator !== 'undefined') {
        orchestrator.stopAgent(agentId, true);
    }
}

function forceStopAgent(agentId, event) {
    if (event) event.stopPropagation();
    if (!confirm('Force stop this agent immediately?')) return;
    if (typeof orchestrator !== 'undefined') {
        orchestrator.stopAgent(agentId, false);
    }
}

function openAgentDrawer(agentId) {
    const drawer = document.getElementById('agent-detail-drawer');
    if (!drawer || typeof orchestrator === 'undefined') return;
    const agent = orchestrator.agents.get(agentId);
    if (!agent) return;
    orchestrator.getAgentStatus(agentId);
    drawer.classList.remove('hidden');
    drawer.dataset.agentId = agentId;
    renderAgentDrawer(agent);
}

function closeAgentDrawer() {
    const drawer = document.getElementById('agent-detail-drawer');
    if (!drawer) return;
    drawer.classList.add('hidden');
    delete drawer.dataset.agentId;
}

function renderAgentDrawer(agent) {
    const nameEl = document.getElementById('agent-drawer-name');
    const subtitleEl = document.getElementById('agent-drawer-subtitle');
    const statsEl = document.getElementById('agent-drawer-stats');
    const timelineEl = document.getElementById('agent-drawer-timeline');
    const outputsEl = document.getElementById('agent-drawer-outputs');
    const filesEl = document.getElementById('agent-drawer-files');

    if (nameEl) nameEl.textContent = agent.name || 'Agent';
    if (subtitleEl) subtitleEl.textContent = `${(agent.status || 'idle').toUpperCase()}  ${agent.current_task || 'Idle'}`;

    if (statsEl) {
        const progressPct = agent.task_progress_pct ?? agent.progress_pct;
        const stats = [
            { label: 'CPU', value: `${agent.cpu_percent || 0}%` },
            { label: 'Memory', value: `${agent.memory_mb || 0}MB` },
            { label: 'Tasks', value: `${agent.tasks_completed || 0}` },
            { label: 'Uptime', value: formatUptime(agent.uptime_seconds) },
            { label: 'Progress', value: progressPct !== undefined && progressPct !== null ? `${progressPct}%` : '' }
        ];
        statsEl.innerHTML = stats.map(stat => `
            <div class="agent-drawer-stat">
                <strong>${escapeHtml(stat.label)}:</strong> ${escapeHtml(stat.value)}
            </div>
        `).join('');
    }

    const timeline = agentTimelines.get(agent.id) || [];
    if (timelineEl) {
        timelineEl.innerHTML = timeline.length
            ? timeline.slice(0, 20).map(entry => `
                <div class="agent-drawer-entry">
                    <div>${escapeHtml(entry.message)}</div>
                    <small>${escapeHtml(entry.time)}</small>
                </div>
            `).join('')
            : '<div class="empty-state-small">No recent activity</div>';
    }

    const outputs = agentOutputs.get(agent.id) || (agent.output_lines || []).map(line => ({
        line: line.line || line,
        time: line.timestamp || ''
    }));
    if (outputsEl) {
        outputsEl.innerHTML = outputs.length
            ? outputs.slice(-20).map(line => `
                <div class="agent-drawer-entry">
                    <div>${escapeHtml(line.line)}</div>
                    <small>${escapeHtml(line.time)}</small>
                </div>
            `).join('')
            : '<div class="empty-state-small">No output captured</div>';
    }

    const files = agentFilesTouched.get(agent.id) || agent.task_result?.files_changed || agent.task_result?.files || [];
    if (filesEl) {
        filesEl.innerHTML = files.length
            ? files.map(file => `<div class="agent-drawer-entry">${escapeHtml(file)}</div>`).join('')
            : '<div class="empty-state-small">No files reported yet</div>';
    }
}

function openManageAgentsModal() {
    const modal = document.getElementById('manage-agents-modal');
    if (!modal) return;
    modal.classList.remove('hidden');
    renderManageAgentList();
}

function closeManageAgentsModal() {
    const modal = document.getElementById('manage-agents-modal');
    if (!modal) return;
    modal.classList.add('hidden');
}

function renderManageAgentList() {
    const list = document.getElementById('manage-agent-list');
    if (!list || typeof orchestrator === 'undefined') return;
    const query = (document.getElementById('manage-agent-search')?.value || '').toLowerCase();
    const agents = Array.from(orchestrator.agents.values());
    const filtered = query ? agents.filter(a => (a.name || '').toLowerCase().includes(query)) : agents;
    list.innerHTML = filtered.map(agent => `
        <label class="manage-agent-item">
            <input type="checkbox" class="manage-agent-checkbox" value="${agent.id}">
            <div class="manage-agent-info">
                <strong>${escapeHtml(agent.name)}</strong>
                <div class="manage-agent-meta">${escapeHtml(agent.specialty || agent.role || 'General')}  ${(agent.status || 'idle').toUpperCase()}</div>
            </div>
        </label>
    `).join('') || '<div class="empty-state-small">No agents available</div>';
}

function toggleManageSelectAll(checked) {
    document.querySelectorAll('.manage-agent-checkbox').forEach(cb => cb.checked = checked);
}

function getManageSelectedIds() {
    return Array.from(document.querySelectorAll('.manage-agent-checkbox:checked')).map(cb => cb.value);
}

function manageRefreshSelected() {
    const ids = getManageSelectedIds();
    ids.forEach(id => orchestrator.getAgentStatus(id));
}

function managePauseSelected() {
    const ids = getManageSelectedIds();
    if (!ids.length || !confirm('Pause selected agents?')) return;
    ids.forEach(id => orchestrator.stopAgent(id, true));
}

function manageStopSelected() {
    const ids = getManageSelectedIds();
    if (!ids.length || !confirm('Force stop selected agents?')) return;
    ids.forEach(id => orchestrator.stopAgent(id, false));
}

async function manageReleaseLocksSelected() {
    const ids = getManageSelectedIds();
    if (!ids.length || !confirm('Release locks for selected agents?')) return;
    if (typeof api === 'undefined' || typeof api.releaseLocks !== 'function') {
        addActivityItem('Failed to release locks: API not available', 'error');
        return;
    }
    for (const id of ids) {
        await api.releaseLocks({ agent_id: id });
    }
    addActivityItem(`Released locks for ${ids.length} agents`, 'success');
    orchestrator.fetchLocks();
}

// Render agent card (Horizontal List Style)
function renderAgentCard(agent) {
    const statusClass = (agent.status || 'idle').toLowerCase();
    const pinned = isAgentPinned(agent.id);
    const progressPct = agent.task_progress_pct ?? agent.progress_pct;
    const safeProgress = Number.isFinite(Number(progressPct)) ? Number(progressPct) : null;
    const progressMsg = agent.task_progress_msg || '';
    return `
        <div class="agent-card horizontal ${pinned ? 'pinned' : ''}" id="agent-${agent.id}" onclick="openAgentDrawer('${agent.id}')">
            <div class="agent-card-header">
                <div class="agent-card-icon">
                    <span class="material-symbols-outlined">smart_toy</span>
                </div>
                <div class="agent-card-title-info">
                    <div class="agent-title-row">
                        <h4>${escapeHtml(agent.name)}</h4>
                        <button class="agent-pin-btn ${pinned ? 'pinned' : ''}" onclick="togglePinAgent('${agent.id}', event)" title="Pin agent">
                            <span class="material-symbols-outlined">${pinned ? 'star' : 'star_outline'}</span>
                        </button>
                    </div>
                    <div class="agent-card-subtitle">${escapeHtml(agent.specialty || agent.role || 'General Assistant')}</div>
                    <div class="agent-badges">
                        ${agent.provider ? `<span class="badge provider-badge">${escapeHtml(agent.provider)}</span>` : ''}
                        ${agent.model ? `<span class="badge model-badge">${escapeHtml(agent.model)}</span>` : ''}
                    </div>
                </div>
            </div>

            <div class="agent-metrics">
                <div class="agent-metric" title="CPU Usage">
                    <span class="material-symbols-outlined">memory</span>
                    <span>${agent.cpu_percent || 0}%</span>
                </div>
                <div class="agent-metric" title="Memory Usage">
                    <span class="material-symbols-outlined">storage</span>
                    <span>${agent.memory_mb || 0}MB</span>
                </div>
                <div class="agent-metric" title="Tasks Completed">
                    <span class="material-symbols-outlined">task_alt</span>
                    <span>${agent.tasks_completed || 0}</span>
                </div>
                <div class="agent-metric" title="Uptime">
                    <span class="material-symbols-outlined">schedule</span>
                    <span>${formatUptime(agent.uptime_seconds)}</span>
                </div>
            </div>

            ${agent.current_task ? `
                <div class="agent-current-task" title="${escapeHtml(agent.current_task)}">
                    <strong>Current:</strong>
                    ${escapeHtml(agent.current_task)}
                </div>
            ` : '<div class="agent-current-task" style="border-left:none; background:transparent; color:var(--text-dim)"><em>No active task</em></div>'}

            ${safeProgress !== null ? `
                <div class="agent-progress">
                    <div class="agent-progress-bar">
                        <span style="width: ${Math.max(0, Math.min(safeProgress, 100))}%"></span>
                    </div>
                    <div class="agent-progress-text">${escapeHtml(progressMsg || `${safeProgress}% complete`)}</div>
                </div>
            ` : ''}

            <div class="agent-card-right">
                <span class="status-badge ${statusClass}">${statusClass.toUpperCase()}</span>
                <div class="agent-card-actions">
                    <button class="btn btn-icon-small" onclick="showAssignTaskModal('${agent.id}'); event.stopPropagation();" title="Assign Task">
                        <span class="material-symbols-outlined">assignment</span>
                    </button>
                    <button class="btn btn-icon-small btn-secondary" onclick="pauseAgent('${agent.id}', event)" title="Pause (graceful stop)">
                        <span class="material-symbols-outlined">pause_circle</span>
                    </button>
                    <button class="btn btn-icon-small btn-secondary" onclick="openAgentDrawer('${agent.id}'); event.stopPropagation();" title="View Logs">
                        <span class="material-symbols-outlined">receipt_long</span>
                    </button>
                    <button class="btn btn-icon-small btn-secondary" onclick="orchestrator.getAgentStatus('${agent.id}'); event.stopPropagation();" title="Refresh">
                        <span class="material-symbols-outlined">refresh</span>
                    </button>
                    <button class="btn btn-icon-small btn-danger" onclick="forceStopAgent('${agent.id}', event)" title="Stop Agent">
                        <span class="material-symbols-outlined">stop_circle</span>
                    </button>
                </div>
            </div>
        </div>
    `;
}

// Update overview metrics
function updateOverview(mergedAgentsList = null) {
    if (typeof orchestrator === 'undefined') return;

    const agentsList = mergedAgentsList || Array.from(orchestrator.agents.values());
    const totalAgents = agentsList.length;
    
    // Count active statuses as busy for metrics
    const activeStatuses = ['busy', 'active', 'running', 'in_progress'];
    const activeAgents = agentsList.filter(a => 
        activeStatuses.includes((a.status || '').toLowerCase())
    ).length;

    const totalEl = document.getElementById('overview-total-agents');
    if (totalEl) totalEl.textContent = totalAgents;
    
    const activeEl = document.getElementById('overview-active-agents');
    if (activeEl) activeEl.textContent = activeAgents;

    // Calculate total tasks and completed
    let totalTasks = 0;
    let completedTasks = 0;
    agentsList.forEach(agent => {
        completedTasks += agent.tasks_completed || 0;
        if (agent.current_task) totalTasks++;
    });
    totalTasks += completedTasks;

    const tasksEl = document.getElementById('overview-total-tasks');
    if (tasksEl) tasksEl.textContent = totalTasks;
    
    const compEl = document.getElementById('overview-completed-tasks');
    if (compEl) compEl.textContent = completedTasks;

    // System metrics now updated by monitoring service polling (fetchMonitoringData)
}

// Format uptime
function formatUptime(seconds) {
    if (!seconds) return '0s';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) return `${hours}h ${minutes}m`;
    if (minutes > 0) return `${minutes}m ${secs}s`;
    return `${secs}s`;
}

function clearActivityFeed() {
    const feed = document.getElementById('activity-feed');
    if (feed) feed.innerHTML = '<div class="empty-state-small">Feed cleared</div>';
    Object.keys(activityErrorBuckets).forEach(key => delete activityErrorBuckets[key]);
    renderErrorPanel();
}

function showCreateTaskModal() {
    document.getElementById('create-task-modal').classList.remove('hidden');
    document.getElementById('task-title').focus();
}

function closeCreateTaskModal() {
    document.getElementById('create-task-modal').classList.add('hidden');
}

async function confirmCreateTask() {
    const title = document.getElementById('task-title').value.trim();
    const description = document.getElementById('task-description').value.trim();
    const priority = document.getElementById('task-priority').value;

    if (!title) {
        document.getElementById('task-title').focus();
        return;
    }

    const priorityMap = { 'urgent': 1, 'high': 2, 'medium': 3, 'low': 4 };
    const task = {
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(36),
        title: title,
        description: description || title,
        category: 'todo',
        priority: priorityMap[priority] || 3,
        scope: 'small',
        status: 'pending',
        source: 'manual',
        created_at: new Date().toISOString()
    };

    try {
        const resp = await fetch('/api/autonomous/tasks/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tasks: [task] })
        });
        const data = await resp.json();
        if (data.success) {
            addActivityItem(`Task created: ${title}`, 'success');
            // Clear form
            document.getElementById('task-title').value = '';
            document.getElementById('task-description').value = '';
            document.getElementById('task-priority').value = 'medium';
            // Refresh task board
            pollAutonomousStatus();
        } else {
            addActivityItem('Failed to create task: ' + (data.error || 'Unknown'), 'error');
        }
    } catch (e) {
        addActivityItem('Error creating task: ' + e.message, 'error');
    }

    closeCreateTaskModal();
}

// ============ Autonomous Agent System ============

let autonomousState = { running: false, paused: false };

// Default models per provider
const providerModels = {
    'gemini': 'gemini-3-flash-preview',
    'claude': 'claude-sonnet-4-20250514',
    'codex': 'o4-mini'
};

async function autonomousStart() {
    const btn = document.getElementById('auto-start-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="material-symbols-outlined" style="animation:spin 1s linear infinite">autorenew</span> Starting...';

    // Use sensible defaults - no UI config needed
    const provider = 'gemini';
    const count = 5;
    const focus = 'backend-polish';
    const model = providerModels[provider] || 'gemini-3-flash-preview';

    try {
        const resp = await fetch('/api/autonomous/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ count, focus, provider, model })
        });
        const data = await resp.json();
        if (data.success) {
            addActivityItem(`Autonomous loop started: ${count} agents`, 'success');
            updateAutonomousUI(data.status);
        } else {
            addActivityItem('Failed to start: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (e) {
        addActivityItem('Error starting autonomous loop: ' + e.message, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-outlined">play_arrow</span> Start';
}

async function autonomousStop() {
    if (!confirm('Stop all autonomous agents?')) return;
    try {
        const resp = await fetch('/api/autonomous/stop', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            addActivityItem('Autonomous loop stopped', 'info');
            autonomousState = { running: false, paused: false };
            updateAutonomousControls();
        }
    } catch (e) {
        addActivityItem('Error stopping: ' + e.message, 'error');
    }
}

async function autonomousPause() {
    try {
        const resp = await fetch('/api/autonomous/pause', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            autonomousState.paused = true;
            updateAutonomousControls();
            addActivityItem('Autonomous loop paused', 'info');
        }
    } catch (e) {
        addActivityItem('Error pausing: ' + e.message, 'error');
    }
}

async function autonomousResume() {
    try {
        const resp = await fetch('/api/autonomous/resume', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            autonomousState.paused = false;
            updateAutonomousControls();
            addActivityItem('Autonomous loop resumed', 'info');
        }
    } catch (e) {
        addActivityItem('Error resuming: ' + e.message, 'error');
    }
}

async function autonomousScan() {
    const btn = document.getElementById('auto-scan-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="material-symbols-outlined" style="animation:spin 1s linear infinite">autorenew</span> Scanning...';

    try {
        const resp = await fetch('/api/autonomous/scan', { method: 'POST' });
        const data = await resp.json();
        if (data.success) {
            addActivityItem(`Scan found ${data.tasks_found} tasks`, 'success');
            // Update task board with scan results
            if (data.tasks && data.tasks.length > 0) {
                renderAutonomousTasks(data.tasks);
            }
        }
    } catch (e) {
        addActivityItem('Scan error: ' + e.message, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = '<span class="material-symbols-outlined">search</span> Scan';
}

async function generateProjectTasks() {
    const btn = document.getElementById('generate-tasks-btn');
    if (!btn) return;
    const original = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="material-symbols-outlined" style="animation:spin 1s linear infinite">auto_awesome</span> Generating...';

    try {
        const resp = await fetch('/api/autonomous/generate_tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({})
        });
        const data = await resp.json();
        if (data.success) {
            const projects = data.generated || [];
            const total = data.total_tasks || 0;
            addActivityItem(`AI generated ${total} tasks across ${projects.length} projects`, 'success');

            const flat = projects.flatMap(p => p.tasks || []);
            if (flat.length > 0) {
                renderAutonomousTasks(flat);
            }
            pollAutonomousStatus();
        } else {
            addActivityItem('Task generation failed: ' + (data.error || 'unknown error'), 'error');
        }
    } catch (e) {
        addActivityItem('Task generation error: ' + e.message, 'error');
    }

    btn.disabled = false;
    btn.innerHTML = original;
}

function updateAutonomousUI(status) {
    autonomousState.running = status.running;
    autonomousState.paused = status.paused;
    updateAutonomousControls();

    // Sync swarm agents to orchestrator
    if (status.agents && typeof orchestrator !== 'undefined') {
        Object.entries(status.agents).forEach(([id, agent]) => {
            // Keep existing metrics if present
            const existing = orchestrator.agents.get(id);
            orchestrator.agents.set(id, {
                ...existing,
                ...agent,
                id: id
            });
        });
    }

    // Update cycle count
    const cyclesEl = document.getElementById('overview-cycles');
    if (cyclesEl) cyclesEl.textContent = status.cycle_count || 0;

    // Update success rate
    const comp = status.tasks_completed || 0;
    const fail = status.tasks_failed || 0;
    const total = comp + fail;
    const rate = total > 0 ? Math.round((comp / total) * 100) : 100;
    const rateEl = document.getElementById('overview-success-rate');
    if (rateEl) rateEl.textContent = rate + '%';

    // Update task counts from autonomous data
    if (status.tasks_completed !== undefined) {
        document.getElementById('overview-completed-tasks').textContent =
            (status.tasks_completed || 0);
    }
    if (status.task_queue !== undefined) {
        document.getElementById('overview-total-tasks').textContent =
            (status.task_queue || 0) + (status.tasks_completed || 0);
    }

    // Update estimated cost
    const costEl = document.getElementById('overview-cost');
    if (costEl && status.estimated_cost_usd !== undefined) {
        const cost = status.estimated_cost_usd || 0;
        costEl.textContent = cost < 1 ? `$${cost.toFixed(3)}` : `$${cost.toFixed(2)}`;
        // Color code: green < $1, yellow < $5, red > $5
        const card = document.getElementById('overview-cost-card');
        if (card) {
            card.style.borderColor = cost < 1 ? 'var(--success)' : cost < 5 ? 'var(--warning)' : 'var(--error)';
        }
    }

    // Render tasks if available in status
    if (status.tasks) {
        renderAutonomousTasks(status.tasks);
    }

    // Trigger agent UI update to show swarm agents
    if (orchestrator && typeof orchestrator.updateAgentUI === 'function') {
        orchestrator.updateAgentUI();
    }

    // Update build history
    if (status.build_history) {
        renderBuildHistory(status.build_history);
    }
}

function updateAutonomousControls() {
    const badge = document.getElementById('auto-status-badge');
    const startBtn = document.getElementById('auto-start-btn');
    const stopBtn = document.getElementById('auto-stop-btn');
    const pauseBtn = document.getElementById('auto-pause-btn');
    const resumeBtn = document.getElementById('auto-resume-btn');

    if (autonomousState.running) {
        badge.textContent = autonomousState.paused ? 'PAUSED' : 'RUNNING';
        badge.className = 'autonomous-status-badge ' + (autonomousState.paused ? 'paused' : 'running');
        startBtn.style.display = 'none';
        stopBtn.style.display = '';
        pauseBtn.style.display = autonomousState.paused ? 'none' : '';
        resumeBtn.style.display = autonomousState.paused ? '' : 'none';
    } else {
        badge.textContent = 'STOPPED';
        badge.className = 'autonomous-status-badge stopped';
        startBtn.style.display = '';
        stopBtn.style.display = 'none';
        pauseBtn.style.display = 'none';
        resumeBtn.style.display = 'none';
    }
}

function normalizeTaskStatus(task) {
    const raw = (task.status || '').toString().toLowerCase();
    if (['in_progress', 'inprogress', 'active', 'working'].includes(raw)) return 'in_progress';
    if (['completed', 'done', 'success'].includes(raw)) return 'completed';
    return 'pending';
}

function getTaskCategory(task) {
    const cat = (task.category || 'general').toString().toLowerCase();
    const labels = {
        'todo': 'TODOs & Improvements',
        'error_handling': 'Error Handling',
        'smell': 'Code Quality',
        'code_smell': 'Code Quality',
        'test_gap': 'Test Coverage',
        'performance': 'Performance',
        'general': 'General'
    };
    return labels[cat] || cat.charAt(0).toUpperCase() + cat.slice(1);
}

function getTaskPriority(task) {
    const raw = parseInt(task.priority, 10);
    if (Number.isFinite(raw)) return raw;
    return 4;
}

function renderAutonomousTasks(tasks) {
    const container = document.getElementById('project-task-board');
    if (!container) return;

    lastTasksSnapshot = Array.isArray(tasks) ? tasks : [];
    const filteredTasks = lastTasksSnapshot.filter(task => {
        if (!taskSearchQuery) return true;
        const haystack = [
            task.title,
            task.description,
            task.repo,
            task.category
        ].filter(Boolean).join(' ').toLowerCase();
        return haystack.includes(taskSearchQuery);
    });

    const grouped = {};
    filteredTasks.forEach(task => {
        const category = getTaskCategory(task);
        if (!grouped[category]) grouped[category] = [];
        grouped[category].push(task);
    });

    const categories = Object.keys(grouped).sort((a, b) => a.localeCompare(b));
    let pendingCount = 0, progressCount = 0, completedCount = 0;

    const sections = categories.map(cat => {
        const pending = [];
        const progress = [];
        const completed = [];

        grouped[cat].forEach(task => {
            const status = normalizeTaskStatus(task);
            const card = renderTaskCard(task);
            if (status === 'in_progress') {
                progress.push(card);
            } else if (status === 'completed') {
                completed.push(card);
            } else {
                pending.push(card);
            }
        });

        pendingCount += pending.length;
        progressCount += progress.length;
        completedCount += completed.length;

        const pendingHtml = pending.length > 0 ? pending.join('') : '<div class="empty-column">No pending tasks</div>';
        const progressHtml = progress.length > 0 ? progress.join('') : '<div class="empty-column">No tasks in progress</div>';
        const completedHtml = completed.length > 0 ? completed.join('') : '<div class="empty-column">No completed tasks</div>';

        return `
            <div class="task-project">
                <div class="task-project-header">
                    <div class="task-project-title">
                        <h4>${escapeHtml(cat)}</h4>
                    </div>
                </div>
                <div class="task-board task-board-compact">
                    <div class="task-column">
                        <div class="task-column-header">
                            <h4>Pending</h4>
                            <span class="task-count">${pending.length}</span>
                        </div>
                        <div class="task-list">${pendingHtml}</div>
                    </div>
                    <div class="task-column">
                        <div class="task-column-header">
                            <h4>In Progress</h4>
                            <span class="task-count">${progress.length}</span>
                        </div>
                        <div class="task-list">${progressHtml}</div>
                    </div>
                    <div class="task-column">
                        <div class="task-column-header">
                            <h4>Completed</h4>
                            <span class="task-count">${completed.length}</span>
                        </div>
                        <div class="task-list">${completedHtml}</div>
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = sections.length > 0 ? sections.join('') : '<div class="empty-column">No tasks found</div>';

    document.getElementById('pending-count').textContent = pendingCount;
    document.getElementById('progress-count').textContent = progressCount;
    document.getElementById('completed-count').textContent = completedCount;

    setTabCount('tasks', pendingCount + progressCount);
}

function renderTaskCard(task) {
    const priority = getTaskPriority(task);
    const priorityClass = priority <= 2 ? 'priority-urgent' : (priority <= 3 ? 'priority-high' : '');
    const taskId = task.id || task.task_id || '';
    const category = task.category || 'todo';
    const scope = task.scope || 'small';
    const filePath = task.file_path || '';
    const status = normalizeTaskStatus(task);
    const repoKey = (task.repo || task.project || 'misc').toString();
    const build = buildSummaryByRepo[repoKey];
    const buildSummary = build && status === 'completed'
        ? `
            <div class="task-build-summary ${build.success ? 'success' : 'failed'}">
                <span>${build.success ? 'Build OK' : 'Build Failed'}</span>
                <span>${build.steps ? build.steps.length : 0} steps</span>
            </div>
        `
        : '';
    const fileLabel = filePath ? `<span class="task-file-path" title="${escapeHtml(filePath)}">${escapeHtml(filePath.split('/').pop())}</span>` : '';
    return `
        <div class="task-card ${priorityClass}" id="task-${taskId}">
            <div class="task-card-header-row">
                <div class="task-card-title">${escapeHtml(task.title || 'Untitled task')}</div>
                <button class="task-delete-btn" onclick="deleteTask('${taskId}', event)" title="Remove Task">
                    <span class="material-symbols-outlined">delete</span>
                </button>
            </div>
            <div class="task-card-footer">
                <span class="category-badge ${category}">${category}</span>
                <span class="scope-badge">${scope}</span>
                ${fileLabel}
            </div>
            ${buildSummary}
        </div>
    `;
}

async function deleteTask(taskId, event) {
    if (event) event.stopPropagation();
    if (!confirm('Are you sure you want to remove this task?')) return;

    try {
        const resp = await fetch(`/api/autonomous/tasks/${taskId}`, { method: 'DELETE' });
        const data = await resp.json();
        if (data.success) {
            addActivityItem(`Task ${taskId} removed`, 'info');
            // Optimistic UI update or refresh
            pollAutonomousStatus();
        } else {
            alert('Failed to delete task: ' + (data.error || 'Unknown error'));
        }
    } catch (e) {
        console.error('Delete error:', e);
        alert('Error deleting task: ' + e.message);
    }
}

function renderBuildHistory(builds) {
    const container = document.getElementById('build-history');
    if (!container || !builds || builds.length === 0) return;

    updateBuildSummary(builds);

    container.innerHTML = builds.map(b => `
        <div class="build-item">
            <div class="build-status-icon ${b.success ? 'success' : 'failed'}">
                <span class="material-symbols-outlined">${b.success ? 'check_circle' : 'error'}</span>
            </div>
            <div class="build-info">
                <div class="build-info-title">${escapeHtml(b.repo ? `${b.repo} build gate` : (b.build_type || 'unknown'))}</div>
                <div class="build-info-meta">${b.duration_seconds ? b.duration_seconds.toFixed(0) + 's' : ''} ${b.timestamp || ''}</div>
            </div>
        </div>
    `).join('');
}

function updateBuildSummary(builds) {
    if (!Array.isArray(builds)) return;
    builds.forEach(build => {
        if (!build.repo) return;
        const existing = buildSummaryByRepo[build.repo];
        if (!existing || (build.timestamp && build.timestamp > existing.timestamp)) {
            buildSummaryByRepo[build.repo] = build;
        }
    });
}

function setTabCount(tab, count) {
    const el = document.getElementById(`tab-count-${tab}`);
    if (el) el.textContent = count || 0;
}

function setupActivityFilterControls() {
    const severityGroup = document.getElementById('filter-severity');
    const statusGroup = document.getElementById('filter-status');
    const agentSelect = document.getElementById('filter-agent');
    const repoSelect = document.getElementById('filter-repo');

    if (severityGroup) {
        severityGroup.addEventListener('click', (event) => {
            const btn = event.target.closest('.chip');
            if (!btn) return;
            severityGroup.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            btn.classList.add('active');
            activityFilters.severity = btn.dataset.filter || 'all';
            applyActivityFilters();
        });
    }

    if (statusGroup) {
        statusGroup.addEventListener('click', (event) => {
            const btn = event.target.closest('.chip');
            if (!btn) return;
            statusGroup.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            btn.classList.add('active');
            activityFilters.status = btn.dataset.filter || 'all';
            applyActivityFilters();
        });
    }

    if (agentSelect) {
        agentSelect.addEventListener('change', () => {
            activityFilters.agent = agentSelect.value;
            applyActivityFilters();
        });
    }

    if (repoSelect) {
        repoSelect.addEventListener('change', () => {
            activityFilters.repo = repoSelect.value;
            applyActivityFilters();
        });
    }
}

function updateActivityFilterOptions(agentId, repo) {
    const agentSelect = document.getElementById('filter-agent');
    const repoSelect = document.getElementById('filter-repo');

    if (agentId) activityOptionSets.agent.add(agentId);
    if (repo) activityOptionSets.repo.add(repo);

    if (agentSelect) {
        const current = agentSelect.value || 'all';
        agentSelect.innerHTML = '<option value="all">All agents</option>' +
            Array.from(activityOptionSets.agent.values()).map(id => {
                const label = (typeof orchestrator !== 'undefined' && orchestrator.agents?.get(id)?.name) || id;
                return `<option value="${id}">${escapeHtml(label)}</option>`;
            }).join('');
        agentSelect.value = current;
    }

    if (repoSelect) {
        const current = repoSelect.value || 'all';
        repoSelect.innerHTML = '<option value="all">All repos</option>' +
            Array.from(activityOptionSets.repo.values()).map(name => `<option value="${name}">${name}</option>`).join('');
        repoSelect.value = current;
    }
}

function updateAgentFilterOptions(agents) {
    agents.forEach(agent => {
        if (agent?.id) activityOptionSets.agent.add(agent.id);
    });
    updateActivityFilterOptions();
}

function inferActivityStatus(message, severity) {
    const msg = message.toLowerCase();
    if (msg.includes('task assigned')) return 'assigned';
    if (msg.includes('task completed')) return 'completed';
    if (msg.includes('task failed')) return 'failed';
    if (msg.includes('build')) return 'build';
    if (severity === 'error') return 'failed';
    return 'info';
}

function applyActivityFilters() {
    const feed = document.getElementById('activity-feed');
    if (!feed) return;
    const items = feed.querySelectorAll('.activity-item');
    let visibleErrors = 0;
    items.forEach(item => {
        const severity = item.dataset.severity || 'info';
        const status = item.dataset.status || 'info';
        const agentId = item.dataset.agent || '';
        const repo = item.dataset.repo || '';
        const text = (item.dataset.searchText || '').toLowerCase();

        const matchesSeverity = activityFilters.severity === 'all' || severity === activityFilters.severity;
        const matchesStatus = activityFilters.status === 'all' || status === activityFilters.status;
        const matchesAgent = activityFilters.agent === 'all' || agentId === activityFilters.agent;
        const matchesRepo = activityFilters.repo === 'all' || repo === activityFilters.repo;
        const matchesSearch = !activityFilters.search || text.includes(activityFilters.search);

        const visible = matchesSeverity && matchesStatus && matchesAgent && matchesRepo && matchesSearch;
        item.style.display = visible ? '' : 'none';
        if (visible && severity === 'error') visibleErrors += 1;
    });
    setTabCount('monitor', visibleErrors);
}

function recordAgentTimeline(agentId, message, time, type) {
    if (!agentId) return;
    const timeline = agentTimelines.get(agentId) || [];
    timeline.unshift({ message, time, type });
    if (timeline.length > 50) timeline.pop();
    agentTimelines.set(agentId, timeline);
}

function categorizeError(message) {
    const msg = message.toLowerCase();
    if (msg.includes('build')) return 'Build failures';
    if (msg.includes('task failed')) return 'Task failures';
    if (msg.includes('task blocked')) return 'Blocked tasks';
    if (msg.includes('lock')) return 'Lock conflicts';
    return 'Other errors';
}

function updateErrorBuckets(message, repo) {
    const key = categorizeError(message);
    const entry = activityErrorBuckets[key] || { count: 0, lastRepo: repo || 'n/a', lastMessage: message };
    entry.count += 1;
    entry.lastRepo = repo || entry.lastRepo;
    entry.lastMessage = message;
    activityErrorBuckets[key] = entry;
    renderErrorPanel();
}

function renderErrorPanel() {
    const container = document.getElementById('active-errors-list');
    if (!container) return;
    const entries = Object.entries(activityErrorBuckets);
    if (entries.length === 0) {
        container.innerHTML = '<div class="empty-state-small">No active errors</div>';
        setTabCount('monitor', 0);
        return;
    }
    const errorCount = entries.reduce((acc, [, data]) => acc + (data.count || 0), 0);
    setTabCount('monitor', errorCount);
    container.innerHTML = entries.map(([label, data]) => `
        <div class="error-item">
            <div class="error-item-header">
                <span>${escapeHtml(label)}</span>
                <span>${data.count}</span>
            </div>
            <div class="error-item-meta">${escapeHtml(data.lastMessage || '')}</div>
        </div>
    `).join('');
}

function addActivityItem(message, type, details = null) {
    const feed = document.getElementById('activity-feed');
    if (!feed) return;

    // Remove empty state
    const empty = feed.querySelector('.empty-state-small');
    if (empty) empty.remove();

    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const meta = arguments.length >= 4 && typeof arguments[3] === 'object' ? arguments[3] : {};
    const severity = meta.severity || type || 'info';
    const status = meta.status || inferActivityStatus(message, severity);
    const agentId = meta.agent_id || meta.agentId || '';
    const repo = meta.repo || '';
    const key = `${severity}|${status}|${message}`;

    const first = feed.firstElementChild;
    if (first && first.dataset && first.dataset.key === key) {
        const count = parseInt(first.dataset.count || '1', 10) + 1;
        first.dataset.count = count;
        const times = JSON.parse(first.dataset.times || '[]');
        times.unshift(time);
        first.dataset.times = JSON.stringify(times.slice(0, 5));
        const badge = first.querySelector('.activity-stack');
        if (badge) badge.textContent = `${count}`;
        const stackDetails = first.querySelector('.activity-stack-details');
        if (stackDetails) {
            stackDetails.innerHTML = times.map(t => `<div>${t}</div>`).join('');
        }
        applyActivityFilters();
        return;
    }

    const item = document.createElement('div');
    item.className = `activity-item ${severity}`;
    item.dataset.key = key;
    item.dataset.count = '1';
    item.dataset.severity = severity;
    item.dataset.status = status;
    item.dataset.agent = agentId;
    item.dataset.repo = repo;
    const detailsText = Array.isArray(details) ? details.join(' ') : (details || '');
    item.dataset.searchText = `${message} ${detailsText} ${repo} ${agentId}`;

    updateActivityFilterOptions(agentId, repo);
    recordAgentTimeline(agentId, message, time, severity);
    if (severity === 'error' || severity === 'warning') updateErrorBuckets(message, repo);

    const detailsHtml = Array.isArray(details) && details.length
        ? `<div class="activity-details">${details.map(line => `<div>${escapeHtml(line)}</div>`).join('')}</div>`
        : '';
    item.innerHTML = `
        <div class="activity-time">${time}</div>
        <div class="activity-text">${escapeHtml(message)} <span class="activity-stack">1</span></div>
        ${detailsHtml}
        <div class="activity-stack-details hidden"></div>
    `;
    const stackBadge = item.querySelector('.activity-stack');
    if (stackBadge) {
        stackBadge.addEventListener('click', (event) => {
            event.stopPropagation();
            const detailsEl = item.querySelector('.activity-stack-details');
            if (detailsEl) detailsEl.classList.toggle('hidden');
        });
    }
    feed.prepend(item);

    // Keep max 100 items
    while (feed.children.length > 100) feed.removeChild(feed.lastChild);

    applyActivityFilters();
}

async function releaseAllLocks() {
    if (!confirm('Release ALL locks? This can allow overlapping work.')) return;
    if (typeof api === 'undefined' || typeof api.releaseLocks !== 'function') {
        addActivityItem('Failed to release locks: API not available', 'error');
        return;
    }
    const result = await api.releaseLocks({ all: true });
    if (result && result.success) {
        addActivityItem(`Released ${result.released || 0} locks`, 'success');
        if (typeof orchestrator !== 'undefined') {
            orchestrator.fetchLocks();
        }
    } else {
        addActivityItem(`Failed to release locks: ${result.error || 'Unknown error'}`, 'error');
    }
}

// Poll autonomous status every 10s
let autoStatusInterval = null;

async function pollAutonomousStatus() {
    try {
        const resp = await fetch('/api/autonomous/status');
        const data = await resp.json();
        updateAutonomousUI(data);

        // Always update tasks
        const tasksResp = await fetch('/api/autonomous/tasks');
        const tasksData = await tasksResp.json();
        
        // Merge pending/progress and completed for the renderer
        const allTasks = [...(tasksData.tasks || []), ...(tasksData.completed || [])];
        renderAutonomousTasks(allTasks);
    } catch (e) {
        // Silently fail - bridge might be restarting
    }
}

// Listen for WebSocket autonomous events
function setupAutonomousWebSocket() {
    if (typeof io === 'undefined') return;

    const socket = io ? io() : null;
    if (!socket) return;

    socket.on('autonomous_status', (data) => {
        updateAutonomousUI(data);
    });

    socket.on('autonomous_activity', (data) => {
        addActivityItem(data.message, data.type || 'info', null, {
            agent_id: data.agent_id,
            severity: data.type || 'info'
        });
    });

    socket.on('autonomous_task_assigned', (data) => {
        addActivityItem(`Task assigned: ${data.task_title} -> ${data.agent_name}`, 'info', null, {
            agent_id: data.agent_id,
            status: 'assigned',
            repo: data.repo
        });
    });

    socket.on('autonomous_task_completed', (data) => {
        addActivityItem(`Task completed: ${data.task_title}`, 'success', null, {
            agent_id: data.agent_id,
            status: 'completed',
            repo: data.repo
        });
    });

    socket.on('autonomous_task_failed', (data) => {
        addActivityItem(`Task failed: ${data.task_title}`, 'error', null, {
            agent_id: data.agent_id,
            status: 'failed',
            repo: data.repo,
            severity: 'error'
        });
    });

    socket.on('autonomous_build_started', (data) => {
        const workspace = data.workspace ? ` (${data.workspace})` : '';
        addActivityItem(`Build started: ${data.repo}${workspace}`, 'info', null, {
            status: 'build',
            repo: data.repo
        });
    });

    socket.on('autonomous_build_success', (data) => {
        const duration = typeof data.duration === 'number' ? `${data.duration.toFixed(0)}s` : '';
        const steps = (data.steps || []).map(step => {
            const stepDuration = typeof step.duration_seconds === 'number' ? `${step.duration_seconds.toFixed(0)}s` : '';
            const meta = stepDuration ? ` (${stepDuration})` : '';
            return `${step.name}: ${step.success ? 'ok' : 'fail'}${meta}`;
        });
        updateBuildSummary([{ ...data, success: true }]);
        addActivityItem(`Build succeeded: ${data.repo}${duration ? ' (' + duration + ')' : ''}`, 'success', steps, {
            status: 'build',
            repo: data.repo,
            severity: 'success'
        });
    });

    socket.on('autonomous_build_failed', (data) => {
        const duration = typeof data.duration === 'number' ? `${data.duration.toFixed(0)}s` : '';
        const steps = (data.steps || []).map(step => {
            const stepDuration = typeof step.duration_seconds === 'number' ? `${step.duration_seconds.toFixed(0)}s` : '';
            const meta = stepDuration ? ` (${stepDuration})` : '';
            const error = step.error ? ` - ${step.error}` : '';
            return `${step.name}: ${step.success ? 'ok' : 'fail'}${meta}${error}`;
        });
        updateBuildSummary([{ ...data, success: false }]);
        addActivityItem(`Build failed: ${data.repo}${duration ? ' (' + duration + ')' : ''} - ${data.error || 'Unknown'}`, 'error', steps, {
            status: 'build',
            repo: data.repo,
            severity: 'error'
        });
    });

    socket.on('autonomous_build_skipped', (data) => {
        const remaining = data.cooldown_remaining ? ` (${data.cooldown_remaining}s cooldown)` : '';
        addActivityItem(`Build skipped: ${data.reason || 'cooldown'}${remaining}`, 'warning', null, {
            status: 'build',
            severity: 'warning'
        });
    });

    socket.on('autonomous_deploy_started', (data) => {
        const workspace = data.workspace ? ` (${data.workspace})` : '';
        addActivityItem(`Deploy started: ${data.repo}${workspace}`, 'info', null, {
            status: 'deploy',
            repo: data.repo
        });
    });

    socket.on('autonomous_deploy_success', (data) => {
        const details = (data.devices || []).map(device => {
            const status = device.success ? 'ok' : 'fail';
            const error = device.error ? ` - ${device.error}` : '';
            return `${device.device_id}: ${status}${error}`;
        });
        addActivityItem(`Deploy succeeded: ${data.repo}`, 'success', details, {
            status: 'deploy',
            repo: data.repo,
            severity: 'success'
        });
    });

    socket.on('autonomous_deploy_failed', (data) => {
        const details = (data.devices || []).map(device => {
            const status = device.success ? 'ok' : 'fail';
            const error = device.error ? ` - ${device.error}` : '';
            return `${device.device_id}: ${status}${error}`;
        });
        addActivityItem(`Deploy failed: ${data.repo} - ${data.error || 'Unknown'}`, 'error', details, {
            status: 'deploy',
            repo: data.repo,
            severity: 'error'
        });
    });

    socket.on('autonomous_deploy_skipped', (data) => {
        const remaining = data.cooldown_remaining ? ` (${data.cooldown_remaining}s cooldown)` : '';
        addActivityItem(`Deploy skipped: ${data.repo} - ${data.reason || 'cooldown'}${remaining}`, 'warning', null, {
            status: 'deploy',
            repo: data.repo,
            severity: 'warning'
        });
    });

    socket.on('autonomous_backoff_started', (data) => {
        const duration = data.backoff_seconds ? ` (${data.backoff_seconds}s)` : '';
        addActivityItem(`Backoff started: ${data.reason || 'failure'}${duration}`, 'warning', null, {
            status: 'system',
            severity: 'warning'
        });
    });

    socket.on('autonomous_halted', (data) => {
        addActivityItem(`Autonomy halted: ${data.reason || 'failure'} (streak ${data.failure_streak || 0})`, 'error', null, {
            status: 'system',
            severity: 'error'
        });
    });

    socket.on('autonomous_deploy_rollback', (data) => {
        const details = (data.devices || []).map(device => {
            const status = device.success ? 'ok' : 'fail';
            const error = device.error ? ` - ${device.error}` : '';
            return `${device.device_id}: ${status}${error}`;
        });
        addActivityItem(`Rollback attempted: ${data.repo}`, 'warning', details, {
            status: 'deploy',
            repo: data.repo,
            severity: 'warning'
        });
    });

    socket.on('autonomous_scan_complete', (data) => {
        addActivityItem(`Scan found ${data.tasks_found} tasks (queue: ${data.queue_size})`, 'info', null, {
            status: 'scan',
            repo: data.repo
        });
    });

    // Subagent Loop Events
    socket.on('subagent_loop_started', (data) => {
        addActivityItem(` Loop started: ${data.purpose || 'iteration'} (${data.max_iterations} iterations)`, 'info', null, {
            agent_id: data.agent_id,
            status: 'loop',
            severity: 'info'
        });
    });

    socket.on('subagent_loop_iteration', (data) => {
        addActivityItem(` Loop ${data.iteration}/${data.max_iterations}: ${data.result || 'in progress'}`, 'info', null, {
            agent_id: data.agent_id,
            status: 'loop'
        });
    });

    socket.on('subagent_loop_completed', (data) => {
        const statusIcon = data.status === 'success' ? '' : (data.status === 'timeout' ? '' : '');
        addActivityItem(`${statusIcon} Loop ${data.status}: ${data.final_result || ''} (${data.iterations_completed}/${data.iterations_requested} iterations)`, 
            data.status === 'success' ? 'success' : 'warning', null, {
            agent_id: data.agent_id,
            status: 'loop',
            severity: data.status === 'success' ? 'success' : 'warning'
        });
    });

    socket.on('subagent_loop_timeout', (data) => {
        addActivityItem(` Loop timed out after ${data.iterations_completed} iterations`, 'warning', null, {
            agent_id: data.agent_id,
            status: 'loop',
            severity: 'warning'
        });
    });

    socket.on('subagent_loop_cancelled', (data) => {
        addActivityItem(` Loop cancelled: ${data.reason || 'unknown'}`, 'warning', null, {
            agent_id: data.agent_id,
            status: 'loop',
            severity: 'warning'
        });
    });
}

// ============ Briefings System ============

let briefingsData = [];

async function loadBriefings() {
    const container = document.getElementById('briefings-list');
    if (!container) return;

    try {
        const response = await fetch('/api/briefings?limit=50');
        briefingsData = await response.json();

        // Update tab count
        const unreadCount = briefingsData.filter(b => !b.read).length;
        const countEl = document.getElementById('tab-count-briefings');
        if (countEl) {
            countEl.textContent = unreadCount > 0 ? unreadCount : briefingsData.length;
        }

        if (!briefingsData || briefingsData.length === 0) {
            container.innerHTML = `
                <div class="empty-state-small" style="text-align: center; padding: 40px;">
                    <span class="material-symbols-outlined" style="font-size: 48px; opacity: 0.3; display: block; margin-bottom: 12px;">summarize</span>
                    <p style="margin: 0; font-size: 1rem;">No briefings yet</p>
                    <p style="margin: 8px 0 0; font-size: 0.85rem; opacity: 0.6;">Briefings are generated automatically from agent activity</p>
                </div>`;
            return;
        }

        container.innerHTML = briefingsData.map(b => renderBriefingCard(b)).join('');
    } catch (error) {
        console.error('Failed to load briefings:', error);
        container.innerHTML = '<div class="empty-state-small">Failed to load briefings</div>';
    }
}

function renderBriefingCard(briefing) {
    const date = briefing.created_at ? new Date(briefing.created_at).toLocaleString() : (briefing.date || 'Unknown');
    const isUnread = !briefing.read;
    const isPriorityHigh = briefing.priority === 'high';
    const badgeType = briefing.type || 'daily';

    let sectionsHtml = '';
    if (briefing.sections && briefing.sections.length > 0) {
        sectionsHtml = '<div class="briefing-sections">' +
            briefing.sections.map(s => {
                let metricsHtml = '';
                if (s.metrics) {
                    const metrics = s.metrics;
                    metricsHtml = '<div class="briefing-metrics">';
                    if (metrics.completed !== undefined) metricsHtml += `<span class="briefing-metric completed">&#10003; ${metrics.completed} completed</span>`;
                    if (metrics.pending_review !== undefined) metricsHtml += `<span class="briefing-metric review">&#9733; ${metrics.pending_review} review</span>`;
                    if (metrics.blocked !== undefined) metricsHtml += `<span class="briefing-metric blocked">&#10007; ${metrics.blocked} blocked</span>`;
                    metricsHtml += '</div>';
                }
                return `<div class="briefing-section">
                    <div class="briefing-section-title">${escapeHtml(s.title || '')}</div>
                    <div class="briefing-section-content">${escapeHtml(s.content || '')}</div>
                    ${metricsHtml}
                </div>`;
            }).join('') + '</div>';
    }

    const projectName = briefing.metadata?.project_name || '';
    const deviceId = briefing.device_id || '';

    return `<div class="briefing-card ${isUnread ? 'unread' : ''} ${isPriorityHigh ? 'priority-high' : ''}" data-id="${briefing.id}">
        <div class="briefing-header">
            <h4 class="briefing-title">${escapeHtml(briefing.title || 'Briefing')}</h4>
            <div class="briefing-meta">
                <span class="briefing-badge ${badgeType}">${badgeType}</span>
                ${projectName ? `<span>${escapeHtml(projectName)}</span>` : ''}
                ${deviceId ? `<span>${escapeHtml(deviceId)}</span>` : ''}
                <span>${date}</span>
            </div>
        </div>
        <div class="briefing-summary">${escapeHtml(briefing.summary || '')}</div>
        ${sectionsHtml}
        <div class="briefing-actions">
            ${isUnread ? `<button onclick="markBriefingRead('${briefing.id}')">
                <span class="material-symbols-outlined">done</span> Mark Read
            </button>` : ''}
            <button onclick="deleteBriefing('${briefing.id}')">
                <span class="material-symbols-outlined">delete</span> Delete
            </button>
        </div>
    </div>`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function markBriefingRead(briefingId) {
    try {
        await fetch(`/api/briefings/${briefingId}/read`, { method: 'POST' });
        await loadBriefings();
    } catch (error) {
        console.error('Failed to mark briefing read:', error);
    }
}

async function deleteBriefing(briefingId) {
    if (!confirm('Delete this briefing?')) return;
    try {
        await fetch(`/api/briefings/${briefingId}`, { method: 'DELETE' });
        await loadBriefings();
    } catch (error) {
        console.error('Failed to delete briefing:', error);
    }
}

async function markAllBriefingsRead() {
    const unread = briefingsData.filter(b => !b.read);
    for (const b of unread) {
        try {
            await fetch(`/api/briefings/${b.id}/read`, { method: 'POST' });
        } catch (e) { /* continue */ }
    }
    await loadBriefings();
}

// Init autonomous system on page load
document.addEventListener('DOMContentLoaded', () => {
    // Initial status check
    pollAutonomousStatus();

    // Start polling
    autoStatusInterval = setInterval(pollAutonomousStatus, 5000);

    // Setup WebSocket listeners
    setupAutonomousWebSocket();

    // Check URL hash for briefings tab
    if (window.location.hash === '#briefings') {
        switchMainTab('briefings');
        loadBriefings();
    }

    // Load briefing count on page load
    fetch('/api/briefings?limit=50')
        .then(r => r.json())
        .then(data => {
            const unread = data.filter(b => !b.read).length;
            const countEl = document.getElementById('tab-count-briefings');
            if (countEl) countEl.textContent = unread > 0 ? unread : (data.length || '0');
        })
        .catch(() => {});
});

// ============ Predictive System Tab ============

function switchPredictiveSubTab(tabName) {
    document.querySelectorAll('[data-subtab]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.subtab === tabName);
    });
    document.querySelectorAll('.predictive-subtab').forEach(el => {
        el.style.display = el.id === `subtab-${tabName}` ? 'block' : 'none';
        if (el.id === `subtab-${tabName}`) el.classList.add('active');
        else el.classList.remove('active');
    });
}

async function loadPredictiveTab() {
    await Promise.all([
        loadPredictiveOverview(),
        loadRoutines(),
        loadPredictions(),
        loadLoopHistory()
    ]);
}

async function loadPredictiveOverview() {
    try {
        const resp = await fetch('/api/predictive/status');
        const data = await resp.json();

        document.getElementById('pred-routines-count').textContent = data.routines?.total || 0;
        document.getElementById('pred-predictions-count').textContent = data.predictions?.total || 0;
        document.getElementById('pred-loops-count').textContent = data.loops?.total || 0;

        const completed = data.loops?.completed || 0;
        const total = data.loops?.total || 0;
        if (total > 0) {
            document.getElementById('pred-loop-success-rate').textContent = Math.round((completed / total) * 100) + '%';
        } else {
            document.getElementById('pred-loop-success-rate').textContent = '-';
        }

        const countEl = document.getElementById('tab-count-predictive');
        const activeCount = (data.routines?.enabled || 0) + (data.loops?.running || 0);
        if (countEl) countEl.textContent = activeCount > 0 ? activeCount : '';
    } catch (e) {
        console.error('Failed to load predictive overview:', e);
    }
}

async function loadRoutines() {
    const container = document.getElementById('routines-list');
    try {
        const resp = await fetch('/api/predictive/routines');
        const routines = await resp.json();

        if (!routines.length) {
            container.innerHTML = '<div class="empty-state-small">No routines configured. Click "New Routine" to create one.</div>';
            return;
        }

        container.innerHTML = routines.map(r => `
            <div class="briefing-card ${r.enabled ? '' : 'opacity-50'}" style="${r.enabled ? '' : 'opacity: 0.5;'}">
                <div class="briefing-card-header">
                    <div class="briefing-card-title">
                        <span class="material-symbols-outlined" style="color: ${r.enabled ? 'var(--primary)' : 'var(--text-muted)'}">
                            ${r.enabled ? 'event_available' : 'event_busy'}
                        </span>
                        <div>
                            <h4>${escapeHtml(r.name)}</h4>
                            <div class="briefing-card-meta">
                                <span class="material-symbols-outlined" style="font-size: 14px;">schedule</span>
                                ${escapeHtml(r.cron_expression)}
                                ${r.last_run_at ? ' &middot; Last: ' + new Date(r.last_run_at).toLocaleString() : ' &middot; Never run'}
                                ${r.next_run_at ? ' &middot; Next: ' + new Date(r.next_run_at).toLocaleString() : ''}
                            </div>
                        </div>
                    </div>
                    <div class="briefing-card-actions" style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-small ${r.enabled ? 'btn-secondary' : 'btn-primary'}" onclick="toggleRoutine(${r.id}, ${!r.enabled})" title="${r.enabled ? 'Disable' : 'Enable'}">
                            <span class="material-symbols-outlined">${r.enabled ? 'pause' : 'play_arrow'}</span>
                        </button>
                        <button class="btn btn-small btn-danger" onclick="deleteRoutine(${r.id})" title="Delete">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>
                <div class="briefing-card-body" style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.85rem;">
                    ${escapeHtml(r.description || '')}
                </div>
            </div>
        `).join('');
    } catch (e) {
        container.innerHTML = '<div class="empty-state-small">Failed to load routines</div>';
        console.error('Failed to load routines:', e);
    }
}

async function loadPredictions() {
    const container = document.getElementById('predictions-list');
    try {
        const resp = await fetch('/api/predictive/predictions?limit=30');
        const predictions = await resp.json();

        if (!predictions.length) {
            container.innerHTML = '<div class="empty-state-small">No predictions yet. The predictive engine generates these automatically during agent cycles.</div>';
            return;
        }

        container.innerHTML = predictions.map(p => {
            const confidence = Math.round((p.confidence || 0) * 100);
            const outcomeColors = { pending: 'var(--text-muted)', accepted: 'var(--primary)', completed: 'var(--success)', rejected: 'var(--danger)', expired: 'var(--warning)' };
            const outcomeColor = outcomeColors[p.outcome] || 'var(--text-muted)';
            const signalIcons = { routine: 'event_repeat', project_activity: 'trending_up', code_health: 'healing', belief: 'psychology' };
            const icon = signalIcons[p.signal_type] || 'auto_awesome';

            let actionText = p.predicted_action || '';
            try {
                const parsed = JSON.parse(actionText);
                actionText = parsed.prompt || parsed.type || actionText;
            } catch (e) {}

            return `
                <div class="briefing-card">
                    <div class="briefing-card-header">
                        <div class="briefing-card-title">
                            <span class="material-symbols-outlined" style="color: ${outcomeColor}">${icon}</span>
                            <div>
                                <h4 style="font-size: 0.9rem;">${escapeHtml(actionText.substring(0, 120))}${actionText.length > 120 ? '...' : ''}</h4>
                                <div class="briefing-card-meta">
                                    <span style="color: ${outcomeColor}; font-weight: 600;">${(p.outcome || 'pending').toUpperCase()}</span>
                                    &middot; ${p.signal_type}
                                    &middot; Confidence: <strong>${confidence}%</strong>
                                    &middot; ${new Date(p.created_at).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        container.innerHTML = '<div class="empty-state-small">Failed to load predictions</div>';
        console.error('Failed to load predictions:', e);
    }
}

async function loadLoopHistory() {
    const container = document.getElementById('loops-list');
    try {
        const resp = await fetch('/api/predictive/loops?limit=30');
        const loops = await resp.json();

        if (!loops.length) {
            container.innerHTML = '<div class="empty-state-small">No loop executions yet. Loops are deployed automatically when the scoring system determines iterative execution is beneficial.</div>';
            return;
        }

        container.innerHTML = loops.map(l => {
            const statusColors = { completed: 'var(--success)', failed: 'var(--danger)', running: 'var(--primary)', pending: 'var(--text-muted)', stopped: 'var(--warning)' };
            const statusColor = statusColors[l.status] || 'var(--text-muted)';
            const statusIcons = { completed: 'check_circle', failed: 'error', running: 'sync', pending: 'hourglass_empty', stopped: 'stop_circle' };
            const icon = statusIcons[l.status] || 'all_inclusive';
            const score = l.deploy_score ? (l.deploy_score * 100).toFixed(0) + '%' : '-';

            return `
                <div class="briefing-card">
                    <div class="briefing-card-header">
                        <div class="briefing-card-title">
                            <span class="material-symbols-outlined" style="color: ${statusColor}">${icon}</span>
                            <div>
                                <h4 style="font-size: 0.9rem;">${escapeHtml((l.loop_prompt || '').substring(0, 120))}${(l.loop_prompt || '').length > 120 ? '...' : ''}</h4>
                                <div class="briefing-card-meta">
                                    <span style="color: ${statusColor}; font-weight: 600;">${(l.status || 'pending').toUpperCase()}</span>
                                    &middot; ${l.iteration_count || 0}/${l.max_iterations || 10} iterations
                                    &middot; Score: <strong>${score}</strong>
                                    &middot; ${l.started_at ? new Date(l.started_at).toLocaleString() : 'Not started'}
                                    ${l.completed_at ? ' &middot; Completed: ' + new Date(l.completed_at).toLocaleString() : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {
        container.innerHTML = '<div class="empty-state-small">Failed to load loop history</div>';
        console.error('Failed to load loop history:', e);
    }
}

async function toggleRoutine(id, enabled) {
    try {
        await fetch(`/api/predictive/routines/${id}/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled })
        });
        await loadRoutines();
        await loadPredictiveOverview();
        if (typeof showToast === 'function') showToast(`Routine ${enabled ? 'enabled' : 'disabled'}`, 'success');
    } catch (e) {
        console.error('Failed to toggle routine:', e);
        if (typeof showToast === 'function') showToast('Failed to toggle routine', 'error');
    }
}

async function deleteRoutine(id) {
    if (!confirm('Delete this routine?')) return;
    try {
        await fetch(`/api/predictive/routines/${id}`, { method: 'DELETE' });
        await loadRoutines();
        await loadPredictiveOverview();
        if (typeof showToast === 'function') showToast('Routine deleted', 'success');
    } catch (e) {
        console.error('Failed to delete routine:', e);
        if (typeof showToast === 'function') showToast('Failed to delete routine', 'error');
    }
}

function openCreateRoutineModal() {
    document.getElementById('create-routine-modal').classList.remove('hidden');
}

function closeCreateRoutineModal() {
    document.getElementById('create-routine-modal').classList.add('hidden');
}

async function confirmCreateRoutine() {
    const name = document.getElementById('routine-name').value.trim();
    const description = document.getElementById('routine-description').value.trim();
    const cron = document.getElementById('routine-cron').value.trim();
    const prompt = document.getElementById('routine-prompt').value.trim();
    const category = document.getElementById('routine-category').value;
    const priority = parseInt(document.getElementById('routine-priority').value) || 5;

    if (!name || !cron || !prompt) {
        if (typeof showToast === 'function') showToast('Name, schedule, and prompt are required', 'error');
        return;
    }

    try {
        const resp = await fetch('/api/predictive/routines', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name,
                description,
                cron_expression: cron,
                task_template: { type: category, prompt, category, priority }
            })
        });
        const data = await resp.json();
        if (data.success) {
            closeCreateRoutineModal();
            document.getElementById('routine-name').value = '';
            document.getElementById('routine-description').value = '';
            document.getElementById('routine-cron').value = '';
            document.getElementById('routine-prompt').value = '';
            await loadRoutines();
            await loadPredictiveOverview();
            if (typeof showToast === 'function') showToast('Routine created', 'success');
        } else {
            if (typeof showToast === 'function') showToast(data.error || 'Failed to create routine', 'error');
        }
    } catch (e) {
        console.error('Failed to create routine:', e);
        if (typeof showToast === 'function') showToast('Failed to create routine', 'error');
    }
}

// ==================== Monitoring Service Integration ====================

let monitoringInterval = null;

function startMonitoringPolling() {
    if (monitoringInterval) return;
    fetchMonitoringData();
    monitoringInterval = setInterval(fetchMonitoringData, 10000); // 10s
}

function stopMonitoringPolling() {
    if (monitoringInterval) {
        clearInterval(monitoringInterval);
        monitoringInterval = null;
    }
}

async function fetchMonitoringData() {
    try {
        const [snapRes, alertsRes, agentsRes, tasksRes, costRes] = await Promise.all([
            fetch('/api/monitoring/snapshot').then(r => r.json()).catch(() => null),
            fetch('/api/monitoring/alerts').then(r => r.json()).catch(() => null),
            fetch('/api/monitoring/agents').then(r => r.json()).catch(() => null),
            fetch('/api/monitoring/tasks').then(r => r.json()).catch(() => null),
            fetch('/api/monitoring/cost').then(r => r.json()).catch(() => null),
        ]);

        if (snapRes?.snapshot) updateSystemHealth(snapRes.snapshot);
        if (alertsRes?.active) updateAlertFeed(alertsRes.active);
        if (agentsRes?.agents) updateAgentHealthGrid(agentsRes.agents);
        if (tasksRes?.pipeline) updateTaskPipeline(tasksRes.pipeline);
        if (costRes?.cost) updateCostTracker(costRes.cost);
    } catch (e) {
        console.debug('Monitoring fetch error:', e);
    }
}

function updateSystemHealth(snap) {
    const sys = snap.system || {};
    const agents = snap.agents || {};

    // CPU
    const cpuPct = sys.cpu_percent || 0;
    const cpuEl = document.getElementById('metric-cpu');
    const cpuBar = document.getElementById('metric-cpu-bar');
    if (cpuEl) cpuEl.textContent = cpuPct.toFixed(1) + '%';
    if (cpuBar) {
        cpuBar.style.width = Math.min(cpuPct, 100) + '%';
        cpuBar.className = 'metric-bar-fill' + (cpuPct > 90 ? ' danger' : cpuPct > 75 ? ' warning' : '');
    }

    // Memory
    const memPct = sys.ram_percent || 0;
    const memUsed = sys.ram_used_gb || 0;
    const memTotal = sys.ram_total_gb || 0;
    const memEl = document.getElementById('metric-memory');
    const memBar = document.getElementById('metric-memory-bar');
    const memDetail = document.getElementById('metric-memory-detail');
    if (memEl) memEl.textContent = memPct.toFixed(0) + '%';
    if (memBar) {
        memBar.style.width = Math.min(memPct, 100) + '%';
        memBar.className = 'metric-bar-fill' + (memPct > 90 ? ' danger' : memPct > 80 ? ' warning' : '');
    }
    if (memDetail) memDetail.textContent = memUsed.toFixed(1) + ' / ' + memTotal.toFixed(1) + ' GB';

    // Disk
    const diskFree = sys.disk_free_gb || 0;
    const diskTotal = sys.disk_total_gb || 1;
    const diskPct = ((diskTotal - diskFree) / diskTotal * 100);
    const diskEl = document.getElementById('metric-disk');
    const diskBar = document.getElementById('metric-disk-bar');
    if (diskEl) diskEl.textContent = diskFree.toFixed(1) + ' GB';
    if (diskBar) {
        diskBar.style.width = Math.min(diskPct, 100) + '%';
        diskBar.className = 'metric-bar-fill' + (diskFree < 2 ? ' danger' : diskFree < 5 ? ' warning' : '');
    }

    // Threads
    const threads = sys.thread_count || 0;
    const threadsEl = document.getElementById('metric-threads');
    const threadsDetail = document.getElementById('metric-threads-detail');
    if (threadsEl) threadsEl.textContent = threads;
    if (threadsDetail) {
        const agentCount = agents.total || 0;
        threadsDetail.textContent = agentCount + ' agents active';
    }
}

function updateAgentHealthGrid(agents) {
    const grid = document.getElementById('agent-health-grid');
    if (!grid) return;
    if (!agents.length) {
        grid.innerHTML = '<div class="empty-state-small">No agents to display</div>';
        return;
    }
    const html = agents.map(a => {
        const status = (a.status || 'offline').toLowerCase();
        let cls = 'offline';
        if (status === 'idle') cls = 'idle';
        else if (status === 'working' || status === 'busy' || status === 'running') cls = 'working';
        else if (status === 'crashed' || status === 'error' || status === 'failed') cls = 'crashed';

        const label = (a.name || a.agent_id || '?').slice(0, 3).toUpperCase();
        const tooltipText = (a.name || a.agent_id || '?') + ' - ' + status;
        return `<div class="agent-tile ${cls}" title="${tooltipText}">
            ${label}
            <div class="agent-tile-tooltip">${tooltipText}</div>
        </div>`;
    }).join('');
    grid.innerHTML = html;
}

function updateTaskPipeline(pipeline) {
    const fields = {
        'pipeline-scanned': pipeline.scanned || 0,
        'pipeline-queued': pipeline.queued || pipeline.pending || 0,
        'pipeline-assigned': pipeline.assigned || 0,
        'pipeline-completed': pipeline.completed || 0,
        'pipeline-failed': pipeline.failed || 0,
    };
    for (const [id, val] of Object.entries(fields)) {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
    }

    // Update tab badge
    const total = (fields['pipeline-queued'] || 0) + (fields['pipeline-assigned'] || 0);
    const badge = document.getElementById('tab-count-monitor');
    if (badge) badge.textContent = total || '';
}

function updateCostTracker(cost) {
    const todayEl = document.getElementById('cost-today');
    const tasksEl = document.getElementById('cost-tasks');
    const perTaskEl = document.getElementById('cost-per-task');
    const budgetRow = document.getElementById('cost-budget-row');
    const budgetEl = document.getElementById('cost-budget');

    if (todayEl) todayEl.textContent = '$' + (cost.total_usd || 0).toFixed(2);
    if (tasksEl) tasksEl.textContent = cost.tasks_completed || 0;
    if (perTaskEl) perTaskEl.textContent = '$' + (cost.avg_cost_per_task || 0).toFixed(3);

    if (cost.budget_limit_usd && cost.budget_limit_usd > 0) {
        if (budgetRow) budgetRow.style.display = '';
        if (budgetEl) {
            const remaining = cost.budget_limit_usd - (cost.total_usd || 0);
            budgetEl.textContent = '$' + Math.max(remaining, 0).toFixed(2);
            budgetEl.style.color = remaining < 0 ? 'var(--error)' : '';
        }
    }
}

function updateAlertFeed(alerts) {
    const feed = document.getElementById('alert-feed');
    if (!feed) return;
    if (!alerts.length) {
        feed.innerHTML = '<div class="empty-state-small">No active alerts</div>';
        return;
    }
    const html = alerts.map(a => {
        const level = (a.level || 'info').toLowerCase();
        const time = a.fired_at ? new Date(a.fired_at).toLocaleTimeString() : '';
        return `<div class="alert-item ${level}">
            <div>${a.message || a.alert_type || 'Alert'}</div>
            <div class="alert-time">${time}</div>
        </div>`;
    }).join('');
    feed.innerHTML = html;
}

// Start monitoring when monitor tab is opened
const origSwitchMainTab = typeof switchMainTab === 'function' ? switchMainTab : null;
if (origSwitchMainTab) {
    const _origSwitch = switchMainTab;
    switchMainTab = function(tab) {
        _origSwitch(tab);
        if (tab === 'monitor') {
            startMonitoringPolling();
        } else {
            stopMonitoringPolling();
        }
    };
}
</script>
{% endblock %}
