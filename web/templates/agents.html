{% extends "base.html" %}

{% block title %}Shadow Web - Agents{% endblock %}
{% block page_title %}Agents{% endblock %}

{% block content %}
<!-- Overview Section (Always Visible) -->
<section class="overview-section">
    <h2 class="overview-title">Overview</h2>
    <div class="overview-cards">
        <div class="overview-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">smart_toy</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-total-agents">0</div>
                <div class="overview-card-label">Total Agents</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon active">
                <span class="material-symbols-outlined">play_circle</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-active-agents">0</div>
                <div class="overview-card-label">Active</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon">
                <span class="material-symbols-outlined">assignment</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-total-tasks">0</div>
                <div class="overview-card-label">Tasks</div>
            </div>
        </div>
        <div class="overview-card">
            <div class="overview-card-icon success">
                <span class="material-symbols-outlined">task_alt</span>
            </div>
            <div class="overview-card-content">
                <div class="overview-card-value" id="overview-completed-tasks">0</div>
                <div class="overview-card-label">Completed</div>
            </div>
        </div>
    </div>
</section>

<!-- Main Tabs (Android App Style) -->
<div class="main-tabs">
    <button class="tab-button active" data-tab="agents" onclick="switchMainTab('agents')">
        <span class="material-symbols-outlined">smart_toy</span>
        <span>Agents</span>
    </button>
    <button class="tab-button" data-tab="tasks" onclick="switchMainTab('tasks')">
        <span class="material-symbols-outlined">assignment</span>
        <span>Tasks</span>
    </button>
    <button class="tab-button" data-tab="monitor" onclick="switchMainTab('monitor')">
        <span class="material-symbols-outlined">monitor_heart</span>
        <span>Monitor</span>
    </button>
</div>

<!-- Agents Tab -->
<div id="tab-agents" class="main-tab-content active">
    <div class="tab-header">
        <h3>Active Agents</h3>
        <button class="btn btn-primary" onclick="showSpawnAgentModal()">
            <span class="material-symbols-outlined">add</span>
            Spawn Agent
        </button>
    </div>

    <div class="agents-grid" id="agents-grid">
        <div class="empty-state">
            <span class="material-symbols-outlined">smart_toy</span>
            <p>No agents running</p>
            <button class="btn btn-primary" onclick="showSpawnAgentModal()">Spawn Your First Agent</button>
        </div>
    </div>
</div>

<!-- Tasks Tab -->
<div id="tab-tasks" class="main-tab-content">
    <div class="tab-header">
        <h3>Tasks</h3>
        <button class="btn btn-primary" onclick="showCreateTaskModal()">
            <span class="material-symbols-outlined">add</span>
            New Task
        </button>
    </div>

    <div class="task-board">
        <div class="task-column">
            <div class="task-column-header">
                <h4>Pending</h4>
                <span class="task-count" id="pending-count">0</span>
            </div>
            <div class="task-list" id="pending-tasks"></div>
        </div>
        <div class="task-column">
            <div class="task-column-header">
                <h4>In Progress</h4>
                <span class="task-count" id="progress-count">0</span>
            </div>
            <div class="task-list" id="progress-tasks"></div>
        </div>
        <div class="task-column">
            <div class="task-column-header">
                <h4>Completed</h4>
                <span class="task-count" id="completed-count">0</span>
            </div>
            <div class="task-list" id="completed-tasks"></div>
        </div>
    </div>
</div>

<!-- Monitor Tab -->
<div id="tab-monitor" class="main-tab-content">
    <div class="tab-header">
        <h3>Activity Monitor</h3>
        <div class="monitor-controls">
            <span class="live-indicator">
                <span class="pulse"></span>
                LIVE
            </span>
            <button class="btn btn-small" onclick="clearActivityFeed()">
                <span class="material-symbols-outlined">clear_all</span>
                Clear
            </button>
        </div>
    </div>

    <div class="monitor-grid">
        <div class="monitor-section">
            <h4>Activity Feed</h4>
            <div class="activity-feed" id="activity-feed">
                <div class="empty-state-small">Waiting for agent activity...</div>
            </div>
        </div>
        <div class="monitor-section">
            <h4>System Metrics</h4>
            <div class="metrics-cards">
                <div class="metric-card">
                    <div class="metric-label">CPU Usage</div>
                    <div class="metric-value" id="metric-cpu">0%</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill" id="metric-cpu-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Memory Usage</div>
                    <div class="metric-value" id="metric-memory">0 MB</div>
                    <div class="metric-bar">
                        <div class="metric-bar-fill" id="metric-memory-bar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Processes</div>
                    <div class="metric-value" id="metric-processes">0</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Uptime</div>
                    <div class="metric-value" id="metric-uptime">0s</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->

<!-- Spawn Agent Modal -->
<div id="spawn-agent-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <span class="material-symbols-outlined">add_circle</span>
                Spawn Agent
            </h2>
            <button class="modal-close" onclick="closeSpawnAgentModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Agent Name</label>
                <input type="text" id="spawn-agent-name" class="form-input" placeholder="e.g., Code Reviewer">
            </div>
            <div class="form-group">
                <label>Specialty</label>
                <select id="spawn-agent-specialty" class="form-select">
                    <option value="general">General Assistant</option>
                    <option value="code_review">Code Review</option>
                    <option value="testing">Testing</option>
                    <option value="documentation">Documentation</option>
                    <option value="refactoring">Refactoring</option>
                    <option value="debugging">Debugging</option>
                    <option value="performance">Performance Optimization</option>
                    <option value="security">Security Analysis</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>CLI Provider</label>
                    <select id="spawn-agent-provider" class="form-select">
                        <option value="claude">Claude Code</option>
                        <option value="gemini">Gemini CLI</option>
                        <option value="codex">Codex</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Model</label>
                    <input type="text" id="spawn-agent-model" class="form-input" value="claude-sonnet-4-20250514">
                </div>
            </div>
            <div class="form-group">
                <label>Working Directory</label>
                <input type="text" id="spawn-agent-workdir" class="form-input" placeholder="C:/shadow">
            </div>
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="spawn-agent-auto-accept" checked>
                    <span>Auto-accept edits</span>
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeSpawnAgentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmSpawnAgent()">
                <span class="material-symbols-outlined">rocket_launch</span>
                Spawn
            </button>
        </div>
    </div>
</div>

<!-- Create Task Modal -->
<div id="create-task-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h2>
                <span class="material-symbols-outlined">add_task</span>
                Create Task
            </h2>
            <button class="modal-close" onclick="closeCreateTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Task Title</label>
                <input type="text" id="task-title" class="form-input" placeholder="e.g., Refactor authentication">
            </div>
            <div class="form-group">
                <label>Description</label>
                <textarea id="task-description" class="form-textarea" rows="3" placeholder="Task details..."></textarea>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Priority</label>
                    <select id="task-priority" class="form-select">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                        <option value="urgent">Urgent</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Assign To</label>
                    <select id="task-agent" class="form-select">
                        <option value="">Unassigned</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateTaskModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmCreateTask()">
                <span class="material-symbols-outlined">check</span>
                Create
            </button>
        </div>
    </div>
</div>

<!-- Assign Task Modal -->
<div id="assign-task-modal" class="modal hidden">
    <div class="modal-content modal-small">
        <div class="modal-header">
            <h2>
                <span class="material-symbols-outlined">assignment</span>
                Assign Task
            </h2>
            <button class="modal-close" onclick="closeAssignTaskModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Task Description</label>
                <textarea id="assign-task-input" class="form-textarea" rows="4" placeholder="Describe what the agent should do..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAssignTaskModal()">Cancel</button>
            <button class="btn btn-primary" onclick="confirmAssignTask()">
                <span class="material-symbols-outlined">send</span>
                Assign
            </button>
        </div>
    </div>
</div>

<style>
/* Overview Section */
.overview-section {
    margin-bottom: var(--spacing-xl);
}

.overview-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--text);
}

.overview-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
}

.overview-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    transition: all 0.2s ease;
}

.overview-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
}

.overview-card-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: var(--accent-container);
    display: flex;
    align-items: center;
    justify-content: center;
}

.overview-card-icon span {
    font-size: 28px;
    color: var(--accent);
}

.overview-card-icon.active span {
    color: var(--success);
}

.overview-card-icon.success span {
    color: var(--success);
}

.overview-card-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text);
    line-height: 1;
}

.overview-card-label {
    font-size: 0.9rem;
    color: var(--text-dim);
    margin-top: 4px;
}

/* Main Tabs (Android Style) */
.main-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: var(--spacing-lg);
    border-bottom: 2px solid var(--border);
    padding-bottom: 0;
}

.tab-button {
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    padding: var(--spacing-md) var(--spacing-lg);
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--text-dim);
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    bottom: -2px;
}

.tab-button:hover {
    color: var(--text);
    background: var(--bg-hover);
}

.tab-button.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
}

.tab-button .material-symbols-outlined {
    font-size: 22px;
}

/* Tab Content */
.main-tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.main-tab-content.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

.tab-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-lg);
}

.tab-header h3 {
    font-size: 1.3rem;
    font-weight: 600;
    color: var(--text);
}

/* Agents Grid (Card Style) */
.agents-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--spacing-lg);
}

.agent-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    transition: all 0.2s ease;
}

.agent-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
}

.agent-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.agent-card-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex: 1;
}

.agent-card-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--accent-container);
    display: flex;
    align-items: center;
    justify-content: center;
}

.agent-card-icon span {
    font-size: 24px;
    color: var(--accent);
}

.agent-card-title h4 {
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text);
}

.agent-card-subtitle {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-top: 2px;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-badge.idle {
    background: var(--text-dim);
    color: var(--bg);
}

.status-badge.busy {
    background: var(--warning);
    color: var(--bg);
}

.status-badge.error {
    background: var(--error);
    color: white;
}

.agent-metrics {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    background: var(--bg-hover);
    border-radius: var(--radius-md);
}

.agent-metric {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 0.85rem;
    color: var(--text-dim);
}

.agent-metric span.material-symbols-outlined {
    font-size: 16px;
}

.agent-current-task {
    padding: var(--spacing-sm);
    background: var(--bg-hover);
    border-left: 3px solid var(--warning);
    border-radius: var(--radius-md);
}

.agent-current-task strong {
    display: block;
    font-size: 0.8rem;
    color: var(--text-dim);
    margin-bottom: 4px;
}

.agent-output {
    background: #0d0d0d;
    color: #4af626;
    font-family: monospace;
    font-size: 0.75rem;
    padding: var(--spacing-sm);
    border-radius: var(--radius-md);
    max-height: 150px;
    overflow-y: auto;
    border: 1px solid var(--border);
}

.output-line {
    padding: 2px 0;
    word-break: break-all;
}

.output-line.stderr {
    color: #ff6b6b;
}

.agent-card-actions {
    display: flex;
    gap: var(--spacing-sm);
    margin-top: auto;
}

/* Task Board */
.task-board {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--spacing-lg);
}

@media (max-width: 1024px) {
    .task-board {
        grid-template-columns: 1fr;
    }
}

.task-column {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    display: flex;
    flex-direction: column;
    min-height: 400px;
}

.task-column-header {
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--bg-hover);
}

.task-column-header h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-dim);
}

.task-count {
    background: var(--accent-container);
    color: var(--accent);
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
}

.task-list {
    padding: var(--spacing-md);
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
}

.task-card {
    background: var(--bg-hover);
    border: 1px solid var(--border);
    border-left: 4px solid var(--accent);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    cursor: pointer;
    transition: all 0.2s ease;
}

.task-card:hover {
    transform: translateY(-2px);
    border-color: var(--accent);
}

.task-card.priority-high {
    border-left-color: var(--error);
}

.task-card.priority-urgent {
    border-left-color: #ff1744;
}

.task-card-title {
    font-weight: 600;
    margin-bottom: 8px;
}

.task-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 12px;
    font-size: 0.75rem;
    color: var(--text-dim);
}

/* Monitor Grid */
.monitor-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-lg);
}

@media (max-width: 1024px) {
    .monitor-grid {
        grid-template-columns: 1fr;
    }
}

.monitor-section {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
}

.monitor-section h4 {
    margin: 0 0 var(--spacing-md) 0;
    font-size: 1.1rem;
    font-weight: 600;
}

.activity-feed {
    max-height: 500px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.85rem;
}

.activity-item {
    padding: 8px;
    border-bottom: 1px solid var(--border);
}

.metrics-cards {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--spacing-md);
}

.metric-card {
    padding: var(--spacing-md);
    background: var(--bg-hover);
    border-radius: var(--radius-md);
}

.metric-label {
    font-size: 0.85rem;
    color: var(--text-dim);
    margin-bottom: 8px;
}

.metric-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text);
}

.metric-bar {
    height: 4px;
    background: var(--bg-card);
    border-radius: 2px;
    margin-top: 8px;
    overflow: hidden;
}

.metric-bar-fill {
    height: 100%;
    background: var(--accent);
    transition: width 0.3s ease;
}

.live-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--success);
    font-weight: 600;
    font-size: 0.9rem;
}

.pulse {
    width: 8px;
    height: 8px;
    background: var(--success);
    border-radius: 50%;
    animation: pulse-anim 1.5s infinite;
}

@keyframes pulse-anim {
    0%, 100% { transform: scale(0.95); opacity: 0.7; }
    50% { transform: scale(1.1); opacity: 1; }
}

.monitor-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: var(--spacing-xl);
    color: var(--text-dim);
}

.empty-state .material-symbols-outlined {
    font-size: 64px;
    color: var(--text-dim);
    margin-bottom: var(--spacing-md);
}

.empty-state p {
    margin: var(--spacing-md) 0;
    font-size: 1.1rem;
}

.empty-state-small {
    text-align: center;
    padding: var(--spacing-md);
    color: var(--text-dim);
    font-size: 0.9rem;
}

/* Form Styles */
.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-md);
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Responsive */
@media (max-width: 768px) {
    .overview-cards {
        grid-template-columns: repeat(2, 1fr);
    }

    .agents-grid {
        grid-template-columns: 1fr;
    }

    .form-row {
        grid-template-columns: 1fr;
    }

    .main-tabs {
        overflow-x: auto;
    }

    .tab-button span:not(.material-symbols-outlined) {
        display: none;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/agents.js') }}"></script>
<script>
// Main tab switching
function switchMainTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
    });

    // Update tab content
    document.querySelectorAll('.main-tab-content').forEach(content => {
        content.classList.toggle('active', content.id === `tab-${tabName}`);
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
    // Connect to agent orchestrator
    if (typeof orchestrator !== 'undefined') {
        orchestrator.connect();

        // Override updateAgentUI to use new grid
        orchestrator.updateAgentUI = function() {
            const container = document.getElementById('agents-grid');
            if (!container) return;

            if (this.agents.size === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="material-symbols-outlined">smart_toy</span>
                        <p>No agents running</p>
                        <button class="btn btn-primary" onclick="showSpawnAgentModal()">Spawn Your First Agent</button>
                    </div>
                `;
            } else {
                container.innerHTML = Array.from(this.agents.values())
                    .map(agent => renderAgentCard(agent))
                    .join('');
            }

            updateOverview();
        };

        // Update overview metrics every 5 seconds
        setInterval(updateOverview, 5000);
    }
});

// Render agent card (Android style)
function renderAgentCard(agent) {
    const statusClass = agent.status || 'idle';
    return `
        <div class="agent-card" id="agent-${agent.id}">
            <div class="agent-card-header">
                <div class="agent-card-title">
                    <div class="agent-card-icon">
                        <span class="material-symbols-outlined">smart_toy</span>
                    </div>
                    <div>
                        <h4>${escapeHtml(agent.name)}</h4>
                        <div class="agent-card-subtitle">${escapeHtml(agent.specialty)}</div>
                    </div>
                </div>
                <span class="status-badge ${statusClass}">${statusClass.toUpperCase()}</span>
            </div>

            <div class="agent-metrics">
                <div class="agent-metric">
                    <span class="material-symbols-outlined">memory</span>
                    <span>${agent.cpu_percent || 0}% CPU</span>
                </div>
                <div class="agent-metric">
                    <span class="material-symbols-outlined">storage</span>
                    <span>${agent.memory_mb || 0} MB</span>
                </div>
                <div class="agent-metric">
                    <span class="material-symbols-outlined">schedule</span>
                    <span>${formatUptime(agent.uptime_seconds)}</span>
                </div>
                <div class="agent-metric">
                    <span class="material-symbols-outlined">task_alt</span>
                    <span>${agent.tasks_completed || 0} tasks</span>
                </div>
            </div>

            ${agent.current_task ? `
                <div class="agent-current-task">
                    <strong>Current Task:</strong>
                    ${escapeHtml(agent.current_task)}
                </div>
            ` : ''}

            <div class="agent-output" id="agent-output-${agent.id}">
                ${(agent.output_lines || []).map(line =>
                    `<div class="output-line">${escapeHtml(line.line)}</div>`
                ).join('')}
            </div>

            <div class="agent-card-actions">
                <button class="btn btn-small" onclick="showAssignTaskModal('${agent.id}')">
                    <span class="material-symbols-outlined">assignment</span>
                    Assign
                </button>
                <button class="btn btn-small btn-secondary" onclick="orchestrator.getAgentStatus('${agent.id}')">
                    <span class="material-symbols-outlined">refresh</span>
                </button>
                <button class="btn btn-small btn-danger" onclick="confirmStopAgent('${agent.id}')">
                    <span class="material-symbols-outlined">stop_circle</span>
                    Stop
                </button>
            </div>
        </div>
    `;
}

// Update overview metrics
function updateOverview() {
    if (typeof orchestrator === 'undefined') return;

    const totalAgents = orchestrator.agents.size;
    const activeAgents = Array.from(orchestrator.agents.values())
        .filter(a => a.status === 'busy').length;

    document.getElementById('overview-total-agents').textContent = totalAgents;
    document.getElementById('overview-active-agents').textContent = activeAgents;

    // Calculate total tasks and completed
    let totalTasks = 0;
    let completedTasks = 0;
    orchestrator.agents.forEach(agent => {
        completedTasks += agent.tasks_completed || 0;
        if (agent.current_task) totalTasks++;
    });
    totalTasks += completedTasks;

    document.getElementById('overview-total-tasks').textContent = totalTasks;
    document.getElementById('overview-completed-tasks').textContent = completedTasks;

    // Update system metrics
    let totalCpu = 0;
    let totalMemory = 0;
    orchestrator.agents.forEach(agent => {
        totalCpu += agent.cpu_percent || 0;
        totalMemory += agent.memory_mb || 0;
    });

    document.getElementById('metric-cpu').textContent = `${totalCpu.toFixed(1)}%`;
    document.getElementById('metric-cpu-bar').style.width = `${Math.min(totalCpu, 100)}%`;
    document.getElementById('metric-memory').textContent = `${totalMemory.toFixed(0)} MB`;
    document.getElementById('metric-memory-bar').style.width = `${Math.min(totalMemory / 10, 100)}%`;
    document.getElementById('metric-processes').textContent = totalAgents;

    // Calculate max uptime
    let maxUptime = 0;
    orchestrator.agents.forEach(agent => {
        if (agent.uptime_seconds > maxUptime) maxUptime = agent.uptime_seconds;
    });
    document.getElementById('metric-uptime').textContent = formatUptime(maxUptime);
}

// Format uptime
function formatUptime(seconds) {
    if (!seconds) return '0s';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;

    if (hours > 0) return `${hours}h ${minutes}m`;
    if (minutes > 0) return `${minutes}m ${secs}s`;
    return `${secs}s`;
}

// Activity feed
function clearActivityFeed() {
    document.getElementById('activity-feed').innerHTML = '<div class="empty-state-small">Feed cleared</div>';
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Task management (placeholder)
function showCreateTaskModal() {
    document.getElementById('create-task-modal').classList.remove('hidden');
}

function closeCreateTaskModal() {
    document.getElementById('create-task-modal').classList.add('hidden');
}

function confirmCreateTask() {
    // TODO: Implement task creation
    closeCreateTaskModal();
}
</script>
{% endblock %}
