{% extends "base.html" %}

{% block title %}Shadow Web - Agents{% endblock %}
{% block page_title %}Agent Team{% endblock %}

{% block content %}
<!-- Agent Metrics -->
<div class="stats-grid small">
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="total-agents">-</span>
            <span class="stat-label">Total Agents</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="active-agents">-</span>
            <span class="stat-label">Active</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="idle-agents">-</span>
            <span class="stat-label">Idle</span>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-value" id="tasks-completed">-</span>
            <span class="stat-label">Tasks Done</span>
        </div>
    </div>
</div>

<!-- Agent Cards -->
<section class="section">
    <h2>Agent Roster</h2>
    <div class="agents-grid" id="agents-container">
        <div class="loading">Loading agents...</div>
    </div>
</section>

<!-- Active Tasks -->
<section class="section">
    <h2>Active Tasks</h2>
    <div class="tasks-list" id="active-tasks">
        <div class="empty-state">No active tasks</div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Refresh interval for auto-updates (30 seconds)
const REFRESH_INTERVAL_MS = 30000;
// Maximum retry attempts
const MAX_RETRIES = 3;
// Delay between retries (exponential backoff base)
const RETRY_DELAY_MS = 1000;

let refreshTimer = null;
let isLoading = false;

document.addEventListener('DOMContentLoaded', function() {
    loadAll();
    // Start auto-refresh
    refreshTimer = setInterval(loadAll, REFRESH_INTERVAL_MS);
});

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (refreshTimer) {
        clearInterval(refreshTimer);
    }
});

async function loadAll() {
    if (isLoading) return; // Prevent concurrent loads
    isLoading = true;

    try {
        await Promise.all([
            loadAgents(),
            loadMetrics()
        ]);
    } finally {
        isLoading = false;
    }
}

async function fetchWithRetry(fetchFn, retries = MAX_RETRIES) {
    let lastError;
    for (let attempt = 0; attempt < retries; attempt++) {
        try {
            return await fetchFn();
        } catch (error) {
            lastError = error;
            console.warn(`Attempt ${attempt + 1} failed:`, error.message);
            if (attempt < retries - 1) {
                // Exponential backoff
                await new Promise(resolve =>
                    setTimeout(resolve, RETRY_DELAY_MS * Math.pow(2, attempt))
                );
            }
        }
    }
    throw lastError;
}

async function loadAgents() {
    const container = document.getElementById('agents-container');

    try {
        const agents = await fetchWithRetry(() => api.getAgents());

        if (!agents || agents.length === 0) {
            container.innerHTML = '<div class="empty-state">No agents configured</div>';
            updateActiveTasks([]);
            return;
        }

        container.innerHTML = agents.map(a => `
            <div class="agent-card" data-agent-id="${escapeHtml(a.id || '')}">
                <div class="agent-header">
                    <div class="agent-avatar">${(a.name || '?').charAt(0)}</div>
                    <div class="agent-info">
                        <div class="agent-name">${escapeHtml(a.name || 'Unknown')}</div>
                        <span class="status-badge ${escapeHtml(a.status || 'unknown')}">${escapeHtml(a.status || 'unknown')}</span>
                    </div>
                </div>
                <div class="agent-specialty">${escapeHtml(a.specialty || 'General purpose')}</div>
                ${a.current_task ? `
                    <div class="agent-task">
                        <span class="task-label">Current:</span>
                        <span class="task-name">${escapeHtml(a.current_task)}</span>
                    </div>
                ` : ''}
                <div class="agent-stats">
                    <span>${a.tasks_completed || 0} tasks completed</span>
                </div>
            </div>
        `).join('');

        // Update active tasks
        const activeTasks = agents
            .filter(a => a.current_task)
            .map(a => ({
                agent: a.name,
                task: a.current_task
            }));
        updateActiveTasks(activeTasks);

    } catch (error) {
        console.error('Failed to load agents:', error);
        container.innerHTML = `
            <div class="error-state">
                <span class="error-icon">!</span>
                <span class="error-message">Failed to load agents</span>
                <button class="retry-btn" onclick="loadAgents()">Retry</button>
            </div>
        `;
    }
}

function updateActiveTasks(activeTasks) {
    const tasksContainer = document.getElementById('active-tasks');
    if (!activeTasks || activeTasks.length === 0) {
        tasksContainer.innerHTML = '<div class="empty-state">No active tasks</div>';
    } else {
        tasksContainer.innerHTML = activeTasks.map(t => `
            <div class="task-item">
                <span class="task-agent">${escapeHtml(t.agent || 'Unknown')}</span>
                <span class="task-name">${escapeHtml(t.task || 'Unknown task')}</span>
            </div>
        `).join('');
    }
}

async function loadMetrics() {
    try {
        const metrics = await fetchWithRetry(() => api.getAgentMetrics());
        document.getElementById('total-agents').textContent = metrics.total_agents || 0;
        document.getElementById('active-agents').textContent = metrics.active_agents || 0;
        document.getElementById('idle-agents').textContent = metrics.idle_agents || 0;
        document.getElementById('tasks-completed').textContent = metrics.total_tasks_completed || 0;
    } catch (error) {
        console.error('Failed to load metrics:', error);
        // Show error indicator but don't replace existing values
        document.getElementById('total-agents').textContent = '-';
        document.getElementById('active-agents').textContent = '-';
        document.getElementById('idle-agents').textContent = '-';
        document.getElementById('tasks-completed').textContent = '-';
    }
}
</script>
{% endblock %}
