{% extends "base.html" %}

{% block title %}Shadow Web - Audio{% endblock %}
{% block page_title %}Audio{% endblock %}

{% block content %}
<div class="page-actions">
    <button class="btn btn-primary" onclick="showAudioModal()">
        <span class="material-symbols-outlined">graphic_eq</span> Generate Audio
    </button>
    <button class="btn btn-secondary" onclick="refreshAudio()">Refresh</button>
</div>

<div id="audio-service-banner" class="info-banner hidden">
    <div class="info-banner-content">
        <span class="material-symbols-outlined">warning</span>
        <span id="audio-service-message">Audio service unavailable</span>
    </div>
    <button class="btn btn-small btn-primary" onclick="runAudioSetup()">Install</button>
</div>

<div id="active-audio-panel" class="batch-progress-panel hidden">
    <div class="batch-progress-header">
        <span class="material-symbols-outlined">autorenew</span>
        <span id="active-audio-prompt" class="batch-prompt-text">Generating...</span>
        <span id="active-audio-progress" class="batch-count">0%</span>
    </div>
    <div class="batch-progress-bar-container">
        <div id="active-audio-bar" class="batch-progress-bar" style="width: 0%"></div>
    </div>
    <div class="batch-progress-footer">
        <span id="active-audio-stage">Preparing...</span>
        <button class="btn btn-small btn-secondary" onclick="stopAudioPolling()">Hide</button>
    </div>
    <div id="active-audio-error" class="error-message hidden"></div>
</div>

<div class="audio-layout">
    <section class="section">
        <div class="section-header">
            <h2>Now Playing</h2>
        </div>
        <div class="audio-player-card">
            <div class="audio-player-meta">
                <div class="audio-player-title" id="player-title">No audio selected</div>
                <div class="audio-player-subtitle" id="player-subtitle">Generate or select a clip</div>
            </div>
            <audio id="audio-player" controls class="audio-player"></audio>
        </div>
    </section>

    <section class="section">
        <div class="section-header">
            <h2>Recent Generations</h2>
        </div>
        <div id="audio-history" class="audio-history-list">
            <div class="loading">Loading audio history...</div>
        </div>
    </section>
</div>

<div id="audio-modal" class="modal hidden">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2><span class="material-symbols-outlined">music_note</span> Generate Audio</h2>
            <button class="modal-close" onclick="closeAudioModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="audio-prompt">Prompt *</label>
                <textarea id="audio-prompt" class="form-input" rows="3" placeholder="A dreamy synthwave track with soft pads and slow drums..."></textarea>
            </div>

            <div class="form-row">
                <div class="form-group form-half">
                    <label for="audio-mode">Mode</label>
                    <select id="audio-mode" class="form-input" onchange="updateAudioModels()">
                        <option value="music">Music</option>
                        <option value="sfx">Sound Effects</option>
                    </select>
                </div>
                <div class="form-group form-half">
                    <label for="audio-model">Model</label>
                    <select id="audio-model" class="form-input"></select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group form-half">
                    <label for="audio-duration">Duration (seconds)</label>
                    <input id="audio-duration" type="number" class="form-input" min="2" max="30" value="8">
                </div>
                <div class="form-group form-half">
                    <label for="audio-temperature">Creativity</label>
                    <input id="audio-temperature" type="range" class="form-range" min="0.2" max="2.0" step="0.1" value="1.0" oninput="updateTemperatureLabel()">
                    <div class="range-label" id="audio-temperature-label">1.0 (balanced)</div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group form-half">
                    <label for="audio-top-k">Top-k</label>
                    <input id="audio-top-k" type="number" class="form-input" min="50" max="500" value="250">
                </div>
                <div class="form-group form-half">
                    <label for="audio-top-p">Top-p</label>
                    <input id="audio-top-p" type="number" class="form-input" min="0" max="1" step="0.05" value="0.0">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAudioModal()">Cancel</button>
            <button class="btn btn-primary" onclick="startAudioGeneration()">
                <span class="material-symbols-outlined">play_arrow</span> Generate
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let audioModels = {};
let activeAudioId = null;
let audioPollInterval = null;

document.addEventListener('DOMContentLoaded', function() {
    loadAudioModels();
    loadAudioHistory();
    checkAudioService();
});

function showAudioModal() {
    document.getElementById('audio-modal').classList.remove('hidden');
}

function closeAudioModal() {
    document.getElementById('audio-modal').classList.add('hidden');
}

function updateTemperatureLabel() {
    const value = parseFloat(document.getElementById('audio-temperature').value);
    let label = 'balanced';
    if (value < 0.7) label = 'focused';
    if (value > 1.3) label = 'wild';
    document.getElementById('audio-temperature-label').textContent = `${value.toFixed(1)} (${label})`;
}

async function loadAudioModels() {
    try {
        const response = await fetch('/audio/models');
        const data = await response.json();
        audioModels = data.data || {};
        updateAudioModels();
    } catch (err) {
        console.error('Audio model load failed:', err);
    }
}

function updateAudioModels() {
    const mode = document.getElementById('audio-mode').value;
    const modelSelect = document.getElementById('audio-model');
    modelSelect.innerHTML = '';

    (audioModels[mode] || []).forEach(model => {
        const option = document.createElement('option');
        option.value = model.id;
        option.textContent = `${model.name} (max ${model.max_duration}s)`;
        modelSelect.appendChild(option);
    });
}

async function checkAudioService() {
    try {
        const response = await fetch('/audio/status');
        const data = await response.json();
        const service = data.service || {};

        const banner = document.getElementById('audio-service-banner');
        if (!service.ready) {
            banner.classList.remove('hidden');
            document.getElementById('audio-service-message').textContent =
                'Audio dependencies missing. Install to enable generation.';
        } else {
            banner.classList.add('hidden');
        }
    } catch (err) {
        console.error('Audio status error:', err);
    }
}

async function runAudioSetup() {
    try {
        const response = await fetch('/audio/setup', { method: 'POST' });
        const data = await response.json();
        showToast(data.message || 'Audio setup started', 'info');
        checkAudioService();
    } catch (err) {
        showToast('Audio setup failed: ' + err.message, 'error');
    }
}

async function startAudioGeneration() {
    const prompt = document.getElementById('audio-prompt').value.trim();
    if (!prompt) {
        showToast('Please enter a prompt', 'warning');
        return;
    }

    const payload = {
        prompt: prompt,
        mode: document.getElementById('audio-mode').value,
        model: document.getElementById('audio-model').value,
        duration: parseFloat(document.getElementById('audio-duration').value),
        temperature: parseFloat(document.getElementById('audio-temperature').value),
        top_k: parseInt(document.getElementById('audio-top-k').value, 10),
        top_p: parseFloat(document.getElementById('audio-top-p').value),
    };

    try {
        const response = await fetch('/audio/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const data = await response.json();

        if (data.success) {
            activeAudioId = data.generation_id;
            closeAudioModal();
            showActiveAudioPanel(prompt);
            startAudioPolling();
            showToast('Audio generation started', 'success');
        } else {
            showToast('Failed: ' + (data.error || 'Unknown error'), 'error');
        }
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
}

function showActiveAudioPanel(prompt) {
    const panel = document.getElementById('active-audio-panel');
    panel.classList.remove('hidden');
    document.getElementById('active-audio-prompt').textContent =
        prompt.length > 50 ? prompt.slice(0, 50) + '...' : prompt;
    document.getElementById('active-audio-stage').textContent = 'Preparing...';
    document.getElementById('active-audio-progress').textContent = '0%';
    document.getElementById('active-audio-bar').style.width = '0%';
    document.getElementById('active-audio-error').classList.add('hidden');
}

function startAudioPolling() {
    stopAudioPolling();
    audioPollInterval = setInterval(pollAudioStatus, 2000);
}

function stopAudioPolling() {
    if (audioPollInterval) {
        clearInterval(audioPollInterval);
        audioPollInterval = null;
    }
}

async function pollAudioStatus() {
    if (!activeAudioId) return;

    try {
        const response = await fetch(`/audio/status/${activeAudioId}`);
        const data = await response.json();

        if (data.error) {
            document.getElementById('active-audio-error').textContent = data.error;
            document.getElementById('active-audio-error').classList.remove('hidden');
            stopAudioPolling();
            return;
        }

        const progress = data.progress || 0;
        document.getElementById('active-audio-progress').textContent = `${progress}%`;
        document.getElementById('active-audio-bar').style.width = `${progress}%`;
        document.getElementById('active-audio-stage').textContent = data.message || data.status || 'Processing';

        if (data.status === 'completed') {
            stopAudioPolling();
            activeAudioId = null;
            if (data.stream_url) {
                playAudio({
                    stream_url: data.stream_url,
                    prompt: data.prompt || 'Generated audio',
                    model: data.model || '',
                    duration: data.duration || ''
                });
            }
            loadAudioHistory();
            showToast('Audio ready', 'success');
        } else if (data.status === 'failed') {
            stopAudioPolling();
            activeAudioId = null;
            document.getElementById('active-audio-error').textContent = data.error || 'Generation failed';
            document.getElementById('active-audio-error').classList.remove('hidden');
        }
    } catch (err) {
        console.error('Audio status error:', err);
    }
}

async function loadAudioHistory() {
    try {
        const response = await fetch('/audio/history');
        const data = await response.json();
        renderAudioHistory(data.data || []);
    } catch (err) {
        document.getElementById('audio-history').innerHTML =
            '<div class="error-message">Failed to load audio history</div>';
    }
}

function renderAudioHistory(items) {
    const container = document.getElementById('audio-history');

    if (!items || items.length === 0) {
        container.innerHTML = '<div class="empty-state">No audio generated yet</div>';
        return;
    }

    container.innerHTML = items.map(item => `
        <div class="audio-history-item">
            <div class="audio-history-info">
                <div class="audio-history-title">${escapeHtml(item.prompt || 'Untitled')}</div>
                <div class="audio-history-meta">
                    <span>${escapeHtml(item.model || '')}</span>
                    <span class="separator">|</span>
                    <span>${item.mode || 'music'}</span>
                    <span class="separator">|</span>
                    <span>${item.duration || 0}s</span>
                </div>
            </div>
            <div class="audio-history-actions">
                <button class="btn btn-small" onclick='playAudio(${JSON.stringify(item)})'>
                    <span class="material-symbols-outlined">play_arrow</span> Play
                </button>
            </div>
        </div>
    `).join('');
}

function playAudio(item) {
    const player = document.getElementById('audio-player');
    if (!item || !item.stream_url) {
        showToast('Audio file unavailable', 'warning');
        return;
    }

    document.getElementById('player-title').textContent = item.prompt || 'Generated audio';
    document.getElementById('player-subtitle').textContent = `${item.model || ''} â€¢ ${item.duration || 0}s`;
    player.src = item.stream_url;
    player.play();
}

function refreshAudio() {
    loadAudioHistory();
    checkAudioService();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}
</script>

<style>
.audio-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
}

@media (max-width: 1200px) {
    .audio-layout {
        grid-template-columns: 1fr;
    }
}

.audio-player-card {
    background: var(--card-bg, var(--glass-bg));
    border: 1px solid var(--border-color, var(--glass-border));
    border-radius: 12px;
    padding: 16px;
}

.audio-player-meta {
    margin-bottom: 12px;
}

.audio-player-title {
    font-weight: 600;
    font-size: 16px;
}

.audio-player-subtitle {
    color: var(--text-muted);
    font-size: 13px;
}

.audio-player {
    width: 100%;
}

.audio-history-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
}

.audio-history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    padding: 12px 16px;
}

.audio-history-title {
    font-weight: 600;
    margin-bottom: 4px;
}

.audio-history-meta {
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    align-items: center;
    gap: 6px;
}

.audio-history-meta .separator {
    opacity: 0.5;
}

.info-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 16px;
    border-radius: 10px;
    background: rgba(255, 183, 77, 0.12);
    border: 1px solid rgba(255, 183, 77, 0.3);
    margin-bottom: 16px;
}

.info-banner.hidden {
    display: none;
}

.info-banner-content {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--warning);
}

.range-label {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 4px;
}
</style>
{% endblock %}
