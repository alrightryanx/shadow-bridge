{% extends "base.html" %}

{% block title %}Shadow Web - Ouroboros Pipeline{% endblock %}
{% block page_title %}Ouroboros Pipeline{% endblock %}

{% block content %}
<!-- Pipeline Status Cards -->
<section class="section">
    <h2>Pipeline Status</h2>
    <div class="ouro-status-grid">
        <div class="ouro-card">
            <div class="ouro-card-icon" id="refiner-icon">
                <span class="material-symbols-outlined">autorenew</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Refiner</div>
                <div class="ouro-card-value" id="refiner-state">--</div>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon neutral">
                <span class="material-symbols-outlined">schedule</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Last Run</div>
                <div class="ouro-card-value" id="last-run">--</div>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon neutral">
                <span class="material-symbols-outlined">task_alt</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Issues Processed</div>
                <div class="ouro-card-value" id="processed-count">--</div>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon" id="adb-icon">
                <span class="material-symbols-outlined">smartphone</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">ADB Device</div>
                <div class="ouro-card-value" id="adb-state">--</div>
            </div>
        </div>
    </div>
</section>

<!-- External Integration -->
<section class="section">
    <h2>External Telemetry Ingestion</h2>
    <div class="ouro-integration-grid">
        <div class="ouro-card">
            <div class="ouro-card-icon neutral" style="background:rgba(66,133,244,0.15);color:#4285f4">
                <span class="material-symbols-outlined">google</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Android Vitals</div>
                <div class="ouro-card-value" style="font-size:14px">Google Play Store</div>
                <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="syncExternal('vitals')">
                    <span class="material-symbols-outlined" style="font-size:16px">sync</span> Sync
                </button>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon neutral" style="background:rgba(255,202,40,0.15);color:#ffca28">
                <span class="material-symbols-outlined">firebase</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Crashlytics</div>
                <div class="ouro-card-value" style="font-size:14px">Firebase Console</div>
                <button class="btn btn-secondary btn-sm" style="margin-top:8px" onclick="syncExternal('crashlytics')">
                    <span class="material-symbols-outlined" style="font-size:16px">sync</span> Sync
                </button>
            </div>
        </div>
        <div class="ouro-card" style="opacity:0.6">
            <div class="ouro-card-icon neutral">
                <span class="material-symbols-outlined">settings_suggest</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Configuration</div>
                <div class="ouro-card-value" style="font-size:14px">Set API Keys</div>
                <button class="btn btn-secondary btn-sm" style="margin-top:8px" disabled>
                    <span class="material-symbols-outlined" style="font-size:16px">settings</span> Manage
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Health Feedback -->
<section class="section">
    <h2>Health Feedback</h2>
    <div class="ouro-health-grid">
        <div class="ouro-card ouro-health-score-card">
            <div class="ouro-health-ring-wrap">
                <svg class="ouro-health-ring" viewBox="0 0 80 80">
                    <circle cx="40" cy="40" r="34" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="6"/>
                    <circle id="health-ring-fg" cx="40" cy="40" r="34" fill="none"
                            stroke="#22c55e" stroke-width="6" stroke-linecap="round"
                            stroke-dasharray="213.6" stroke-dashoffset="213.6"
                            transform="rotate(-90 40 40)"/>
                    <text x="40" y="44" text-anchor="middle" fill="var(--text-primary)"
                          font-size="18" font-weight="700" id="health-ring-text">--</text>
                </svg>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Health Score</div>
                <div class="ouro-card-value" id="health-status-text">--</div>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon neutral">
                <span class="material-symbols-outlined">warning</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Active Alerts</div>
                <div class="ouro-card-value" id="health-alerts-count">--</div>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon" id="fix-verified-icon" style="background:rgba(34,197,94,0.15);color:#22c55e">
                <span class="material-symbols-outlined">verified</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Verified Fixes</div>
                <div class="ouro-card-value" id="fix-verified-count">--</div>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon" id="fix-pending-icon" style="background:rgba(245,158,11,0.15);color:#f59e0b">
                <span class="material-symbols-outlined">hourglass_top</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Pending</div>
                <div class="ouro-card-value" id="fix-pending-count">--</div>
            </div>
        </div>
        <div class="ouro-card">
            <div class="ouro-card-icon" id="fix-regressed-icon" style="background:rgba(239,68,68,0.15);color:#ef4444">
                <span class="material-symbols-outlined">error</span>
            </div>
            <div class="ouro-card-body">
                <div class="ouro-card-label">Regressed</div>
                <div class="ouro-card-value" id="fix-regressed-count">--</div>
            </div>
        </div>
    </div>
</section>

<!-- Open Issues -->
<section class="section">
    <h2>Open Issues <span class="ouro-count-badge" id="issues-badge"></span></h2>
    <div id="issues-container" class="ouro-issues-list">
        <div class="empty-state">Loading issues...</div>
    </div>
</section>

<!-- Fix History -->
<section class="section">
    <h2>Fix History <span class="ouro-count-badge" id="fixes-badge"></span></h2>
    <div id="fixes-container" class="ouro-fixes-list">
        <div class="empty-state">Loading fix history...</div>
    </div>
</section>

<!-- Recent Activity -->
<section class="section">
    <h2>Recent Activity</h2>
    <div id="activity-container" class="ouro-activity-list">
        <div class="empty-state">Loading activity...</div>
    </div>
</section>

<!-- Live Log -->
<section class="section">
    <div class="ouro-log-header" onclick="toggleLogPanel()">
        <h2>Live Log</h2>
        <span class="material-symbols-outlined" id="log-toggle-icon">expand_more</span>
    </div>
    <div id="log-panel" class="ouro-log-panel collapsed">
        <div class="ouro-log-toolbar">
            <button class="btn btn-secondary btn-sm" onclick="refreshLog()">
                <span class="material-symbols-outlined" style="font-size:16px">refresh</span> Refresh
            </button>
            <select id="log-lines-select" onchange="refreshLog()">
                <option value="30">30 lines</option>
                <option value="50" selected>50 lines</option>
                <option value="100">100 lines</option>
                <option value="200">200 lines</option>
            </select>
        </div>
        <pre id="log-content" class="ouro-log-content">Loading...</pre>
    </div>
</section>

<style>
/* Status Grid */
.ouro-status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}
.ouro-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 18px 20px;
    background: var(--bg-secondary);
    border-radius: 12px;
    border: 1px solid var(--border-color, rgba(255,255,255,0.06));
}
.ouro-card-icon {
    width: 44px; height: 44px;
    display: flex; align-items: center; justify-content: center;
    border-radius: 10px;
    background: rgba(239, 68, 68, 0.15);
    color: #ef4444;
    flex-shrink: 0;
}
.ouro-card-icon.running {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
}
.ouro-card-icon.running .material-symbols-outlined {
    animation: spin 2s linear infinite;
}
.ouro-card-icon.neutral {
    background: rgba(99, 102, 241, 0.15);
    color: #818cf8;
}
.ouro-card-icon.connected {
    background: rgba(34, 197, 94, 0.15);
    color: #22c55e;
}
.ouro-card-label {
    font-size: 12px;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.ouro-card-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin-top: 2px;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Issues */
.ouro-count-badge {
    display: inline-block;
    min-width: 22px;
    height: 22px;
    line-height: 22px;
    text-align: center;
    font-size: 12px;
    font-weight: 700;
    border-radius: 11px;
    background: var(--accent, #818cf8);
    color: #fff;
    padding: 0 7px;
    vertical-align: middle;
}
.ouro-count-badge:empty { display: none; }
.ouro-issues-list { display: flex; flex-direction: column; gap: 8px; }
.ouro-issue-card {
    padding: 14px 18px;
    background: var(--bg-secondary);
    border-radius: 10px;
    border-left: 4px solid #818cf8;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 12px;
}
.ouro-issue-title {
    font-weight: 600;
    color: var(--text-primary);
}
.ouro-issue-title a {
    color: inherit;
    text-decoration: none;
}
.ouro-issue-title a:hover { text-decoration: underline; }
.ouro-issue-meta {
    font-size: 12px;
    color: var(--text-tertiary);
    margin-top: 4px;
}
.ouro-issue-number {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 600;
    white-space: nowrap;
}
.ouro-issue-labels { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
.ouro-label {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 12px;
    background: rgba(129, 140, 248, 0.15);
    color: #818cf8;
    font-weight: 500;
}

/* Activity */
.ouro-activity-list { display: flex; flex-direction: column; gap: 4px; }
.ouro-activity-item {
    padding: 8px 14px;
    font-size: 13px;
    display: flex;
    gap: 10px;
    align-items: flex-start;
    border-radius: 6px;
}
.ouro-activity-item:hover { background: var(--bg-secondary); }
.ouro-activity-ts {
    color: var(--text-tertiary);
    font-size: 11px;
    white-space: nowrap;
    min-width: 140px;
    font-family: monospace;
}
.ouro-activity-level {
    font-size: 11px;
    font-weight: 700;
    min-width: 50px;
    text-align: center;
    padding: 1px 6px;
    border-radius: 4px;
}
.ouro-activity-level.INFO { color: #22c55e; background: rgba(34,197,94,0.1); }
.ouro-activity-level.ERROR { color: #ef4444; background: rgba(239,68,68,0.1); }
.ouro-activity-level.WARNING { color: #f59e0b; background: rgba(245,158,11,0.1); }
.ouro-activity-level.DEBUG { color: #6b7280; background: rgba(107,114,128,0.1); }
.ouro-activity-msg { color: var(--text-primary); word-break: break-word; }

/* Log Panel */
.ouro-log-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    user-select: none;
}
.ouro-log-header h2 { margin: 0; }
.ouro-log-header .material-symbols-outlined {
    transition: transform 0.2s;
    color: var(--text-secondary);
}
.ouro-log-panel {
    overflow: hidden;
    transition: max-height 0.3s ease;
    max-height: 600px;
}
.ouro-log-panel.collapsed { max-height: 0; }
.ouro-log-toolbar {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 10px;
    padding-top: 12px;
}
.ouro-log-toolbar select {
    background: var(--bg-secondary);
    color: var(--text-primary);
    border: 1px solid var(--border-color, rgba(255,255,255,0.1));
    border-radius: 6px;
    padding: 4px 8px;
    font-size: 13px;
}
.btn-sm { padding: 4px 10px; font-size: 13px; }
.ouro-log-content {
    background: var(--bg-tertiary, #0d0d0d);
    color: #a1a1aa;
    padding: 14px;
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.6;
    max-height: 400px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-all;
    margin: 0;
}

/* Health Feedback Grid */
.ouro-health-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 16px;
}
.ouro-health-score-card {
    grid-column: span 1;
}
.ouro-health-ring-wrap {
    width: 64px; height: 64px; flex-shrink: 0;
}
.ouro-health-ring { width: 100%; height: 100%; }
.ouro-health-ring circle { transition: stroke-dashoffset 0.8s ease, stroke 0.3s ease; }

/* Fix History Table */
.ouro-fixes-list { display: flex; flex-direction: column; gap: 6px; }
.ouro-fix-row {
    display: grid;
    grid-template-columns: 70px 1fr 140px 90px;
    gap: 12px;
    align-items: center;
    padding: 10px 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
    font-size: 13px;
}
.ouro-fix-row .ouro-fix-issue {
    font-weight: 700;
    color: var(--text-primary);
}
.ouro-fix-row .ouro-fix-summary {
    color: var(--text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.ouro-fix-row .ouro-fix-time {
    color: var(--text-tertiary);
    font-size: 11px;
    text-align: right;
}
.ouro-fix-badge {
    display: inline-block;
    font-size: 11px;
    font-weight: 700;
    padding: 2px 10px;
    border-radius: 12px;
    text-align: center;
    text-transform: capitalize;
}
.ouro-fix-badge.verified { background: rgba(34,197,94,0.15); color: #22c55e; }
.ouro-fix-badge.pending { background: rgba(245,158,11,0.15); color: #f59e0b; }
.ouro-fix-badge.regressed { background: rgba(239,68,68,0.15); color: #ef4444; }

.empty-state { text-align: center; padding: 24px; color: var(--text-tertiary); }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadRefinerStatus();
    loadGithubIssues();
    loadAdbStatus();
    loadHealthFeedback();
    loadFixVerifications();

    // Auto-refresh
    setInterval(loadRefinerStatus, 15000);
    setInterval(loadGithubIssues, 60000);
    setInterval(loadAdbStatus, 15000);
    setInterval(loadHealthFeedback, 30000);
    setInterval(loadFixVerifications, 30000);
});

async function loadRefinerStatus() {
    try {
        const resp = await fetch('/api/ouroboros/refiner/status');
        const data = await resp.json();

        // Refiner state
        const icon = document.getElementById('refiner-icon');
        const stateEl = document.getElementById('refiner-state');
        if (data.alive) {
            stateEl.textContent = 'Running';
            stateEl.style.color = '#22c55e';
            icon.className = 'ouro-card-icon running';
        } else {
            stateEl.textContent = 'Stopped';
            stateEl.style.color = '#ef4444';
            icon.className = 'ouro-card-icon';
        }

        // Last run
        const lastRunEl = document.getElementById('last-run');
        if (data.last_run) {
            const d = new Date(data.last_run);
            lastRunEl.textContent = formatRelativeTime(d);
            lastRunEl.title = d.toLocaleString();
        } else {
            lastRunEl.textContent = 'Never';
        }

        // Processed count
        document.getElementById('processed-count').textContent = data.processed_count || 0;

        // Recent activity
        renderActivity(data.recent_activity || []);
    } catch (e) {
        console.error('Failed to load refiner status:', e);
    }
}

function renderActivity(items) {
    const container = document.getElementById('activity-container');
    if (!items.length) {
        container.innerHTML = '<div class="empty-state">No recent activity</div>';
        return;
    }
    container.innerHTML = items.map(a => `
        <div class="ouro-activity-item">
            <span class="ouro-activity-ts">${escapeHtml(a.timestamp || '')}</span>
            <span class="ouro-activity-level ${a.level || 'INFO'}">${a.level || 'INFO'}</span>
            <span class="ouro-activity-msg">${escapeHtml(a.message || '')}</span>
        </div>
    `).join('');
}

async function loadGithubIssues() {
    try {
        const resp = await fetch('/api/ouroboros/github/issues');
        const data = await resp.json();
        const container = document.getElementById('issues-container');
        const badge = document.getElementById('issues-badge');

        badge.textContent = data.count || '';

        if (!data.issues || data.issues.length === 0) {
            container.innerHTML = '<div class="empty-state">No open ouroboros issues</div>';
            return;
        }

        container.innerHTML = data.issues.map(issue => `
            <div class="ouro-issue-card">
                <div>
                    <div class="ouro-issue-title">
                        <a href="${escapeHtml(issue.html_url)}" target="_blank" rel="noopener">${escapeHtml(issue.title)}</a>
                    </div>
                    <div class="ouro-issue-meta">
                        Opened ${formatRelativeTime(new Date(issue.created_at))}
                        ${issue.comments > 0 ? ' \u00b7 ' + issue.comments + ' comment' + (issue.comments !== 1 ? 's' : '') : ''}
                    </div>
                    <div class="ouro-issue-labels">
                        ${(issue.labels || []).map(l => '<span class="ouro-label">' + escapeHtml(l) + '</span>').join('')}
                    </div>
                </div>
                <span class="ouro-issue-number">#${issue.number}</span>
            </div>
        `).join('');
    } catch (e) {
        console.error('Failed to load GitHub issues:', e);
        document.getElementById('issues-container').innerHTML =
            '<div class="empty-state">Failed to load issues</div>';
    }
}

async function loadAdbStatus() {
    try {
        const resp = await fetch('/api/ouroboros/adb/status');
        const data = await resp.json();

        const icon = document.getElementById('adb-icon');
        const stateEl = document.getElementById('adb-state');

        if (data.connected) {
            stateEl.textContent = data.count + ' device' + (data.count !== 1 ? 's' : '');
            stateEl.style.color = '#22c55e';
            icon.className = 'ouro-card-icon connected';
        } else {
            stateEl.textContent = 'None';
            stateEl.style.color = '#ef4444';
            icon.className = 'ouro-card-icon';
        }
    } catch (e) {
        console.error('Failed to load ADB status:', e);
    }
}

// Log panel
let logExpanded = false;
function toggleLogPanel() {
    logExpanded = !logExpanded;
    const panel = document.getElementById('log-panel');
    const icon = document.getElementById('log-toggle-icon');
    if (logExpanded) {
        panel.classList.remove('collapsed');
        icon.style.transform = 'rotate(180deg)';
        refreshLog();
    } else {
        panel.classList.add('collapsed');
        icon.style.transform = '';
    }
}

async function refreshLog() {
    const n = document.getElementById('log-lines-select').value;
    try {
        const resp = await fetch('/api/ouroboros/refiner/log?lines=' + n);
        const data = await resp.json();
        const el = document.getElementById('log-content');
        if (data.lines && data.lines.length) {
            el.textContent = data.lines.join('\n');
            el.scrollTop = el.scrollHeight;
        } else {
            el.textContent = data.error || 'No log data';
        }
    } catch (e) {
        document.getElementById('log-content').textContent = 'Failed to load log';
    }
}

async function loadHealthFeedback() {
    try {
        const resp = await fetch('/api/ouroboros/health-context');
        const data = await resp.json();

        // Health score ring
        const score = data.health_score;
        const ringFg = document.getElementById('health-ring-fg');
        const ringText = document.getElementById('health-ring-text');
        const statusText = document.getElementById('health-status-text');

        if (score && score.overall != null) {
            const pct = Math.max(0, Math.min(100, score.overall));
            const circumference = 213.6;
            ringFg.setAttribute('stroke-dashoffset', circumference - (circumference * pct / 100));

            // Color based on status
            const color = score.status === 'healthy' ? '#22c55e' :
                          score.status === 'degraded' ? '#f59e0b' : '#ef4444';
            ringFg.setAttribute('stroke', color);
            ringText.textContent = Math.round(pct);
            statusText.textContent = score.status.charAt(0).toUpperCase() + score.status.slice(1);
            statusText.style.color = color;
        } else {
            ringText.textContent = '--';
            statusText.textContent = 'N/A';
        }

        // Active alerts count
        const alertsEl = document.getElementById('health-alerts-count');
        alertsEl.textContent = (data.trend_alerts || []).length;
    } catch (e) {
        console.error('Failed to load health feedback:', e);
    }
}

async function loadFixVerifications() {
    try {
        const resp = await fetch('/api/ouroboros/fix-verifications');
        const data = await resp.json();
        const summary = data.summary || {};

        document.getElementById('fix-verified-count').textContent = summary.verified || 0;
        document.getElementById('fix-pending-count').textContent = summary.pending || 0;
        document.getElementById('fix-regressed-count').textContent = summary.regressed || 0;

        const badge = document.getElementById('fixes-badge');
        badge.textContent = summary.total || '';

        const container = document.getElementById('fixes-container');
        const fixes = data.fixes || [];

        if (!fixes.length) {
            container.innerHTML = '<div class="empty-state">No deployed fixes recorded</div>';
            return;
        }

        container.innerHTML = fixes.map(f => `
            <div class="ouro-fix-row">
                <span class="ouro-fix-issue">#${f.issue_number}</span>
                <span class="ouro-fix-summary" title="${escapeHtml(f.fix_summary || '')}">${escapeHtml(f.fix_summary || 'No summary')}</span>
                <span class="ouro-fix-time">${f.deployed_at ? formatRelativeTime(new Date(f.deployed_at)) : '--'}</span>
                <span class="ouro-fix-badge ${f.verification_status || 'pending'}">${f.verification_status || 'pending'}</span>
            </div>
        `).join('');
    } catch (e) {
        console.error('Failed to load fix verifications:', e);
        document.getElementById('fixes-container').innerHTML =
            '<div class="empty-state">Failed to load fix history</div>';
    }
}

// Helpers
function formatRelativeTime(date) {
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);
    if (diff < 60) return diff + 's ago';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    return Math.floor(diff / 86400) + 'd ago';
}

function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}
</script>
{% endblock %}
